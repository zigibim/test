<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Aluguéis - Painel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .tab-button .notification-badge {
            display: none;
        }
        .tab-button.has-notifications .notification-badge {
            display: inline-flex;
        }
        /* Hide scrollbar for tabs navigation */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }



        
        /* Bottom Nav Active State */
        .bottom-nav-btn.active-tab {
            color: #22d3ee; /* cyan-400 */
        }

        .settings-tab-button.active-settings-tab {
            background-color: #374151;
            color: #e5e7eb;
        }
        
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">

    <div id="app" class="max-w-7xl mx-auto p-2 sm:p-6 lg:p-8 pb-24 md:pb-8">
        
        <!-- Cabeçalho -->
        <header class="flex justify-between items-center mb-6">
            <h1 id="app-title" class="text-2xl sm:text-3xl font-bold text-cyan-400">Meu Gestor de Aluguéis</h1>
            <div class="flex items-center space-x-2">
                <button id="settingsBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-lg flex items-center transition-colors" title="Configurações">
                    <i data-lucide="settings" class="h-5 w-5"></i>
                </button>
                <button id="logoutBtn" class="bg-red-800 hover:bg-red-700 text-white font-bold p-2 rounded-lg flex items-center transition-colors" title="Sair">
                    <i data-lucide="log-out" class="h-5 w-5"></i>
                </button>
            </div>
        </header>

        <!-- Navegação Principal (Desktop) -->
        <div class="mb-6 hidden md:block">
            <div class="border-b border-gray-700">
                <nav id="top-nav" class="-mb-px flex space-x-6 overflow-x-auto no-scrollbar" aria-label="Tabs">
                    <button class="tab-button active-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-cyan-500 text-cyan-400" data-tab="dashboard"><span>Painel</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="items"><span>Meus Itens</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="rentals"><span>Meus Aluguéis</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="finance"><span>Financeiro</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 relative" data-tab="notifications">
                        <span>Notificações</span>
                        <span id="top-nav-badge" class="notification-badge absolute top-3 -right-4 ml-2 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                    </button>
                    <button id="gestores-main-tab" class="tab-button hidden whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="gestores"><span>Gestores</span></button>
                </nav>
            </div>
        </div>

        <!-- Conteúdo das Abas -->
        <main>
            <!-- Aba Painel -->
            <div id="dashboard-content" class="tab-content">
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-8">
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex flex-col text-center sm:flex-row sm:items-center sm:text-left gap-4">
                        <i data-lucide="package" class="h-8 w-8 text-cyan-400 mb-2 sm:mb-0 self-center"></i>
                        <div>
                            <h3 id="total-items-title" class="text-sm font-medium text-gray-400">Total de Itens</h3>
                            <p id="total-items" class="mt-1 text-xl sm:text-3xl font-semibold">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex flex-col text-center sm:flex-row sm:items-center sm:text-left gap-4">
                         <i data-lucide="package-x" class="h-8 w-8 text-cyan-400 mb-2 sm:mb-0 self-center"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-400">Alugados</h3>
                            <p id="rented-items" class="mt-1 text-xl sm:text-3xl font-semibold">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex flex-col text-center sm:flex-row sm:items-center sm:text-left gap-4">
                        <i data-lucide="package-check" class="h-8 w-8 text-cyan-400 mb-2 sm:mb-0 self-center"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-400">Disponíveis</h3>
                            <p id="available-items" class="mt-1 text-xl sm:text-3xl font-semibold">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex flex-col text-center sm:flex-row sm:items-center sm:text-left gap-4">
                        <i data-lucide="wallet" class="h-8 w-8 text-green-400 mb-2 sm:mb-0 self-center"></i>
                        <div>
                            <h3 id="month-balance-title" class="text-sm font-medium text-gray-400">Saldo do Mês</h3>
                            <p id="month-balance" class="mt-1 text-xl sm:text-3xl font-semibold">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex flex-col text-center sm:flex-row sm:items-center sm:text-left gap-4">
                        <i data-lucide="arrow-down-circle" class="h-8 w-8 text-red-400 mb-2 sm:mb-0 self-center"></i>
                        <div>
                             <h3 id="month-expense-title" class="text-sm font-medium text-gray-400">Despesas</h3>
                            <p id="month-expense" class="mt-1 text-xl sm:text-3xl font-semibold text-red-400">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex flex-col text-center sm:flex-row sm:items-center sm:text-left gap-4">
                        <i data-lucide="percent" class="h-8 w-8 text-yellow-400 mb-2 sm:mb-0 self-center"></i>
                        <div>
                            <h3 id="month-fee-title" class="text-sm font-medium text-gray-400">Taxa Gerência</h3>
                            <p id="month-fee" class="mt-1 text-xl sm:text-3xl font-semibold text-yellow-400">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <!-- Gráfico Financeiro -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                         <h2 id="financial-overview-title" class="text-lg sm:text-xl font-semibold">Visão Geral Financeira</h2>
                         <div class="flex flex-wrap items-center gap-4 self-start md:self-center">
                            <div class="flex items-center gap-2">
                                <label for="chart-view" class="text-sm">Visualização:</label>
                                <select id="chart-view" class="bg-gray-700 border border-gray-600 rounded-md px-2 sm:px-3 py-1 text-sm">
                                    <option value="monthly">Mensal</option>
                                    <option value="yearly">Anual</option>
                                </select>
                            </div>
                            <div id="monthly-filters" class="flex items-center gap-2">
                                <label for="filterMonth" class="text-sm">Mês:</label>
                                <select id="filterMonth" class="bg-gray-700 border border-gray-600 rounded-md px-2 sm:px-3 py-1 text-sm"></select>
                                <label for="filterYear" class="text-sm">Ano:</label>
                                <select id="filterYear" class="bg-gray-700 border border-gray-600 rounded-md px-2 sm:px-3 py-1 text-sm"></select>
                            </div>
                       </div>
                    </div>
                    <div class="h-[300px] sm:h-[350px]">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Aba Meus Itens -->
            <div id="items-content" class="tab-content hidden">
                <div class="mb-6 text-right">
                    <button id="openAddItemModal" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105 inline-flex">
                        <i data-lucide="plus-circle" class="h-5 w-5 mr-2"></i>
                        <span>Adicionar Item</span>
                   </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="package-check" class="mr-3 text-green-400"></i>Disponíveis para Alugar</h2>
                        <div id="available-list" class="space-y-4">
                            <!-- Itens disponíveis aqui -->
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="package-x" class="mr-3 text-red-400"></i>Atualmente Alugados</h2>
                        <div id="rented-list" class="space-y-4">
                            <!-- Itens alugados aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Meus Aluguéis -->
            <div id="rentals-content" class="tab-content hidden">
                <h2 id="rentals-title" class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="calendar-clock" class="mr-3 text-cyan-400"></i>Aluguéis Ativos</h2>
                <div id="sorted-rentals-list" class="space-y-4">
                    <!-- Sorted rented items will be inserted here -->
                </div>
            </div>

            <!-- Aba Financeiro -->
            <div id="finance-content" class="tab-content hidden">
                 <div class="flex flex-wrap gap-4 mb-6">
                     <button id="openAddTransactionModalRevenue" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                         <i data-lucide="trending-up" class="mr-2 h-5 w-5"></i>
                         <span>Adicionar Receita</span>
                     </button>
                     <button id="openAddTransactionModalExpense" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                         <i data-lucide="trending-down" class="mr-2 h-5 w-5"></i>
                         <span>Adicionar Despesa</span>
                     </button>
                     <button id="openTaxReportModal" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                         <i data-lucide="file-text" class="mr-2 h-5 w-5"></i>
                         <span>Planilha de Imposto de Renda</span>
                     </button>
                 </div>

                 <!-- Filtros de Transações -->
                 <div class="bg-gray-800 p-4 rounded-xl mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold">Filtrar Transações</h3>
                        <button id="clearFiltersBtn" title="Limpar Filtros" class="bg-gray-600 hover:bg-gray-500 text-white font-bold p-2 rounded-md text-sm">
                            <i data-lucide="rotate-ccw" class="h-5 w-5"></i>
                        </button>    
                    </div>
                    <div class="space-y-4">
    <!-- Seção de Busca por Texto -->
    <div>
        <div class="flex flex-wrap items-center gap-x-6 gap-y-3 mb-3">
            <label class="block text-sm font-medium text-gray-300 shrink-0">Buscar por:</label>
            <div class="flex items-center">
                <input id="filterByNameToggle" type="checkbox" data-target="filterByName" class="filter-toggle h-4 w-4 rounded border-gray-600 bg-gray-700 text-cyan-600 focus:ring-cyan-500">
                <label for="filterByNameToggle" class="ml-2 text-sm text-gray-300">Nome do Inquilino</label>
            </div>
            <div class="flex items-center">
                <input id="filterByItemToggle" type="checkbox" data-target="filterByItem" class="filter-toggle h-4 w-4 rounded border-gray-600 bg-gray-700 text-cyan-600 focus:ring-cyan-500">
                <label for="filterByItemToggle" class="ml-2 text-sm text-gray-300">Item/Endereço</label>
            </div>
            <div class="flex items-center">
                <input id="filterByDescriptionToggle" type="checkbox" data-target="filterByDescription" class="filter-toggle h-4 w-4 rounded border-gray-600 bg-gray-700 text-cyan-600 focus:ring-cyan-500">
                <label for="filterByDescriptionToggle" class="ml-2 text-sm text-gray-300">Descrição Genérica</label>
            </div>
        </div>
        <div class="space-y-3">
            <input type="text" id="filterByName" placeholder="Digite o nome do inquilino..." class="filter-input hidden w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
            <input type="text" id="filterByItem" placeholder="Digite o nome do item ou endereço..." class="filter-input hidden w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
            <input type="text" id="filterByDescription" placeholder="Digite a descrição da transação..." class="filter-input hidden w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
        </div>
    </div>
    <!-- Seção de Outros Filtros -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t border-gray-700 items-end">
        <div>
            <label for="filterType" class="block text-sm font-medium mb-1">Tipo de Transação</label>
            <select id="filterType" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
                <option value="all">Todos</option>
                <option value="revenue">Receita</option>
                <option value="expense">Despesa</option>
                <option value="management_fee">Taxa de Gerência</option>
            </select>
        </div>
         <div class="flex items-end space-x-2 sm:flex-grow-0">
            <div class="flex-grow">
                <label for="filterStartDate" class="block text-sm font-medium mb-1">A partir de</label>
                <input type="date" id="filterStartDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
            </div>
           
        </div>
    </div>
</div>
                 </div>

                 <h2 class="text-xl sm:text-2xl font-semibold mb-4">Histórico de Transações</h2>
                <div id="transactions-list" class="space-y-4 md:space-y-0">
            <!-- As transações serão geradas pelo JavaScript aqui -->
                </div>
            </div>

            <!-- Aba Notificações -->
            <div id="notifications-content" class="tab-content hidden">
                <div id="alerts-section">
                     <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="bell-ring" class="mr-3 text-yellow-400"></i>Alertas Pendentes</h2>
                     <div id="alerts-container" class="space-y-4">
                         <!-- Alertas serão inseridos aqui -->
                     </div>
                </div>
            </div>

            <!-- Aba Gestores (Admin view) -->
            <div id="gestores-content" class="tab-content hidden">
                 <h2 class="text-xl sm:text-2xl font-semibold mb-4">Painel de Gestores</h2>
                 <div id="admin-managers-dashboard" class="space-y-6">
                     <!-- Cards de resumo dos gestores serão inseridos aqui -->
                 </div>
            </div>
        </main>
    </div>

    <!-- Navegação Inferior (Mobile) -->
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around p-2 z-40 overflow-x-auto no-scrollbar">
        <button class="tab-button bottom-nav-btn active-tab flex flex-col items-center text-gray-400 p-2" data-tab="dashboard">
            <i data-lucide="layout-dashboard" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Painel</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2" data-tab="items">
            <i data-lucide="archive" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Itens</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2" data-tab="rentals">
            <i data-lucide="calendar-clock" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Aluguéis</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2" data-tab="finance">
            <i data-lucide="piggy-bank" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Financeiro</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2 relative" data-tab="notifications">
            <i data-lucide="bell" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Notificações</span>
            <span id="bottom-nav-badge" class="notification-badge absolute top-1 right-3 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
        </button>
         <button id="gestores-bottom-tab" class="tab-button bottom-nav-btn hidden flex-col items-center text-gray-400 p-2" data-tab="gestores">
            <i data-lucide="users" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Gestores</span>
        </button>
    </nav>


    <!-- Modal Adicionar Item -->
    <div id="addItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="addItemForm">
                <h2 class="text-2xl font-bold mb-4">Adicionar Novo Item</h2>
                <div class="space-y-4">
                    <div>
                        <label for="itemName" class="block mb-1 font-medium">Nome do Item/Serviço <span class="text-red-500 hidden">*</span></label>
                        <input type="text" id="itemName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                    </div>
                    <div>
                        <label for="itemDescription" class="block mb-1 font-medium">Descrição</label>
                        <textarea id="itemDescription" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Ex: Apartamento de 2 quartos, carro ano 2020..."></textarea>
                    </div>
                    <div>
                        <label for="itemCategorySelect" class="block mb-1 font-medium">Categoria</label>
                        <select id="itemCategorySelect" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <option value="" disabled selected>Selecione uma categoria...</option>
                            <option value="Imóvel">Imóvel</option>
                            <option value="Veículo">Veículo</option>
                            <option value="Equipamento">Equipamento</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div id="itemCategoryOtherWrapper" class="hidden">
                        <label for="itemCategoryOther" class="block mb-1 font-medium">Qual categoria?</label>
                        <input type="text" id="itemCategoryOther" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                    </div>
                    <div id="imovelFieldsWrapper" class="hidden space-y-4 border-t border-gray-700 pt-4 mt-4">
                        <div>
                            <label for="itemEndereco" class="block mb-1 font-medium">Endereço <span class="text-red-500 hidden">*</span></label>
                            <input type="text" id="itemEndereco" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                        </div>
                        <div>
                            <label for="itemCep" class="block mb-1 font-medium">CEP (Opcional)</label>
                            <input type="text" id="itemCep" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="itemManagedBy" class="block mb-1 font-medium">Gerido por: (Opcional)</label>
                            <select id="itemManagedBy" class="itemManagedBySelect w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                                <option value="particular" selected>Particular</option>
                                <option value="imobiliaria">Imobiliária</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="itemManagerNameWrapper hidden">
                            <label for="itemManagerName" class="block mb-1 font-medium">Nome da Imobiliária/Outro</label>
                            <input type="text" id="itemManagerName" class="itemManagerNameInput w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div class="itemFeeWrapper hidden space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="itemHasManagementFee" class="h-5 w-5 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600">
                                <span>Incluir taxa de gerência automática?</span>
                            </label>
                            <div class="itemFeePercentageWrapper hidden">
                                <label for="itemManagementFeePercentage" class="block mb-1 font-medium">Taxa (%)</label>
                                <input type="number" id="itemManagementFeePercentage" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" value="10">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="itemValue" class="block mb-1 font-medium">Valor Padrão do Aluguel (R$)</label>
                        <input type="number" step="0.01" id="itemValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="itemPaymentFrequency" class="block mb-1 font-medium">Frequência de Recebimento</label>
                        <select id="itemPaymentFrequency" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                            <option value="monthly">Mensal</option>
                            <option value="weekly">Semanal</option>
                            <option value="daily">Diário</option>
                            <option value="single">Pagamento Único</option>
                        </select>
                    </div>
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="itemIncludeInTaxReport" class="h-5 w-5 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600" checked>
                            <span class="text-sm">Incluir na planilha de Imposto de Renda?</span>
                        </label>
                    </div>
                </div>
                <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Editar Item -->
    <div id="editItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="editItemForm">
                <h2 class="text-2xl font-bold mb-4">Editar Item</h2>
                <input type="hidden" id="editItemId">
                <div class="space-y-4">
                    <div>
                        <label for="editItemName" class="block mb-1 font-medium">Nome do Item/Serviço <span class="text-red-500 hidden">*</span></label>
                        <input type="text" id="editItemName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                    </div>
                    <div>
                        <label for="editItemDescription" class="block mb-1 font-medium">Descrição</label>
                        <textarea id="editItemDescription" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></textarea>
                    </div>
                    <div>
                        <label for="editItemCategorySelect" class="block mb-1 font-medium">Categoria</label>
                        <select id="editItemCategorySelect" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <option value="" disabled>Selecione uma categoria...</option>
                            <option value="Imóvel">Imóvel</option>
                            <option value="Veículo">Veículo</option>
                            <option value="Equipamento">Equipamento</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div id="editItemCategoryOtherWrapper" class="hidden">
                        <label for="editItemCategoryOther" class="block mb-1 font-medium">Qual categoria?</label>
                        <input type="text" id="editItemCategoryOther" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                    </div>
                    <div id="editImovelFieldsWrapper" class="hidden space-y-4 border-t border-gray-700 pt-4 mt-4">
                        <div>
                            <label for="editItemEndereco" class="block mb-1 font-medium">Endereço (Opcional) <span class="text-red-500 hidden">*</span></label>
                            <input type="text" id="editItemEndereco" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                        </div>
                        <div>
                            <label for="editItemCep" class="block mb-1 font-medium">CEP (Opcional)</label>
                            <input type="text" id="editItemCep" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="editItemManagedBy" class="block mb-1 font-medium">Gerido por: (Opcional)</label>
                            <select id="editItemManagedBy" class="itemManagedBySelect w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                                <option value="particular">Particular</option>
                                <option value="imobiliaria">Imobiliária</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="itemManagerNameWrapper hidden">
                            <label for="editItemManagerName" class="block mb-1 font-medium">Nome da Imobiliária/Outro</label>
                            <input type="text" id="editItemManagerName" class="itemManagerNameInput w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                         <div class="itemFeeWrapper hidden space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="editItemHasManagementFee" class="h-5 w-5 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600">
                                <span>Incluir taxa de gerência automática?</span>
                            </label>
                            <div class="itemFeePercentageWrapper hidden">
                                <label for="editItemManagementFeePercentage" class="block mb-1 font-medium">Taxa (%)</label>
                                <input type="number" id="editItemManagementFeePercentage" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" value="10">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="editItemValue" class="block mb-1 font-medium">Valor Padrão do Aluguel (R$)</label>
                        <input type="number" step="0.01" id="editItemValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editItemPaymentFrequency" class="block mb-1 font-medium">Frequência de Recebimento</label>
                        <select id="editItemPaymentFrequency" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                            <option value="monthly">Mensal</option>
                            <option value="weekly">Semanal</option>
                            <option value="daily">Diário</option>
                            <option value="single">Pagamento Único</option>
                        </select>
                    </div>
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="editItemIncludeInTaxReport" class="h-5 w-5 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600">
                            <span class="text-sm">Incluir na planilha de Imposto de Renda?</span>
                        </label>
                    </div>
                </div>
                <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Alugar Item -->
    <div id="rentItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
         <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="rentItemForm">
                <h2 id="rentModalTitle" class="text-2xl font-bold mb-4">Registrar Aluguel</h2>
                <input type="hidden" id="rentItemId">
                <div class="space-y-4">
                    <div>
                        <label for="tenantName" class="block mb-1 font-medium">Nome do Inquilino/Cliente</label>
                        <input type="text" id="tenantName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="tenantPhone" class="block mb-1 font-medium">Telefone (Opcional)</label>
                            <input type="tel" id="tenantPhone" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="tenantCPF" class="block mb-1 font-medium">CPF (Opcional)</label>
                            <input type="text" id="tenantCPF" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                    </div>
                    <div>
                        <label for="rentStartDate" class="block mb-1 font-medium">Data de Início</label>
                        <input type="date" id="rentStartDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="rentEndDate" class="block mb-1 font-medium">Data de Término</label>
                        <div class="flex items-center space-x-2">
                            <input type="date" id="rentEndDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <button type="button" id="setOneYearBtn" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-sm whitespace-nowrap">1 Ano</button>
                        </div>
                    </div>
                     <div>
                        <label for="rentValue" class="block mb-1 font-medium">Valor Combinado (R$)</label>
                        <input type="number" step="0.01" id="rentValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="paymentDay" class="block mb-1 font-medium">Dia do Pagamento Mensal</label>
                        <input type="number" id="paymentDay" min="1" max="31" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Ex: 5" required>
                    </div>
                </div>
                <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Confirmar Aluguel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Adicionar Transação -->
    <div id="addTransactionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="addTransactionForm">
                <h2 id="transactionModalTitle" class="text-2xl font-bold mb-4">Adicionar Transação</h2>
                <input type="hidden" id="transactionType">
                <input type="hidden" id="isDirectIptuPayment" value="false">
                <div class="space-y-4">
    <div>
        <label for="transactionItemLink" class="block mb-1 font-medium">Associar a um Item</label>
        <select id="transactionItemLink" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
            <!-- Options will be populated by JS -->
        </select>
    </div>
    <div>
        <label for="transactionDescription" class="block mb-1 font-medium">Descrição</label>
        <textarea id="transactionDescription" rows="1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 resize-none overflow-hidden" required></textarea>
</div> <div id="autoIptuContainer" class="hidden space-y-2 mb-4">
        <label class="flex items-center space-x-3 cursor-pointer p-3 bg-gray-900 rounded-md hover:bg-gray-700">
            <input type="checkbox" id="autoIptuCheckbox" class="h-5 w-5 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600">
            <span id="autoIptuLabel" class="text-sm font-medium text-cyan-300"></span>
        </label>
    </div>
    <div> <div class="flex justify-between items-baseline mb-1">  <label for="transactionAmount" class="font-medium">Valor (R$)</label>
            <span id="debtAmountDisplay" class="hidden text-sm font-semibold text-red-400"></span>
        </div>
        <input type="number" step="0.01" id="transactionAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
        </div> <div id="debtInfoContainer" class="hidden bg-gray-900/50 p-3 rounded-md space-y-2">
        <label class="block text-sm font-medium text-yellow-400">Dívida Pendente</label>
    <div class="flex items-center justify-between">
        <span id="debtAmountText" class="text-lg font-semibold text-red-400"></span>
        <button type="button" id="forgiveDebtBtn" title="Perdoar Dívida" class="text-gray-400 hover:text-red-500 p-1 rounded-full">
            <i data-lucide="trash-2" class="h-5 w-5"></i>
        </button>
    </div>
</div>
    <div>
        <label for="transactionDate" class="block mb-1 font-medium">Data</label>
        <input type="date" id="transactionDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
    </div>
    <div id="managementFeeContainer" class="border-t border-gray-700 pt-4 mt-4">
        <label class="flex items-center space-x-3 cursor-pointer">
            <input type="checkbox" id="addManagementFee" class="h-5 w-5 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600">
            <span>Incluir despesa de gerência (taxa)?</span>
        </label>
        <div id="managementFeeDiv" class="mt-3 hidden">
            <label for="managementFeeAmount" class="block mb-1 font-medium">Valor da Taxa de Gerência (R$)</label>
            <div class="flex items-center space-x-2">
                <input type="number" step="0.01" id="managementFeeAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                <button type="button" id="setTenPercentFeeBtn" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-sm whitespace-nowrap">10%</button>
            </div>
        </div>
    </div>
</div>


                <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Editar Transação -->
    <div id="editTransactionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <form id="editTransactionForm">
                <h2 class="text-2xl font-bold mb-4">Editar Transação</h2>
                <input type="hidden" id="editTransactionId">
                <div class="space-y-4">
                    <div>
                        <label for="editTransactionDescription" class="block mb-1 font-medium">Descrição</label>
                        <textarea id="editTransactionDescription" rows="1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 resize-none overflow-hidden" required></textarea>
                    </div>
                    <div>
                        <label for="editTransactionAmount" class="block mb-1 font-medium">Valor (R$)</label>
                        <input type="number" step="0.01" id="editTransactionAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editTransactionDate" class="block mb-1 font-medium">Data</label>
                        <input type="date" id="editTransactionDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                </div>
                <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lembrete de Pagamento Mensal -->
    <div id="paymentAlertModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6">
             <h2 class="text-2xl font-bold mb-2">Lembrete de Pagamento</h2>
             <p class="mb-4 text-gray-300">Item: <strong id="paymentAlertItemName" class="text-white"></strong></p>
             <input type="hidden" id="paymentAlertItemId">
             <div class="bg-gray-700 p-4 rounded-md">
                 <p class="mb-3">O pagamento mensal deste item já venceu. O que você gostaria de fazer?</p>
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                     <button id="paymentReceivedBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Recebido</button>
                     <button id="snoozePaymentBtn" class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded-md">Adiar 7 Dias</button>
                     <button id="setPaymentPendingBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Deixar Pendente</button>
                     <button id="forgetReminderBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">Esquecer</button>
                 </div>
             </div>
             <div class="mt-6 flex justify-end">
                 <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Fechar</button>
             </div>
        </div>
    </div>

    <!-- Modal Fim de Contrato -->
    <div id="contractEndModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-2">Fim de Contrato</h2>
            <p class="mb-4 text-gray-300">O contrato para o item <strong id="contractEndItemName" class="text-white"></strong> terminou.</p>
            <input type="hidden" id="contractEndItemId">
            <div class="bg-gray-700 p-4 rounded-md">
                <p class="mb-3">O que você gostaria de fazer a seguir?</p>
                <div class="flex flex-col sm:flex-row flex-wrap gap-3">
                    <button id="renewContractBtn" class="flex-1 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-md">Renovar Contrato</button>
                    <button id="setRenewalPendingBtn" class="flex-1 bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-md">Deixar Pendente</button>
                    <button id="endContractBtn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Finalizar Aluguel</button>
                </div>
            </div>
             <div class="mt-6 flex justify-end">
                 <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Fechar</button>
             </div>
        </div>
    </div>

    <!-- Modal Relatório de Imposto de Renda -->
    <div id="taxReportModal" class="modal fixed inset-0 bg-gray-900 z-50 p-0">
        <div class="bg-gray-800 w-full h-full p-4 sm:p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold">Relatório para Imposto de Renda</h2>
                    <button type="button" class="modal-close-btn p-2 rounded-full bg-gray-700 hover:bg-gray-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6 p-4 bg-gray-700 rounded-lg">
                    <label for="taxReportMonth" class="text-sm font-medium">Selecione o Período:</label>
                    <div class="flex items-center gap-2">
                        <select id="taxReportMonth" class="bg-gray-600 border border-gray-500 rounded-md px-3 py-1 text-sm"></select>
                        <select id="taxReportYear" class="bg-gray-600 border border-gray-500 rounded-md px-3 py-1 text-sm"></select>
                    </div>
                    <button id="generateTaxReportBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm">Gerar Relatório</button>
                </div>
                <div id="taxReportResult" class="bg-gray-900 p-4 rounded-md">
                    <p class="text-gray-400">Selecione um mês e ano e clique em "Gerar Relatório" para ver os recebimentos de aluguéis de imóveis.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Configurações -->
    <div id="settingsModal" class="modal fixed inset-0 bg-gray-900 z-50 p-0">
        <div class="bg-gray-800 w-full h-full p-4 sm:p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold">Configurações</h2>
                    <button type="button" class="modal-close-btn p-2 rounded-full bg-gray-700 hover:bg-gray-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <div class="border-b border-gray-700">
                        <nav class="-mb-px flex space-x-6" aria-label="Settings Tabs">
                            <button class="settings-tab-button active-settings-tab whitespace-nowrap py-3 px-4 rounded-t-md text-sm font-medium bg-gray-700 text-gray-100" data-tab="profile">Perfil</button>
                            <button class="settings-tab-button whitespace-nowrap py-3 px-4 rounded-t-md text-sm font-medium text-gray-400 hover:bg-gray-700/50" data-tab="managers">Gestores</button>
                            <button class="settings-tab-button whitespace-nowrap py-3 px-4 rounded-t-md text-sm font-medium text-gray-400 hover:bg-gray-700/50" data-tab="adjustments">Ajustes</button>
                        </nav>
                    </div>
                </div>

                <div>
                    <!-- Aba Perfil -->
                    <div id="profile-settings-content" class="settings-tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg">
                            <h3 class="text-xl font-semibold mb-4">Alterar Senha</h3>
                            <form id="changePasswordForm" class="space-y-4">
                                <div>
                                    <label for="currentPassword" class="block text-sm font-medium mb-1">Senha Atual</label>
                                    <input type="password" id="currentPassword" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                                </div>
                                <div>
                                    <label for="newPassword" class="block text-sm font-medium mb-1">Nova Senha</label>
                                    <input type="password" id="newPassword" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                                </div>
                                <div>
                                    <label for="confirmNewPassword" class="block text-sm font-medium mb-1">Confirmar Nova Senha</label>
                                    <input type="password" id="confirmNewPassword" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                                </div>
                                <div id="passwordChangeFeedback" class="text-sm pt-2"></div>
                                <div class="text-right">
                                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Salvar Alterações</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Aba Gestores -->
                    <div id="managers-settings-content" class="settings-tab-content hidden">
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold">Gerenciar Gestores</h3>
                                <button id="openAddManagerModal" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg flex items-center text-sm">
                                    <i data-lucide="plus" class="h-4 w-4 mr-2"></i> Adicionar Gestor
                                </button>
                            </div>
                            <div id="managers-list" class="space-y-4">
                                <!-- Lista de gestores será inserida aqui -->
                            </div>
                        </div>
                    </div>

                    </div> 
                <div id="adjustments-settings-content" class="settings-tab-content hidden">
     <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg space-y-6">
        
        <div>
            <h3 class="text-xl font-semibold mb-4">Notificações</h3>
            <div class="flex items-center justify-between">
                <span class="text-gray-300">Ativar alertas de pagamento e fim de contrato?</span>
                
                <label for="notificationsToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="notificationsToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                </label>
            </div>
        </div>
        <div class="border-t border-gray-700 pt-6">
            <h3 class="text-xl font-semibold mb-4">Navegação Mobile</h3>
            <div class="flex items-center justify-between">
                <span class="text-gray-300">Ocultar nomes (deixar só ícones) no menu inferior?</span>
                <label for="hideMobileNavLabelsToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="hideMobileNavLabelsToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                </label>
            </div>
        </div>
        <div class="border-t border-gray-700 pt-6">
            <h3 class="text-xl font-semibold mb-4">Proteção de Itens</h3>
            <div class="flex items-center justify-between">
                <span class="text-gray-300">Ativar aviso ao editar itens gerenciados?</span>
                <label for="managedItemWarningToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="managedItemWarningToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                </label>
            </div>
        </div>
        
        <div class="border-t border-gray-700 pt-6">      
            <h3 class="text-xl font-semibold mb-4">Imóveis</h3>
            <div class="flex items-center justify-between">
                <span class="text-gray-300">Exibir botão de gerenciamento de IPTU nos itens?</span>
                
                <label for="iptuButtonToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="iptuButtonToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                </label>
            </div>
            
        </div>
    </div>
</div>
                

            </div> </div>
    </div>
</div>
                </div>
            </div>
        </div>
    </div>

     <!-- Modal Adicionar/Editar Gestor -->
    <div id="managerModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 overflow-y-auto max-h-[90vh]">
            <form id="managerForm">
                <h2 id="managerModalTitle" class="text-2xl font-bold mb-6">Adicionar Novo Gestor</h2>
                <input type="hidden" id="managerId">
                <div class="space-y-4">
                    <div>
                        <label for="managerType" class="block mb-1 font-medium">Tipo de Gestor</label>
                        <select id="managerType" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <option value="Imobiliária">Imobiliária</option>
                            <option value="Agente">Agente</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div>
                        <label for="managerName" class="block mb-1 font-medium">Nome do Gestor</label>
                        <input type="text" id="managerName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="managerPassword" class="block mb-1 font-medium">Senha de Acesso</label>
                        <input type="text" id="managerPassword" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div class="border-t border-gray-700 pt-4">
                        <label class="block mb-2 font-medium">Selecionar itens para Administrar</label>
                        <div id="managerRentalsList" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                            <!-- Checkboxes dos aluguéis serão inseridos aqui -->
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    
    <!-- Modal Registrar IPTU -->
<div id="iptuModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
        <form id="iptuForm">
            <h2 id="iptuModalTitle" class="text-2xl font-bold mb-4">Registrar Pagamento de IPTU</h2>
            <input type="hidden" id="iptuItemId">
            <div class="space-y-4">
                <div>
                    <label for="iptuInstallmentValue" class="block mb-1 font-medium">Valor de Cada Parcela (R$)</label>
                    <input type="number" step="0.01" id="iptuInstallmentValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                </div>
                <div>
                    <label for="iptuInstallments" class="block mb-1 font-medium">Pagar em</label>
                    <select id="iptuInstallments" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        <option value="1">1 parcela (à vista)</option>
                        <option value="2">2 parcelas</option>
                        <option value="3">3 parcelas</option>
                        <option value="4">4 parcelas</option>
                        <option value="5">5 parcelas</option>
                        <option value="6">6 parcelas</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Registrar</button>
            </div>
        </form>
    </div>
</div>

<div id="manageIptuModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
        <form id="manageIptuForm">
            <h2 id="manageIptuModalTitle" class="text-2xl font-bold mb-4">Gerenciar IPTU</h2>
            <input type="hidden" id="manageIptuItemId">
            <input type="hidden" id="manageIptuYear">
            <div class="space-y-4">
                <div>
                    <label for="manageIptuInstallmentValue" class="block mb-1 font-medium">Valor de Cada Parcela (R$)</label>
                    <input type="number" step="0.01" id="manageIptuInstallmentValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                </div>
                <div>
                    <label for="manageIptuInstallments" class="block mb-1 font-medium">Pagar em</label>
                    <select id="manageIptuInstallments" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        <option value="1">1 parcela (à vista)</option>
                        <option value="2">2 parcelas</option>
                        <option value="3">3 parcelas</option>
                        <option value="4">4 parcelas</option>
                        <option value="5">5 parcelas</option>
                        <option value="6">6 parcelas</option>
                    </select>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Parcelas Pagas: <span id="manageIptuPaidInstallments" class="font-semibold text-white">0</span></p>
                    <p id="manageIptuWarning" class="text-xs text-yellow-400 mt-1 hidden">Atenção: Alterar o número de parcelas pode impactar o histórico de pagamentos.</p>
                </div>
            </div>
            <div class="mt-6 flex flex-col space-y-3 sm:space-y-0 sm:flex-row sm:justify-between">
                <button type="button" id="deleteIptuBtn" class="w-full sm:w-auto px-4 py-2 bg-red-700 hover:bg-red-600 rounded-md font-semibold text-sm">Apagar</button>
                <div class="flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Alterações</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="confirmActionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="confirmActionTitle" class="text-xl font-bold mb-4">Confirmar Ação</h2>
        <p id="confirmActionMessage" class="mb-6 text-gray-300">Você tem certeza?</p>
        <div class="flex flex-col-reverse sm:flex-row sm:justify-center sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
            <button id="confirmActionCancel" class="w-full sm:w-auto px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
            <button id="confirmActionConfirm" class="w-full sm:w-auto px-6 py-2 bg-red-600 hover:bg-red-500 rounded-md font-semibold">Confirmar</button>
        </div>
    </div>
</div>

    <!-- Modal de Ações da Dívida -->
<div id="debtActionsModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
    <div class="relative bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <button type="button" class="modal-close-btn absolute top-3 right-3 p-1 rounded-full bg-gray-700 hover:bg-gray-600">
            <i data-lucide="x" class="h-5 w-5"></i>
        </button>
        <h2 class="text-xl font-bold mb-2">Gerenciar Dívida</h2>
        <p id="debtActionsInfo" class="text-gray-400 mb-6"></p>
        <input type="hidden" id="debtActionsItemId">
        <div class="flex flex-col space-y-3">
            <button id="openEditDebtModalBtn" class="w-full px-6 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-md font-semibold">Alterar Valor da Dívida</button>
            <button id="deleteDebtBtn" class="w-full px-6 py-2 bg-red-600 hover:bg-red-500 rounded-md font-semibold">Apagar Dívida</button>
        </div>
    </div>
</div>

<!-- Modal Editar Dívida -->
<div id="editDebtModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6">
        <form id="editDebtForm">
            <h2 class="text-2xl font-bold mb-4">Alterar Dívida</h2>
            <input type="hidden" id="editDebtItemId">
            <div>
                <label for="newDebtAmount" class="block mb-1 font-medium">Novo Valor da Dívida (R$)</label>
                <input type="number" step="0.01" id="newDebtAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
            </div>
            <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Alteração</button>
            </div>
        </form>
    </div>
</div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- INÍCIO DA APLICAÇÃO ---
        lucide.createIcons();

        document.getElementById('autoIptuCheckbox').addEventListener('change', (e) => {
            const transactionAmountInput = document.getElementById('transactionAmount');
            const installmentValue = parseFloat(e.target.dataset.iptuValue) || 0;
            let currentAmount = parseFloat(transactionAmountInput.value) || 0;

            if (e.target.checked) {
                // Adiciona o valor do IPTU
                transactionAmountInput.value = (currentAmount + installmentValue).toFixed(2);
            } else {
                // Remove o valor do IPTU
                transactionAmountInput.value = (currentAmount - installmentValue).toFixed(2);
            }
        });

        let settings = { password: 'davi' };
        let managers = [];
        let items = [];
        let transactions = [];
        let financialChart;
        let onConfirm = null;
        let allManagedItemIds = new Set();

        const updateManagedItemIds = () => {
                allManagedItemIds.clear();
                managers.forEach(m => {
                    m.assignedItemIds.forEach(id => allManagedItemIds.add(id));
                });
            };
            
            const isItemManagedByGestor = (itemId) => allManagedItemIds.has(parseInt(itemId));

        const appContainer = document.getElementById('app');
        const modals = document.querySelectorAll('.modal');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const addItemForm = document.getElementById('addItemForm');
        const editItemForm = document.getElementById('editItemForm');
        const rentItemForm = document.getElementById('rentItemForm');
        const addTransactionForm = document.getElementById('addTransactionForm');
        const editTransactionForm = document.getElementById('editTransactionForm');
        const iptuForm = document.getElementById('iptuForm');
        const editDebtForm = document.getElementById('editDebtForm');
        const notificationsToggle = document.getElementById('notificationsToggle');
        const iptuButtonToggle = document.getElementById('iptuButtonToggle');

        notificationsToggle.addEventListener('change', (e) => {
        settings.notificationsEnabled = e.target.checked;
        saveData(); // Salva a nova configuração
        updateNotificationVisibility(); // Atualiza a visibilidade das abas
        checkAlerts(); // Re-checa os alertas para atualizar o badge (se habilitado)
    });

    const managedItemWarningToggle = document.getElementById('managedItemWarningToggle');

        managedItemWarningToggle.addEventListener('change', (e) => {
            settings.managedItemWarningEnabled = e.target.checked;
            saveData();
        });

        const hideMobileNavLabelsToggle = document.getElementById('hideMobileNavLabelsToggle');
        hideMobileNavLabelsToggle.addEventListener('change', (e) => {
            settings.hideMobileNavLabels = e.target.checked;
            saveData();
            applyMobileNavSetting(e.target.checked); // Aplica a mudança imediatamente
        });

    iptuButtonToggle.addEventListener('change', (e) => {
        settings.iptuButtonEnabled = e.target.checked;
        saveData(); // Salva a nova configuração
        renderItems(items); // Re-renderiza apenas a lista de itens para mostrar/esconder o botão
        lucide.createIcons();
    });
        
        const saveData = () => {
            localStorage.setItem('rentalManagerItems', JSON.stringify(items));
            localStorage.setItem('rentalManagerTransactions', JSON.stringify(transactions));
            localStorage.setItem('rentalManagerSettings', JSON.stringify(settings));
            localStorage.setItem('rentalManagerManagers', JSON.stringify(managers));
        };

        const loadData = () => {
            const storedSettings = localStorage.getItem('rentalManagerSettings');
            if (storedSettings) settings = JSON.parse(storedSettings);
            
            if (settings.notificationsEnabled === undefined) {
                settings.notificationsEnabled = false;
            }

            if (settings.iptuButtonEnabled === undefined) {
                settings.iptuButtonEnabled = true;
            }

            if (settings.managedItemWarningEnabled === undefined) {
                settings.managedItemWarningEnabled = true; 
            }

            if (settings.hideMobileNavLabels === undefined) {
                settings.hideMobileNavLabels = false; 
            }

            const storedManagers = localStorage.getItem('rentalManagerManagers');
            if(storedManagers) managers = JSON.parse(storedManagers);

            const storedItems = localStorage.getItem('rentalManagerItems');
            items = storedItems ? JSON.parse(storedItems) : [];
            const storedTransactions = localStorage.getItem('rentalManagerTransactions');
            transactions = storedTransactions ? JSON.parse(storedTransactions) : [];
        };

        const updateNotificationVisibility = () => {
    const showNotifications = settings.notificationsEnabled;
    // Seleciona todos os elementos relacionados à aba de notificações
    const notificationTabs = document.querySelectorAll('.tab-button[data-tab="notifications"]');

    notificationTabs.forEach(tab => {
        tab.style.display = showNotifications ? '' : 'none'; // Mostra ou esconde
    });

    // Se as notificações foram desativadas e a aba ativa era a de notificações, muda para o dashboard
    const activeTopTab = document.querySelector('#top-nav .tab-button.active-tab');
    const activeBottomTab = document.querySelector('#bottom-nav .tab-button.active-tab');
    if (!showNotifications && ( (activeTopTab && activeTopTab.dataset.tab === 'notifications') || (activeBottomTab && activeBottomTab.dataset.tab === 'notifications') ) ) {
        switchTab('dashboard');
    }
};
        
        const renderAll = () => {
            updateManagedItemIds();
            customizeUIForAdmin();
            updateNotificationVisibility();
            document.getElementById('notificationsToggle').checked = settings.notificationsEnabled;
            document.getElementById('iptuButtonToggle').checked = settings.iptuButtonEnabled;
            document.getElementById('managedItemWarningToggle').checked = settings.managedItemWarningEnabled;
            document.getElementById('hideMobileNavLabelsToggle').checked = settings.hideMobileNavLabels;
            applyMobileNavSetting(settings.hideMobileNavLabels);
            renderDashboard(items, transactions);
            renderTransactions(transactions);
            checkAlerts();
            renderManagers();
            renderAdminManagersDashboard();
            renderItems(items);
            renderRentals(items);
            lucide.createIcons();
        };
        
        const customizeUIForAdmin = () => {
            const showGestoresTab = managers.length > 0;
            document.getElementById('gestores-main-tab').style.display = showGestoresTab ? 'flex' : 'none';
            document.getElementById('gestores-bottom-tab').style.display = showGestoresTab ? 'flex' : 'none';
        };

        const updateDashboardView = () => {
            renderDashboard(items, transactions);
        };

        const initDashboardFilters = () => {
            const monthSelect = document.getElementById('filterMonth'), yearSelect = document.getElementById('filterYear'), now = new Date();
            if (monthSelect.options.length > 0) return; // Evita repopular
            for(let i=0; i<12; i++) { const monthName = new Date(2000, i).toLocaleString('pt-BR', {month: 'long'}); monthSelect.innerHTML += `<option value="${i}">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</option>`; }
            
            const currentTransactions = transactions; 
            const years = [...new Set(currentTransactions.map(t => new Date(t.date).getFullYear()))].filter(Boolean);
            if (!years.includes(now.getFullYear())) {
                years.push(now.getFullYear());
            }
            years.sort((a,b) => b-a);
            years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);
            monthSelect.value = now.getMonth(); yearSelect.value = now.getFullYear();
            
            monthSelect.addEventListener('change', updateDashboardView);
            yearSelect.addEventListener('change', updateDashboardView);
            document.getElementById('chart-view').addEventListener('change', updateDashboardView);
        };

        const renderDashboard = (dashboardItems, dashboardTransactions) => {
            renderSummaryCards(dashboardItems);
            const view = document.getElementById('chart-view').value;
            const year = parseInt(document.getElementById('filterYear').value, 10);
            const month = parseInt(document.getElementById('filterMonth').value, 10);
            
            if (view === 'monthly') {
                renderBalanceCard(year, month, dashboardTransactions);
                renderChart(year, 'monthly', dashboardTransactions);
            } else {
                renderBalanceCard(year, null, dashboardTransactions); 
                renderChart(null, 'yearly', dashboardTransactions);
            }
        };

        const renderSummaryCards = (summaryItems) => {
            const rentedCount = summaryItems.filter(item => item.rentedTo).length;
            document.getElementById('total-items').textContent = summaryItems.length;
            document.getElementById('rented-items').textContent = rentedCount;
            document.getElementById('available-items').textContent = summaryItems.length - rentedCount;
        };

        const renderItems = (itemsToRender) => {
            const availableList = document.getElementById('available-list');
            const rentedList = document.getElementById('rented-list');
            availableList.innerHTML = '';
            rentedList.innerHTML = '';

            // 1. Criamos o Set com todos os IDs de itens gerenciados
            const allManagedItemIds = new Set();
            managers.forEach(m => {
                m.assignedItemIds.forEach(id => allManagedItemIds.add(id));
            });


            if (itemsToRender.length === 0) {
                availableList.innerHTML = `<p class="text-gray-400">Nenhum item para gerenciar.</p>`;
            }

            const currentYear = new Date().getFullYear();

            itemsToRender.forEach(item => {
                
                // 2. Verificamos se o item é gerenciado
                const isManagedByGestor = allManagedItemIds.has(item.id);

                let iptuStatusHTML = '';
                if (item.iptu && item.iptu[currentYear]) {
                    const iptuData = item.iptu[currentYear];
                    if (iptuData.paidInstallments >= iptuData.installments) {
                        iptuStatusHTML = `<p class="text-xs text-green-400 mt-1">IPTU ${currentYear}: Pago</p>`;
                    } else {
                        iptuStatusHTML = `<p class="text-xs text-blue-400 mt-1">IPTU ${currentYear}: ${iptuData.paidInstallments}/${iptuData.installments} parcelas pagas</p>`;
                    }
                }

                const iptuButton = settings.iptuButtonEnabled && item.category === 'Imóvel' ? `<button data-id="${item.id}" class="iptu-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md flex items-center text-xs" title="Gerenciar/Registrar IPTU"><i data-lucide="landmark" class="h-4 w-4 mr-1"></i>IPTU</button>` : '';
                const actionButtons = `<div class="mt-4 flex justify-end items-center space-x-2">${iptuButton}<button data-id="${item.id}" class="edit-item-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Item"><i data-lucide="file-signature" class="h-5 w-5"></i></button>${item.rentedTo ? `<button data-id="${item.id}" class="edit-rent-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Aluguel"><i data-lucide="clipboard-edit" class="h-5 w-5"></i></button>` : ''}<button data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full" title="${item.rentedTo ? 'Finalizar Aluguel' : 'Excluir Item'}"><i data-lucide="trash-2" class="h-5 w-5"></i></button>${!item.rentedTo ? `<button data-id="${item.id}" class="rent-btn bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-md flex items-center text-sm"><i data-lucide="key-round" class="mr-2 h-4 w-4"></i>Alugar</button>` : ''}</div>`;

                if (item.rentedTo) {
                    
                    // --- INÍCIO DA MODIFICAÇÃO (Item Alugado) ---
                    // 3. Define a borda: BRANCA se for gerenciado, amarela se for particular/alugado
                    const borderColor = isManagedByGestor ? 'border-white' : 'border-yellow-500';
                    // 4. Aplicamos a 'borderColor' (fundo é sempre bg-gray-800)
                    const card = `<div class="bg-gray-800 p-4 rounded-lg border-l-4 ${borderColor} flex flex-col h-full"><div class="flex-grow"><div class="flex justify-between items-start"><div><h3 class="font-bold text-lg">${(item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name}</h3><p class="text-sm text-gray-400">${item.category}</p>${iptuStatusHTML}</div><span class="text-lg font-semibold">${formatCurrency(item.rentValue)}</span></div><div class="mt-3 text-sm space-y-1"><p><strong class="text-gray-300">Inquilino:</strong> ${item.rentedTo}</p><p><strong class="text-gray-300">Término Contrato:</strong> <span>${formatDate(item.rentEndDate)}</span></p></div></div>${actionButtons}</div>`;
                    // --- FIM DA MODIFICAÇÃO ---

                    rentedList.innerHTML += card;
                } else {
                    // (Código original do payIptuButton)
                    let payIptuButton = ''; 
                    const currentYear = new Date().getFullYear();
                    if (settings.iptuButtonEnabled &&
                        item.category === 'Imóvel' &&
                        item.iptu && item.iptu[currentYear])
                    {
                        const iptuData = item.iptu[currentYear];
                        if (iptuData.paidInstallments < iptuData.installments) {
                            payIptuButton = `<button data-id="${item.id}" class="pay-iptu-expense-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md flex items-center text-xs" title="Registrar Pagamento Parcela IPTU"><i data-lucide="landmark" class="h-4 w-4 mr-1"></i>Pagar IPTU</button>`;
                        }
                    }
                    const iptuButton = settings.iptuButtonEnabled && item.category === 'Imóvel' ? `<button data-id="${item.id}" class="iptu-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md flex items-center text-xs" title="Gerenciar/Registrar IPTU"><i data-lucide="landmark" class="h-4 w-4 mr-1"></i>IPTU</button>` : '';
                    const actionButtons = `<div class="mt-4 flex justify-end items-center gap-2">${iptuButton}${payIptuButton}<button data-id="${item.id}" class="edit-item-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Item"><i data-lucide="file-signature" class="h-5 w-5"></i></button><button data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full" title="Excluir Item"><i data-lucide="trash-2" class="h-5 w-5"></i></button><button data-id="${item.id}" class="rent-btn bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-md flex items-center text-sm"><i data-lucide="key-round" class="mr-2 h-4 w-4"></i>Alugar</button></div>`;
                    // (Fim do código do payIptuButton)


                    // --- INÍCIO DA MODIFICAÇÃO (Item Disponível) ---
                    // 3. Define a borda: BRANCA se for gerenciado, verde se for particular/disponível
                    const borderColor = isManagedByGestor ? 'border-white' : 'border-green-500';
                    // 4. Aplicamos a 'borderColor' (fundo é sempre bg-gray-800)
                    const card = `<div class="bg-gray-800 p-4 rounded-lg border-l-4 ${borderColor} flex flex-col h-full"><div class="flex-grow"><div class="flex justify-between items-start"><div><h3 class="font-bold text-lg">${(item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name}</h3><p class="text-sm text-gray-400">${item.category}</p>${iptuStatusHTML}</div><span class="text-lg font-semibold">${formatCurrency(item.value)}</span></div>${item.description ? `<p class="text-sm text-gray-300 mt-2">${item.description}</p>` : ''}</div>${actionButtons}</div>`;
                    // --- FIM DA MODIFICAÇÃO ---
                    
                    availableList.innerHTML += card;
                }
            });
            if (rentedList.innerHTML === '') rentedList.innerHTML = `<p class="text-gray-400">Nenhum item alugado no momento.</p>`;
            if (availableList.innerHTML === '') availableList.innerHTML = `<p class="text-gray-400">Nenhum item disponível no momento.</p>`;
        };

        const renderRentals = (rentedItemsToRender) => {
            const sortedRentalsList = document.getElementById('sorted-rentals-list');
            sortedRentalsList.innerHTML = '';

            // 1. Criamos o Set com todos os IDs de itens gerenciados
            const allManagedItemIds = new Set();
            managers.forEach(m => {
                m.assignedItemIds.forEach(id => allManagedItemIds.add(id));
            });

            const rentedItems = rentedItemsToRender.filter(item => item.rentedTo);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // (Lógica de cálculo de OverdueCycles - sem alteração)
            const calculateOverdueCycles = (item) => {
                if (item.paymentFrequency !== 'monthly') return 0;
                const overdueMonths = [];
                const startDate = new Date(item.rentStartDate + 'T00:00:00');
                const endDate = new Date(item.rentEndDate + 'T00:00:00');
                let checkDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

                while (checkDate < new Date(today.getFullYear(), today.getMonth(), 1) && checkDate <= endDate) {
                    const paymentDueDateInLoop = new Date(checkDate.getFullYear(), checkDate.getMonth(), item.paymentDay);
                    if (paymentDueDateInLoop <= today && paymentDueDateInLoop > startDate) {
                        const periodString = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
                        if (!item.paymentsMade || !item.paymentsMade.includes(periodString)) {
                            overdueMonths.push(periodString);
                        }
                    }
                    checkDate.setMonth(checkDate.getMonth() + 1);
                }
                return overdueMonths.length;
            };

            // (Lógica de prioridade de Sorteio - sem alteração)
            rentedItems.forEach(item => {
                const endDate = new Date(item.rentEndDate + 'T00:00:00');
                const overdueCycles = calculateOverdueCycles(item);
                item.overdueCycles = overdueCycles; 

                const currentMonthYear = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                const isPaidThisMonth = item.paymentsMade && item.paymentsMade.includes(currentMonthYear);
                const paymentDueDateThisMonth = new Date(today.getFullYear(), today.getMonth(), item.paymentDay);

                if (today > endDate && !item.renewalPending) item.sortPriority = 1; 
                else if (overdueCycles > 0) item.sortPriority = 2; 
                else if (today >= paymentDueDateThisMonth && !isPaidThisMonth) item.sortPriority = 3; 
                else if (item.debt && item.debt.amount > 0) item.sortPriority = 4; 
                else if (item.renewalPending) item.sortPriority = 5; 
                else if (!isPaidThisMonth) item.sortPriority = 6; 
                else item.sortPriority = 7; 
            });

            // (Lógica de Sorteio - sem alteração)
            rentedItems.sort((a, b) => {
                if (a.sortPriority !== b.sortPriority) {
                    return a.sortPriority - b.sortPriority;
                }
                return a.paymentDay - b.paymentDay;
            });

            if (rentedItems.length === 0) {
                sortedRentalsList.innerHTML = `<p class="text-gray-400">Nenhum aluguel ativo no momento.</p>`;
                return;
            }

            rentedItems.forEach(item => {
                const endDate = new Date(item.rentEndDate + 'T00:00:00');
                const isContractOverdue = today > endDate;
                const isPaidThisMonth = item.paymentsMade && item.paymentsMade.includes(`${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`);

                // --- INÍCIO DA MODIFICAÇÃO (Aba Aluguéis) ---
                // 2. Definimos a cor da borda de status (vermelho, amarelo, verde, etc.)
                let borderColor = 'border-gray-600'; // Cor padrão
                if (item.sortPriority === 1 || item.sortPriority === 2 || item.sortPriority === 4) {
                    borderColor = 'border-red-500';
                } 
                else if (item.sortPriority === 3 || item.sortPriority === 6) {
                    borderColor = 'border-yellow-500';
                } 
                else if (item.sortPriority === 5) {
                    borderColor = 'border-pink-500';
                } else if (item.sortPriority === 7) {
                    borderColor = 'border-green-500';
                }
                
                // 3. Verificamos se o item é gerenciado
                const isManagedByGestor = allManagedItemIds.has(item.id);
                
                // 4. SOBRESCREVEMOS a cor da borda para BRANCA se for gerenciado
                if (isManagedByGestor) {
                    borderColor = 'border-white';
                }
                // --- FIM DA MODIFICAÇÃO ---

                let paymentStatusHTML = '';
                if (isPaidThisMonth && item.overdueCycles === 0 && (!item.debt || item.debt.amount === 0)) {
                    const currentMonthName = today.toLocaleString('pt-BR', { month: 'long' });
                    paymentStatusHTML = `<p><strong class="text-gray-300">Situação:</strong> <span class="text-xs font-medium bg-green-900 text-green-300 px-2 py-1 rounded-full">Pagamento de ${currentMonthName} OK</span></p>`;
                }

                let iptuStatusHTML_rentals = '';
                const currentYear = new Date().getFullYear();
                if (item.iptu && item.iptu[currentYear]) {
                    const iptuData = item.iptu[currentYear];
                    const installmentValue = iptuData.installments > 0 ? (iptuData.totalValue / iptuData.installments) : 0;

                    if (iptuData.paidInstallments < iptuData.installments) {
                        iptuStatusHTML_rentals = `<p class="text-xs text-blue-400 font-semibold text-right">IPTU: ${iptuData.paidInstallments}/${iptuData.installments} - ${formatCurrency(installmentValue)}</p>`;
                    }
                }

                // 5. Aplicamos 'bg-gray-800' e a nova 'borderColor'
                const card = `
                    <div class="bg-gray-800 p-4 rounded-lg border-l-4 ${borderColor} flex flex-col h-full">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg">${(item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name}</h3>
                                    <p class="text-sm text-gray-400">${item.category}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-lg font-semibold block">${formatCurrency(item.rentValue)}</span>
                                    ${iptuStatusHTML_rentals}
                                    ${item.debt && item.debt.amount > 0 ? `<button data-id="${item.id}" class="manage-debt-btn text-xs text-red-400 font-semibold text-right w-full hover:bg-red-900/50 rounded-md px-1 py-0.5">Dívida: ${item.debt.cycles}ª - ${formatCurrency(item.debt.amount)}</button>` : ''}
                                </div>
                            </div>
                            <div class="mt-3 text-sm space-y-1">
                                <p><strong class="text-gray-300">Inquilino:</strong> ${item.rentedTo}</p>
                                <p><strong class="text-gray-300">Dia do Pagamento:</strong> ${item.paymentDay}</p>
                                <p><strong class="text-gray-300">Término Contrato:</strong> <span class="${isContractOverdue && !item.renewalPending ? 'text-red-400 font-bold' : ''}">${formatDate(item.rentEndDate)}</span></p>
                                ${item.overdueCycles > 0 ? `<p class="text-red-400"><strong class="font-semibold">Atrasado:</strong> ${item.overdueCycles} ciclo(s)</p>` : ''}
                                ${paymentStatusHTML}
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end items-center space-x-2">
                            <button data-id="${item.id}" class="add-revenue-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md flex items-center text-xs" title="Adicionar Receita"><i data-lucide="dollar-sign" class="h-4 w-4 mr-1"></i>Receita</button>
                            <button data-id="${item.id}" class="edit-rent-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Aluguel"><i data-lucide="clipboard-edit" class="h-5 w-5"></i></button>
                            <button data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full" title="Finalizar Aluguel"><i data-lucide="trash-2" class="h-5 w-5"></i></button>
                        </div>
                    </div>
                `;
                sortedRentalsList.innerHTML += card;
            });

            lucide.createIcons();
        };
   


const renderTransactions = (transactionsToRender) => {
    const list = document.getElementById('transactions-list');
    list.innerHTML = ''; // Limpa a lista principal

    const sortedTransactions = [...transactionsToRender].sort((a, b) => b.id - a.id);

    if (sortedTransactions.length === 0) {
        list.innerHTML = `<div class="p-4 text-center text-gray-400 bg-gray-800 rounded-lg">Nenhuma transação encontrada.</div>`;
        return;
    }

    // --- Gera o HTML para cada tipo de visualização ---

    // 1. HTML para os cards de CELULAR
    const mobileHTML = sortedTransactions.map(t => {
        let typeClass = '', typeText = '', amountClass = '', amountPrefix = '';
        if (t.type === 'revenue') { typeClass = 'bg-green-900 text-green-300'; typeText = 'Receita'; amountClass = 'text-green-400'; amountPrefix = '+'; } 
        else if (t.type === 'expense' && t.description.startsWith('Pagamento IPTU')) {
            typeClass = 'bg-blue-900 text-blue-300'; typeText = 'Despesa (IPTU)'; amountClass = 'text-blue-400'; amountPrefix = '-'; // Classes Azuis
        }
        else if (t.type === 'expense') { typeClass = 'bg-red-900 text-red-300'; typeText = 'Despesa'; amountClass = 'text-red-400'; amountPrefix = '-'; } 
        else if (t.type === 'management_fee') { typeClass = 'bg-yellow-900 text-yellow-300'; typeText = 'Taxa Gerência'; amountClass = 'text-yellow-400'; amountPrefix = '-'; }
        
        const item = t.itemId ? items.find(i => i.id === t.itemId) : null;
        let cardContentHTML = '';

        if (t.type === 'revenue' && item && item.rentedTo) {
            const itemIdentifierLabel = (item.category === 'Imóvel' && item.endereco) ? 'Endereço:' : 'Item:';
            const itemIdentifierValue = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
            cardContentHTML = `
                <div class="space-y-1.5">
                    <p class="text-sm text-gray-200 flex"><strong class="font-semibold text-gray-400 w-20 shrink-0">Inquilino:</strong> <span>${item.rentedTo}</span></p>
                    <p class="text-sm text-gray-200 flex"><strong class="font-semibold text-gray-400 w-20 shrink-0">${itemIdentifierLabel}</strong> <span>${itemIdentifierValue}</span></p>
                    <p class="text-sm text-gray-200 flex"><strong class="font-semibold text-gray-400 w-20 shrink-0">Data:</strong> <span>${formatDate(t.date)}</span></p>
                    <p class="text-sm text-gray-200 flex"><strong class="font-semibold text-gray-400 w-20 shrink-0">Valor:</strong> <span class="font-semibold ${amountClass}">${amountPrefix} ${formatCurrency(t.amount)}</span></p>
                </div>`;
        } else if (t.type === 'management_fee' && item) {
            const itemIdentifierLabel = (item.category === 'Imóvel' && item.endereco) ? 'Endereço:' : 'Item:';
            const itemIdentifierValue = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
            cardContentHTML = `
                <div class="space-y-1.5">
                    <p class="text-sm text-gray-200 flex"><strong class="font-semibold text-gray-400 w-24 shrink-0">Gerência:</strong> <span>${item.managerName || 'N/A'}</span></p>
                    <p class="text-sm text-gray-200 flex"><strong class="font-semibold text-gray-400 w-24 shrink-0">Inquilino:</strong> <span>${item.rentedTo || 'N/A'}</span></p>
                    <p class="text-sm text-gray-200 flex"><strong class="font-semibold text-gray-400 w-24 shrink-0">${itemIdentifierLabel}</strong> <span>${itemIdentifierValue}</span></p>
                    <p class="text-sm text-gray-200 flex"><strong class="font-semibold text-gray-400 w-24 shrink-0">Data:</strong> <span>${formatDate(t.date)}</span></p>
                    <p class="text-sm text-gray-200 flex"><strong class="font-semibold text-gray-400 w-24 shrink-0">Valor:</strong> <span class="font-semibold ${amountClass}">${amountPrefix} ${formatCurrency(t.amount)}</span></p>
                </div>`;
        } else {
             cardContentHTML = `
                <div class="space-y-2">
                    <p class="text-lg font-bold text-white break-words">${t.description}</p>
                    <div class="flex items-center justify-between text-sm pt-1">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${typeClass}">${typeText}</span>
                        <span class="text-gray-400">${formatDate(t.date)}</span>
                    </div>
                    <p class="text-right text-lg font-semibold ${amountClass}">${amountPrefix} ${formatCurrency(t.amount)}</p>
                </div>`;
        }
        
        return `
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                ${cardContentHTML}
                <div class="flex items-center justify-end space-x-2 pt-1">
                    <button data-id="${t.id}" class="edit-transaction-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Transação"><i data-lucide="edit" class="h-5 w-5"></i></button>
                    <button data-id="${t.id}" class="delete-transaction-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full" title="Excluir Transação"><i data-lucide="trash-2" class="h-5 w-5"></i></button>
                </div>
            </div>`;
    }).join('');

    // 2. HTML para as linhas de DESKTOP
    const desktopRowsHTML = sortedTransactions.map(t => {
        let typeClass = '', typeText = '', amountClass = '', amountPrefix = '';
        if (t.type === 'revenue') { typeClass = 'bg-green-900 text-green-300'; typeText = 'Receita'; amountClass = 'text-green-400'; amountPrefix = '+'; } 
        else if (t.type === 'expense' && t.description.startsWith('Pagamento IPTU')) {
            typeClass = 'bg-blue-900 text-blue-300'; typeText = 'Despesa (IPTU)'; amountClass = 'text-blue-400'; amountPrefix = '-'; // Classes Azuis
        }
        else if (t.type === 'expense') { typeClass = 'bg-red-900 text-red-300'; typeText = 'Despesa'; amountClass = 'text-red-400'; amountPrefix = '-'; } 
        else if (t.type === 'management_fee') { typeClass = 'bg-yellow-900 text-yellow-300'; typeText = 'Taxa Gerência'; amountClass = 'text-yellow-400'; amountPrefix = '-'; }

        const item = t.itemId ? items.find(i => i.id === t.itemId) : null;
        let displayDescriptionDesktop = t.description;
        if (item) {
            const itemIdentifier = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
            if (t.type === 'revenue' && item.rentedTo) {
                displayDescriptionDesktop = `${item.rentedTo} - ${itemIdentifier}`;
            } else if (t.type === 'management_fee') {
                displayDescriptionDesktop = `${item.managerName || 'Taxa'} - ${itemIdentifier}`;
            }
        }
        
        return `
            <div class="grid grid-cols-12 gap-4 items-center p-4 text-sm">
                <div class="col-span-2 text-gray-300">${formatDate(t.date)}</div>
                <div class="col-span-4 text-white break-words">${displayDescriptionDesktop}</div>
                <div class="col-span-2"><span class="px-2 py-1 rounded-full text-xs font-medium ${typeClass}">${typeText}</span></div>
                <div class="col-span-2 text-right font-semibold ${amountClass}">${amountPrefix} ${formatCurrency(t.amount)}</div>
                <div class="col-span-2">
                    <div class="flex items-center justify-center space-x-2">
                        <button data-id="${t.id}" class="edit-transaction-btn text-gray-400 hover:text-cyan-400 transition-colors p-1 rounded-full" title="Editar Transação"><i data-lucide="edit" class="h-4 w-4"></i></button>
                        <button data-id="${t.id}" class="delete-transaction-btn text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full" title="Excluir Transação"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                    </div>
                </div>
            </div>`;
    }).join('');

    // --- Monta a estrutura final ---
    const finalHTML = `
        <!-- Container para a visualização de Celular -->
        <div class="md:hidden space-y-4">
            ${mobileHTML}
        </div>

        <!-- Container para a visualização de Desktop -->
        <div class="hidden md:block bg-gray-800 rounded-xl shadow-lg overflow-hidden">
            <!-- Cabeçalho do Desktop -->
            <div class="grid grid-cols-12 gap-4 items-center bg-gray-700 p-4 font-semibold text-sm text-gray-300">
                <div class="col-span-2">Data</div>
                <div class="col-span-4">Descrição</div>
                <div class="col-span-2">Tipo</div>
                <div class="col-span-2 text-right">Valor</div>
                <div class="col-span-2 text-center">Ações</div>
            </div>
            <!-- Corpo das linhas do Desktop -->
            <div class="divide-y divide-gray-700">
                ${desktopRowsHTML}
            </div>
        </div>
    `;

    list.innerHTML = finalHTML;
    lucide.createIcons();
};


        const checkAlerts = () => {
            const container = document.getElementById('alerts-container');
            const notificationBadges = document.querySelectorAll('.notification-badge');
            const notificationsTabBtns = document.querySelectorAll('.tab-button[data-tab="notifications"]');
            container.innerHTML = '';
            notificationBadges.forEach(badge => badge.textContent = 0);
            notificationsTabBtns.forEach(btn => btn.classList.remove('has-notifications'));
            
            if (!settings.notificationsEnabled) {
                container.innerHTML = `<p class="text-gray-400">As notificações estão desativadas nos Ajustes.</p>`;
                return; // Sai da função se as notificações estiverem desativadas
            }
    

            let alertCount = 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            items.forEach(item => {
                if (!item.rentedTo || item.paymentFrequency === 'single') return;

                const endDate = new Date(item.rentEndDate + 'T00:00:00');
                
                if (today > endDate && !item.endOfContractNotified) {
                    alertCount++;
                    const alertHTML = `
                        <div class="bg-red-900/50 border border-red-700 p-4 rounded-lg flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                            <div><p class="font-semibold text-red-300">O contrato de "${(item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name}" terminou.</p><p class="text-sm text-red-400">Ação necessária: renovar, finalizar ou deixar pendente.</p></div>
                            <button data-id="${item.id}" class="resolve-contract-end-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-md text-sm whitespace-nowrap self-end sm:self-center">Resolver</button>
                        </div>
                    `;
                    container.innerHTML += alertHTML;
                    return; 
                }

                const startDate = new Date(item.rentStartDate + 'T00:00:00');
                let firstPaymentDueDate = new Date(startDate);

                if (item.paymentFrequency === 'monthly') {
                    firstPaymentDueDate.setMonth(firstPaymentDueDate.getMonth() + 1);
                    firstPaymentDueDate.setDate(item.paymentDay);
                } else if (item.paymentFrequency === 'weekly') {
                    firstPaymentDueDate.setDate(firstPaymentDueDate.getDate() + 7);
                } else if (item.paymentFrequency === 'daily') {
                    firstPaymentDueDate.setDate(firstPaymentDueDate.getDate() + 1);
                }
                
                if (today < firstPaymentDueDate) {
                    return; 
                }

                const currentMonthYear = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                const isPaidThisMonth = item.paymentsMade && item.paymentsMade.includes(currentMonthYear);

                const paymentDueDateThisMonth = new Date(today.getFullYear(), today.getMonth(), item.paymentDay);
                const lastPaymentDate = item.lastPaymentAlertDate ? new Date(item.lastPaymentAlertDate) : null;

                if (today >= paymentDueDateThisMonth && !isPaidThisMonth && (!lastPaymentDate || lastPaymentDate < paymentDueDateThisMonth)) {
                    alertCount++;
                    const alertHTML = `
                        <div class="bg-yellow-900/50 border border-yellow-700 p-4 rounded-lg flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                            <div><p class="font-semibold text-yellow-300">Pagamento de "${(item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name}" está pendente este mês.</p><p class="text-sm text-yellow-400">A data de vencimento foi dia ${item.paymentDay}.</p></div>
                            <button data-id="${item.id}" class="resolve-payment-btn bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-3 rounded-md text-sm whitespace-nowrap self-end sm:self-center">Resolver</button>
                        </div>
                    `;
                    container.innerHTML += alertHTML;
                }
            });

            notificationBadges.forEach(badge => badge.textContent = alertCount);

            notificationsTabBtns.forEach(btn => {
                if (alertCount > 0) {
                    btn.classList.add('has-notifications');
                } else {
                    btn.classList.remove('has-notifications');
                }
            });
            
            if (alertCount === 0) {
                container.innerHTML = `<p class="text-gray-400">Nenhum alerta no momento.</p>`;
            }
        };

        const renderManagers = () => {
            const list = document.getElementById('managers-list');
            list.innerHTML = '';
            if (managers.length === 0) {
                list.innerHTML = '<p class="text-gray-400">Nenhum gestor cadastrado.</p>';
                return;
            }

            managers.forEach(manager => {
                const assignedItems = items.filter(item => manager.assignedItemIds.includes(item.id));
                const card = `
                    <div class="bg-gray-700 p-4 rounded-lg flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                        <div>
                            <p class="font-bold text-lg">${manager.name}</p>
                            <p class="text-sm text-gray-300">${manager.type} - <span class="text-cyan-400">${assignedItems.length} alugu(éis)</span></p>
                        </div>
                        <div class="flex items-center space-x-2 self-end sm:self-center">
                            <button data-id="${manager.id}" class="edit-manager-btn bg-gray-600 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg flex items-center text-sm">
                                <i data-lucide="edit" class="h-4 w-4 mr-2"></i> Editar
                            </button>
                            <button data-id="${manager.id}" class="delete-manager-btn bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg flex items-center text-sm">
                                <i data-lucide="trash-2" class="h-4 w-4 mr-2"></i> Excluir
                            </button>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
             lucide.createIcons();
        };

        const renderAdminManagersDashboard = () => {
            const dashboard = document.getElementById('admin-managers-dashboard');
            dashboard.innerHTML = '';
            if (managers.length === 0) {
                dashboard.innerHTML = '<p class="text-gray-400">Nenhum gestor cadastrado. Adicione gestores na aba de Configurações.</p>';
                return;
            }

            managers.forEach(manager => {
                const assignedItems = items.filter(item => manager.assignedItemIds.includes(item.id));
                const rentedCount = assignedItems.filter(item => item.rentedTo).length;
                
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                const managerTransactions = transactions.filter(t => 
                    t.itemId && manager.assignedItemIds.includes(t.itemId) &&
                    new Date(t.date).getMonth() === currentMonth &&
                    new Date(t.date).getFullYear() === currentYear
                );

                const revenue = managerTransactions.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
                const fees = managerTransactions.filter(t => t.type === 'management_fee').reduce((sum, t) => sum + t.amount, 0);

                const card = `
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-cyan-400 mb-4">${manager.name} <span class="text-base font-normal text-gray-400">- ${manager.type}</span></h3>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"> 
                        <div class="bg-gray-700/50 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-400">Aluguéis Gerenciados</h4>
                                <p class="mt-1 text-2xl font-semibold">${assignedItems.length}</p>
                            </div>
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-400">Atualmente Alugados</h4>
                                <p class="mt-1 text-2xl font-semibold">${rentedCount}</p>
                            </div>
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-400">Receita do Mês</h4>
                                <p class="mt-1 text-2xl font-semibold text-green-400">${formatCurrency(revenue)}</p>
                            </div>
                            <div class="bg-gray-700/50 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-400">Ganho com Taxas (Mês)</h4>
                                <p class="mt-1 text-2xl font-semibold text-yellow-400">${formatCurrency(fees)}</p>
                            </div>
                        </div>
                    </div>
                `; //
                dashboard.innerHTML += card;
            });
        };
        
        const renderBalanceCard = (year, month, transactionsForBalance) => {
            const monthName = month !== null ? new Date(year, month).toLocaleString('pt-BR', { month: 'long' }) : '';

            let balance = 0;
            let totalExpenses = 0;
            let totalFees = 0;
            let totalRevenue = 0;
            
            const relevantTransactions = month === null 
                ? transactionsForBalance.filter(t => new Date(t.date).getFullYear() === year)
                : transactionsForBalance.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === month && tDate.getFullYear() === year;
                }).filter(t => !t.excludeFromDashboard);

            relevantTransactions.forEach(t => {
                if(t.type === 'revenue') {
                    totalRevenue += t.amount;
                } else if (t.type === 'expense') {
                    totalExpenses += t.amount;
                } else if (t.type === 'management_fee') {
                    totalFees += t.amount;
                }
            });

            balance = totalRevenue - totalExpenses - totalFees;
            
            const balanceTitle = document.getElementById('month-balance-title');
            const expenseTitle = document.getElementById('month-expense-title');
            const feeTitle = document.getElementById('month-fee-title');

            const periodText = month !== null ? `de ${monthName}/${year}` : `de ${year}`;
            balanceTitle.textContent = `Saldo ${periodText}`;
            expenseTitle.textContent = `Despesas ${periodText}`;
            feeTitle.textContent = `Taxa de Gerência ${periodText}`;

            document.getElementById('month-balance').textContent = formatCurrency(balance);
            document.getElementById('month-expense').textContent = formatCurrency(totalExpenses);
            document.getElementById('month-fee').textContent = formatCurrency(totalFees);
        }

        const renderChart = (year, view, transactionsForChart) => {
            const ctx = document.getElementById('financialChart').getContext('2d');
            let labels = [];
            let revenueData = [], expenseData = [], managementFeeData = [];

            if (view === 'monthly') {
                labels = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                revenueData = Array(12).fill(0);
                expenseData = Array(12).fill(0);
                managementFeeData = Array(12).fill(0);
                
                transactionsForChart.forEach(t => {
                    if (t.excludeFromDashboard) return;
                    const tDate = new Date(t.date);
                    if (tDate.getFullYear() === year) {
                        const monthIndex = tDate.getMonth();
                        if (t.type === 'revenue') revenueData[monthIndex] += t.amount;
                        else if (t.type === 'expense') expenseData[monthIndex] += t.amount;
                        else if (t.type === 'management_fee') managementFeeData[monthIndex] += t.amount;
                    }
                });
            } else { // yearly
                const years = [...new Set(transactionsForChart.map(t => new Date(t.date).getFullYear()))].filter(Boolean).sort();
                if (years.length === 0) years.push(new Date().getFullYear());
                labels = years.map(String);
                revenueData = Array(years.length).fill(0);
                expenseData = Array(years.length).fill(0);
                managementFeeData = Array(years.length).fill(0);

                transactionsForChart.forEach(t => {
                    if (t.excludeFromDashboard) return;
                    const tYear = new Date(t.date).getFullYear();
                    const index = years.indexOf(tYear);
                    if (index !== -1) {
                        if (t.type === 'revenue') revenueData[index] += t.amount;
                        else if (t.type === 'expense') expenseData[index] += t.amount;
                        else if (t.type === 'management_fee') managementFeeData[index] += t.amount;
                    }
                });
            }


            if (financialChart) financialChart.destroy();
            financialChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: 'Receitas', data: revenueData, backgroundColor: 'rgba(16, 185, 129, 0.2)', borderColor: 'rgba(16, 185, 129, 1)', borderWidth: 2, tension: 0.1, fill: true }, { label: 'Despesas', data: expenseData, backgroundColor: 'rgba(239, 68, 68, 0.2)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 2, tension: 0.1, fill: true }, { label: 'Taxa de Gerência', data: managementFeeData, backgroundColor: 'rgba(252, 211, 77, 0.2)', borderColor: 'rgba(252, 211, 77, 1)', borderWidth: 2, tension: 0.1, fill: true } ] }, options: { scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } }, responsive: true, maintainAspectRatio: false } });
        };
        
        const applyFiltersAndRender = () => {
    const byNameActive = document.getElementById('filterByNameToggle').checked;
    const byItemActive = document.getElementById('filterByItemToggle').checked;
    const byDescriptionActive = document.getElementById('filterByDescriptionToggle').checked;

    const nameQuery = document.getElementById('filterByName').value.toLowerCase();
    const itemQuery = document.getElementById('filterByItem').value.toLowerCase();
    const descriptionQuery = document.getElementById('filterByDescription').value.toLowerCase();

    const type = document.getElementById('filterType').value;
    const startDate = document.getElementById('filterStartDate').value;

    let filtered = transactions.filter(t => {
        const tDate = new Date(t.date + 'T00:00:00');
        const start = startDate ? new Date(startDate + 'T00:00:00') : null;

        if (type !== 'all' && t.type !== type) return false;
        if (start && tDate < start) return false;

        let nameMatch = !byNameActive || (nameQuery === '');
        let itemMatch = !byItemActive || (itemQuery === '');
        let descriptionMatch = !byDescriptionActive || (descriptionQuery === '');

        if (!nameMatch || !itemMatch || !descriptionMatch) {
            const item = t.itemId ? items.find(i => i.id === t.itemId) : null;

            if (byNameActive && nameQuery !== '') {
                nameMatch = item && item.rentedTo && item.rentedTo.toLowerCase().includes(nameQuery);
            }

            if (byItemActive && itemQuery !== '' && item) {
                const itemNameMatches = item.name.toLowerCase().includes(itemQuery);
                const addressMatches = item.endereco ? item.endereco.toLowerCase().includes(itemQuery) : false;
                itemMatch = itemNameMatches || addressMatches;
            }

            if (byDescriptionActive && descriptionQuery !== '') {
                descriptionMatch = t.description.toLowerCase().includes(descriptionQuery);
            }
        }

        return nameMatch && itemMatch && descriptionMatch;
    });
    renderTransactions(filtered);
};

const initAdvancedFilters = () => {
    const filterToggles = document.querySelectorAll('.filter-toggle');
    const filterInputs = document.querySelectorAll('.filter-input');

    const setupEventListeners = () => {
         filterToggles.forEach(toggle => {
            toggle.addEventListener('change', () => {
                const targetInput = document.getElementById(toggle.dataset.target);
                if (targetInput) {
                    targetInput.classList.toggle('hidden', !toggle.checked);
                    if(!toggle.checked) targetInput.value = '';
                }
                applyFiltersAndRender();
            });
        });

        filterInputs.forEach(input => input.addEventListener('input', applyFiltersAndRender));
        document.getElementById('filterType').addEventListener('input', applyFiltersAndRender);
        document.getElementById('filterStartDate').addEventListener('input', applyFiltersAndRender);

        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            filterToggles.forEach(toggle => {
                toggle.checked = false;
                const targetInput = document.getElementById(toggle.dataset.target);
                if (targetInput) {
                    targetInput.value = '';
                    targetInput.classList.add('hidden');
                }
            });
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterStartDate').value = '';
            applyFiltersAndRender();
        });
    };

    setupEventListeners();
};

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        const formatDate = (dateString) => { if(!dateString) return ''; const date = new Date(dateString); return new Date(date.getTime() + (date.getTimezoneOffset() * 60000)).toLocaleDateString('pt-BR'); };
        const dateToYMD = (date) => date.toISOString().split('T')[0];
        const getTodayDateString = () => dateToYMD(new Date());
        const showModal = (modalId) => document.getElementById(modalId).classList.add('active');
        const hideModal = (modalId) => document.getElementById(modalId).classList.remove('active');
        const autoResizeTextarea = (element) => {
    element.style.height = 'auto'; // Reseta a altura para calcular o novo tamanho
    element.style.height = (element.scrollHeight) + 'px'; // Ajusta a altura para o tamanho do conteúdo
};
const checkAndDisplayDebt = (item) => {
    const debtDisplay = document.getElementById('debtAmountDisplay');
    if (item && item.debt && item.debt.amount > 0) {
        debtDisplay.textContent = `Dívida: ${formatCurrency(item.debt.amount)}`;
        debtDisplay.classList.remove('hidden');
    } else {
        debtDisplay.classList.add('hidden');
    }
};
        const populateTransactionItemSelect = (selectElementId, selectedId) => {
    const select = document.getElementById(selectElementId);
    select.innerHTML = '<option value="">Nenhum / Outra</option>';
    const rentedItems = items.filter(item => item.rentedTo);
    const availableItems = items.filter(item => !item.rentedTo);
    if (rentedItems.length > 0) {
        const rentedGroup = document.createElement('optgroup');
        rentedGroup.label = 'Alugados';
        rentedItems.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;

            // Lógica para formatar o texto da opção
            const itemIdentifier = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
            option.textContent = `${itemIdentifier} - ${item.rentedTo}`;

            rentedGroup.appendChild(option);
        });
        select.appendChild(rentedGroup);
    }
    if (availableItems.length > 0) {
        const availableGroup = document.createElement('optgroup');
        availableGroup.label = 'Disponíveis';
        availableItems.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            const itemIdentifier = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
            option.textContent = itemIdentifier;
            availableGroup.appendChild(option);
        });
        select.appendChild(availableGroup);
    }
    if (selectedId) select.value = selectedId;
};

        const showConfirmModal = (title, message, onConfirmCallback) => {
            document.getElementById('confirmActionTitle').textContent = title;
            document.getElementById('confirmActionMessage').textContent = message;
            onConfirm = onConfirmCallback;
            showModal('confirmActionModal');
        };

        const switchTab = (tabId) => {
            document.querySelectorAll('.tab-button').forEach(btn => {
                const isCorrectTab = btn.dataset.tab === tabId;
                btn.classList.toggle('active-tab', isCorrectTab);
                
                if (btn.closest('#top-nav')) {
                    btn.classList.toggle('border-cyan-500', isCorrectTab);
                    btn.classList.toggle('text-cyan-400', isCorrectTab);
                    btn.classList.toggle('border-transparent', !isCorrectTab);
                    btn.classList.toggle('text-gray-400', !isCorrectTab);
                }
            });
            tabContents.forEach(content => content.classList.add('hidden'));
            const contentToShow = document.getElementById(`${tabId}-content`);
            if (contentToShow) {
                contentToShow.classList.remove('hidden');
            }
        };

        const applyMobileNavSetting = (hideLabels) => {
            const labels = document.querySelectorAll('#bottom-nav .bottom-nav-btn span');
            labels.forEach(label => {
                label.classList.toggle('hidden', hideLabels);
            });
        };

        const toggleRequiredFields = (modalPrefix, isImovel) => {
            const nameInput = document.getElementById(`${modalPrefix}ItemName`);
            const nameLabelAsterisk = nameInput.previousElementSibling.querySelector('span'); // Pega o span no label
            const enderecoInput = document.getElementById(`${modalPrefix}ItemEndereco`);
            const enderecoLabelAsterisk = enderecoInput.previousElementSibling.querySelector('span'); // Pega o span no label

            if (isImovel) {
                nameInput.required = false;
                nameLabelAsterisk.classList.add('hidden'); // Esconde asterisco do nome

                enderecoInput.required = true;
                enderecoLabelAsterisk.classList.remove('hidden'); // Mostra asterisco do endereço
                enderecoInput.closest('div').querySelector('label').textContent = 'Endereço '; // Remove "(Opcional)"
                enderecoInput.closest('div').querySelector('label').appendChild(enderecoLabelAsterisk); // Reanexa o asterisco
            } else {
                nameInput.required = true;
                nameLabelAsterisk.classList.remove('hidden'); // Mostra asterisco do nome

                enderecoInput.required = false;
                enderecoLabelAsterisk.classList.add('hidden'); // Esconde asterisco do endereço
                enderecoInput.closest('div').querySelector('label').textContent = 'Endereço (Opcional) '; // Adiciona "(Opcional)"
                 enderecoInput.closest('div').querySelector('label').appendChild(enderecoLabelAsterisk); // Reanexa o asterisco
            }
        };
        
        const finalizeRental = (itemId) => {
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.rentedTo = null;
                item.rentStartDate = null;
                item.rentEndDate = null;
                item.rentValue = null;
                item.paymentDay = null;
                item.lastPaymentAlertDate = null;
                item.endOfContractNotified = false;
                item.renewalPending = false;
                item.tenantPhone = null;
                item.tenantCPF = null;
                item.paymentsMade = [];
                item.debt = { amount: 0, cycles: 0 };
            }
        };
        
        const initTaxReportFilters = () => {
            const monthSelect = document.getElementById('taxReportMonth');
            const yearSelect = document.getElementById('taxReportYear');
            const now = new Date();
            
            if(monthSelect.options.length === 0){
                for(let i=0; i<12; i++) { 
                    const monthName = new Date(2000, i).toLocaleString('pt-BR', {month: 'long'}); 
                    monthSelect.innerHTML += `<option value="${i}">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</option>`; 
                }
            }
            
            const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))].filter(Boolean);
            if (!years.includes(now.getFullYear())) {
                years.push(now.getFullYear());
            }
            years.sort((a,b) => b-a);
            
            yearSelect.innerHTML = ''; 
            years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);

            monthSelect.value = now.getMonth();
            yearSelect.value = now.getFullYear();
        };

        const generateTaxReport = () => {
            const month = parseInt(document.getElementById('taxReportMonth').value);
            const year = parseInt(document.getElementById('taxReportYear').value);
            const resultDiv = document.getElementById('taxReportResult');
            resultDiv.innerHTML = '';
            let totalNetValue = 0;

            const relevantTransactions = transactions.filter(t => {
                const tDate = new Date(t.date);
                const item = items.find(i => i.id === t.itemId);
                return t.type === 'revenue' && 
                    item && 
                    item.category === 'Imóvel' &&
                    (item.includeInTaxReport === undefined || item.includeInTaxReport === true) &&
                    tDate.getMonth() === month &&
                    tDate.getFullYear() === year;
            });

            if (relevantTransactions.length === 0) {
                resultDiv.innerHTML = '<p class="text-gray-400">Nenhum recebimento de aluguel de imóvel encontrado para este período.</p>';
                return;
            }

            // --- INÍCIO DA LÓGICA MODIFICADA (Mapeamento dos dados) ---
            const reportData = relevantTransactions.map(rev => {
                const item = items.find(i => i.id === rev.itemId);
                
                // Encontra o GESTOR real associado ao item
                const gestor = managers.find(m => m.assignedItemIds.includes(item.id));
                
                let groupKey, groupType;
                if (gestor) {
                    // Se encontrou um gestor, usa o nome dele para agrupar
                    groupKey = `${gestor.name} (Gestor)`; // <-- Corrigido
                    groupType = 'Gestor';
                } else {
                    // Se não, é 'Particular'
                    groupKey = 'Particular';
                    groupType = 'Particular';
                }

                const feeTransaction = transactions.find(t => 
                    t.type === 'management_fee' && 
                    t.date === rev.date && 
                    t.itemId === rev.itemId
                );

                const grossValue = rev.amount;
                const feeValue = feeTransaction ? feeTransaction.amount : 0;
                const netValue = grossValue - feeValue;
                
                totalNetValue += netValue;

                return {
                    groupKey: groupKey,       // <-- Novo campo para agrupar
                    groupType: groupType,     // <-- Novo campo para ordenar
                    tenantName: item.rentedTo,
                    tenantCPF: item.tenantCPF || 'Não informado',
                    address: item.endereco || 'Não informado',
                    grossValue: grossValue,
                    feeValue: feeValue,
                    netValue: netValue,
                    grossValueForCopy: grossValue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                    feeValueForCopy: feeValue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                    netValueForCopy: netValue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                };
            });
            // --- FIM DA LÓGICA MODIFICADA (Mapeamento dos dados) ---


            // --- INÍCIO DA LÓGICA MODIFICADA (Agrupamento) ---
            const groupedData = reportData.reduce((acc, data) => {
                const key = data.groupKey; // <-- Agrupa pela nova 'groupKey'
                if (!acc[key]) {
                    acc[key] = {
                        groupType: data.groupType, // <-- Armazena o tipo para ordenação
                        entries: []
                    };
                }
                acc[key].entries.push(data); // Adiciona a transação ao grupo
                return acc;
            }, {});
            // --- FIM DA LÓGICA MODIFICADA (Agrupamento) ---


            // --- INÍCIO DA LÓGICA MODIFICADA (Ordenação) ---
            const order = { 'Particular': 1, 'Gestor': 2 }; // Define a ordem: Particular primeiro
            const sortedKeys = Object.keys(groupedData).sort((a, b) => {
                const typeA = groupedData[a].groupType; // <-- Pega o tipo do grupo A
                const typeB = groupedData[b].groupType; // <-- Pega o tipo do grupo B
                // Ordena por tipo (Particular > Gestor) e depois alfabeticamente
                return order[typeA] - order[typeB] || a.localeCompare(b); 
            });
            // --- FIM DA LÓGICA MODIFICADA (Ordenação) ---


            let reportHTML = '';
            let copyIdCounter = 0;
            
            // --- INÍCIO DA LÓGICA MODIFICADA (Loop de Renderização) ---
            sortedKeys.forEach(key => {
                // 'key' agora é o nome do grupo (Ex: "Particular" ou "Nome do Gestor (Gestor)")
                reportHTML += `<h3 class="text-xl font-semibold text-cyan-400 mt-6 mb-3 border-b border-gray-700 pb-2">${key}</h3>`; // <-- Corrigido
                
                // Pega as transações de dentro de '.entries'
                groupedData[key].entries.forEach(entry => {
            // --- FIM DA LÓGICA MODIFICADA (Loop de Renderização) ---
            
                    const cpfId = `copy-cpf-${copyIdCounter}`;
                    const addressId = `copy-address-${copyIdCounter}`;
                    const grossValueId = `copy-gross-${copyIdCounter}`;
                    const feeValueId = `copy-fee-${copyIdCounter}`;
                    const netValueId = `copy-net-${copyIdCounter}`;
                    
                    let valuesHTML = '';
                    if (entry.feeValue > 0) {
                        valuesHTML = `
                            <div class="flex items-center gap-3">
                                <p class="text-lg text-gray-300"><strong class="text-gray-400">Valor do Aluguel:</strong> <span>${formatCurrency(entry.grossValue)}</span></p>
                                <span id="${grossValueId}" class="hidden">${entry.grossValueForCopy}</span>
                                <button data-copy-target="${grossValueId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar Valor do Aluguel">
                                    <i data-lucide="copy" class="h-5 w-5"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-3">
                                <p class="text-lg text-gray-300"><strong class="text-gray-400">Taxa de Gerência:</strong> <span>${formatCurrency(entry.feeValue)}</span></p>
                                <span id="${feeValueId}" class="hidden">${entry.feeValueForCopy}</span>
                                <button data-copy-target="${feeValueId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar Taxa de Gerência">
                                    <i data-lucide="copy" class="h-5 w-5"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-3">
                                <p class="text-2xl font-semibold"><strong class="text-gray-400 text-lg">Valor Líquido:</strong> <span class="text-green-400">${formatCurrency(entry.netValue)}</span></p>
                                <span id="${netValueId}" class="hidden">${entry.netValueForCopy}</span>
                                <button data-copy-target="${netValueId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar Valor Líquido">
                                    <i data-lucide="copy" class="h-5 w-5"></i>
                                </button>
                            </div>
                        `; // <-- Corrigido
                    } else {
                        valuesHTML = `
                            <div class="flex items-center gap-3">
                                <p class="text-2xl font-semibold"><strong class="text-gray-400 text-lg">Valor Recebido:</strong> <span class="text-green-400">${formatCurrency(entry.netValue)}</span></p>
                                <span id="${netValueId}" class="hidden">${entry.netValueForCopy}</span>
                                <button data-copy-target="${netValueId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar Valor Recebido">
                                    <i data-lucide="copy" class="h-5 w-5"></i>
                                </button>
                            </div>
                        `; // <-- Corrigido
                    }

                    reportHTML += `
                        <div class="py-6 border-b-2 border-gray-700 space-y-2">
                            <p class="text-2xl font-bold text-white">${entry.tenantName}</p>
                            
                            <div class="flex items-center gap-3">
                                <p class="text-lg text-gray-300"><strong class="text-gray-400">CPF:</strong> <span id="${cpfId}">${entry.tenantCPF}</span></p>
                                <button data-copy-target="${cpfId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar CPF">
                                    <i data-lucide="copy" class="h-5 w-5"></i>
                                </button>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <p class="text-lg text-gray-300" id="${addressId}">${entry.address}</p>
                                <button data-copy-target="${addressId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar Endereço">
                                    <i data-lucide="copy" class="h-5 w-5"></i>
                                </button>
                            </div>

                            ${valuesHTML}
                        </div>
                    `; // <-- Corrigido
                    copyIdCounter++;
                });
            });

            reportHTML += `
                <div class="mt-8 pt-4 border-t-2 border-gray-600 text-right">
                    <p class="text-lg font-medium text-gray-300">Soma Total Líquida do Mês:</p>
                    <p class="text-3xl font-bold text-green-400">${formatCurrency(totalNetValue)}</p>
                </div>
            `; // <-- Corrigido
            
            resultDiv.innerHTML = reportHTML;
            lucide.createIcons();
        };
        
        // --- Handlers para Eventos ---
        document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', () => autoResizeTextarea(textarea));
});
        document.body.addEventListener('click', (e) => { 
            
            const iptuButton = e.target.closest('.iptu-btn');
            if (iptuButton) {
                const itemId = parseInt(iptuButton.dataset.id);
                const item = items.find(i => i.id === itemId);
                const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;

                const action = () => { // Ação a ser executada
                    const currentYear = new Date().getFullYear();
                    if (item) {
                        // Verifica se JÁ EXISTE IPTU registrado para o ano atual
                        if (item.iptu && item.iptu[currentYear]) {
                            const iptuData = item.iptu[currentYear];

                            // Calcula o valor da parcela
                            const installmentValue = iptuData.installments > 0 ? (iptuData.totalValue / iptuData.installments) : 0;

                            // Preenche o modal de GERENCIAMENTO
                            document.getElementById('manageIptuModalTitle').textContent = `Gerenciar IPTU ${currentYear} - ${displayName}`;
                            document.getElementById('manageIptuItemId').value = item.id;
                            document.getElementById('manageIptuYear').value = currentYear;
                            // Preenche com o VALOR DA PARCELA calculado
                            document.getElementById('manageIptuInstallmentValue').value = installmentValue.toFixed(2);
                            document.getElementById('manageIptuInstallments').value = iptuData.installments;
                            document.getElementById('manageIptuPaidInstallments').textContent = `${iptuData.paidInstallments} de ${iptuData.installments}`;
                            document.getElementById('manageIptuWarning').classList.add('hidden');

                            // Mostra o modal de GERENCIAMENTO
                            showModal('manageIptuModal');

                        } else {
                            // Se NÃO EXISTE, abre o modal de REGISTRO (comportamento antigo)
                            iptuForm.reset();
                            document.getElementById('iptuItemId').value = item.id;
                            document.getElementById('iptuModalTitle').textContent = `Registrar IPTU ${currentYear} para: ${displayName}`;
                            showModal('iptuModal');
                        }
                    }
                };
                
                // --- MODIFICADO AQUI ---
                if (settings.managedItemWarningEnabled && isItemManagedByGestor(itemId)) { // Verifica se é gerenciado E se a configuração está LIGADA
                    showConfirmModal('Item Gerenciado', 'Este item é gerenciado por um gestor. Alterar o IPTU pode afetar o painel do gestor. Deseja continuar?', action);
                } else {
                    action(); // Executa direto
                }
            }
            
            // --- Lógica para Gerenciamento de Dívida ---
            const manageDebtButton = e.target.closest('.manage-debt-btn');
            if (manageDebtButton) {
                const itemId = parseInt(manageDebtButton.dataset.id);
                const item = items.find(i => i.id === itemId);
                
                const action = () => { // Ação
                    if (item) {
                        document.getElementById('debtActionsItemId').value = item.id;
                        const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
                        document.getElementById('debtActionsInfo').textContent = `Item: ${displayName}`;
                        showModal('debtActionsModal');
                    }
                };

                // --- MODIFICADO AQUI ---
                if (settings.managedItemWarningEnabled && isItemManagedByGestor(itemId)) { // Verificação
                    showConfirmModal('Item Gerenciado', 'Este item é gerenciado por um gestor. Gerenciar a dívida pode afetar o painel do gestor. Deseja continuar?', action);
                } else {
                    action(); // Executa direto
                }
            }

            // Abre o modal para editar o valor da dívida
            const openEditDebtModalButton = e.target.closest('#openEditDebtModalBtn');
            if (openEditDebtModalButton) {
                const itemId = parseInt(document.getElementById('debtActionsItemId').value);
                const item = items.find(i => i.id === itemId);
                if (item && item.debt) {
                    hideModal('debtActionsModal');
                    document.getElementById('editDebtItemId').value = item.id;
                    document.getElementById('newDebtAmount').value = item.debt.amount.toFixed(2);
                    showModal('editDebtModal');
                }
            }

            // Apaga a dívida após confirmação
            const deleteDebtButton = e.target.closest('#deleteDebtBtn');
            if (deleteDebtButton) {
                const itemId = parseInt(document.getElementById('debtActionsItemId').value);
                hideModal('debtActionsModal');
                showConfirmModal('Apagar Dívida', 'Você tem certeza que deseja apagar a dívida deste item?', () => {
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        item.debt.amount = 0;
                        saveData();
                        renderAll();
                    }
                });
            }

            // --- Fim da Lógica de Gerenciamento de Dívida ---

            const copyButton = e.target.closest('.copy-btn');
            if (copyButton) {
                const targetId = copyButton.dataset.copyTarget;
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    const textToCopy = targetElement.textContent.trim();
                    
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    textArea.style.position = "fixed"; 
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        copyButton.innerHTML = '<i data-lucide="check" class="h-5 w-5 text-green-400"></i>';
                        lucide.createIcons();
                        setTimeout(() => {
                            copyButton.innerHTML = '<i data-lucide="copy" class="h-5 w-5"></i>';
                            lucide.createIcons();
                        }, 1500);
                    } catch (err) {
                        console.error('Falha ao copiar texto: ', err);
                    }

                    document.body.removeChild(textArea);
                }
            }

            const deleteManagerBtn = e.target.closest('.delete-manager-btn');
            if (deleteManagerBtn) {
                const managerId = parseInt(deleteManagerBtn.dataset.id);
                const manager = managers.find(m => m.id === managerId);
                if(manager) {
                    showConfirmModal('Excluir Gestor', `Você tem certeza que deseja excluir o gestor "${manager.name}"?`, () => {
                        managers = managers.filter(m => m.id !== managerId);
                        saveData();
                        renderAll();
                    });
                }
            }

            const editManagerBtn = e.target.closest('.edit-manager-btn');
            if(editManagerBtn) {
                const managerId = parseInt(editManagerBtn.dataset.id);
                const manager = managers.find(m => m.id === managerId);
                if(manager) {
                    document.getElementById('managerModalTitle').textContent = 'Editar Gestor';
                    document.getElementById('managerId').value = manager.id;
                    document.getElementById('managerType').value = manager.type;
                    document.getElementById('managerName').value = manager.name;
                    document.getElementById('managerPassword').value = manager.password;

                    const rentalsListDiv = document.getElementById('managerRentalsList');
                    rentalsListDiv.innerHTML = '';
                    const allItems = items;

                    // Cria um conjunto de IDs de itens gerenciados por OUTROS gestores
                    const otherAssignedItemIds = new Set();
                    managers.forEach(m => {
                        if (m.id !== manager.id) { // Importante: ignora o gestor que estamos editando
                            m.assignedItemIds.forEach(id => otherAssignedItemIds.add(id));
                        }
                    });

                    if (allItems.length === 0) {
                        rentalsListDiv.innerHTML = '<p class="text-gray-400">Nenhum item cadastrado para associar.</p>';
                    } else {
                        allItems.forEach(item => {
                            const checkboxId = `manager-item-edit-${item.id}`;
                            const isChecked = manager.assignedItemIds.includes(item.id);

                            const isManagedByOther = otherAssignedItemIds.has(item.id);
                            const isDisabled = isManagedByOther ? 'disabled' : '';
                            const cursorClass = isManagedByOther ? 'cursor-not-allowed' : 'cursor-pointer hover:bg-gray-600/50';

                            const label = document.createElement('label');
                            label.htmlFor = checkboxId;
                            label.className = `flex items-center space-x-3 p-2 rounded-md ${cursorClass}`;

                            let statusText = item.rentedTo ? `(Alugado para: ${item.rentedTo})` : '(Disponível)';
                            if(isManagedByOther) {
                                const managingManager = managers.find(m => m.assignedItemIds.includes(item.id));
                                statusText = `(Gerenciado por: ${managingManager.name})`;
                            }

                            label.innerHTML = `
                                <input type="checkbox" id="${checkboxId}" value="${item.id}" name="assignedItems" class="h-4 w-4 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600" ${isChecked ? 'checked' : ''} ${isDisabled}>
                                <span>${(item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name} <span class="text-xs ${isManagedByOther ? 'text-yellow-400' : 'text-gray-400'}">${statusText}</span></span>
                            `;
                            rentalsListDiv.appendChild(label);
                        });
                    }
                    showModal('managerModal');
                }
            }
        });

        appContainer.addEventListener('click', (e) => {
            const rentButton = e.target.closest('.rent-btn');
            if (rentButton) {
                const itemId = parseInt(rentButton.dataset.id);
                const item = items.find(i => i.id === itemId);
                
                const action = () => { // Ação
                    rentItemForm.reset();
                    document.getElementById('rentModalTitle').textContent = "Registrar Aluguel";
                    document.getElementById('rentItemId').value = item.id;
                    document.getElementById('rentValue').value = item.value;
                    document.getElementById('rentStartDate').value = getTodayDateString();
                    showModal('rentItemModal');
                };

                // --- MODIFICADO AQUI ---
                if (settings.managedItemWarningEnabled && isItemManagedByGestor(itemId)) { // Verificação
                    showConfirmModal('Item Gerenciado', 'Este item é gerenciado por um gestor. Alugar este item pode afetar o painel do gestor. Deseja continuar?', action);
                } else {
                    action();
                }
            }

            const addRevenueButton = e.target.closest('.add-revenue-btn');
            if (addRevenueButton) {
                const itemId = parseInt(addRevenueButton.dataset.id);
                const item = items.find(i => i.id === itemId);
                
                const action = () => { // Ação
                    switchTab('finance');
                    
                    document.getElementById('transactionModalTitle').textContent = 'Adicionar Receita';
                    document.getElementById('transactionType').value = 'revenue';
                    document.getElementById('managementFeeContainer').style.display = 'block';
                    addTransactionForm.reset();
                    document.getElementById('transactionDate').value = getTodayDateString();
                    populateTransactionItemSelect('transactionItemLink', item.id);
                    const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
                    document.getElementById('transactionDescription').value = `Recebimento aluguel: ${displayName}`;
                    document.getElementById('transactionAmount').value = item.rentValue;
                    checkAndDisplayDebt(item);
                    
                    if (item.hasManagementFee && item.managementFeePercentage > 0) {
                        const feeCheckbox = document.getElementById('addManagementFee');
                        const feeDiv = document.getElementById('managementFeeDiv');
                        const feeAmountInput = document.getElementById('managementFeeAmount');
                        const fee = item.rentValue * (item.managementFeePercentage / 100);

                        feeCheckbox.checked = true;
                        feeDiv.classList.remove('hidden');
                        feeAmountInput.value = fee.toFixed(2);
                    }

                    // --- INÍCIO: Verificação Automática de IPTU ao Abrir Modal ---
                    const preselectedItemId = document.getElementById('transactionItemLink').value;
                    if (preselectedItemId) {
                        const preselectedItem = items.find(i => i.id === parseInt(preselectedItemId));
                        const currentYear = new Date().getFullYear();
                        const autoIptuContainer = document.getElementById('autoIptuContainer');
                        const autoIptuCheckbox = document.getElementById('autoIptuCheckbox');
                        const autoIptuLabel = document.getElementById('autoIptuLabel');

                        // Garante que o checkbox está resetado antes de verificar
                        autoIptuContainer.classList.add('hidden');
                        autoIptuCheckbox.checked = false;
                        autoIptuCheckbox.dataset.iptuValue = 0;
                        autoIptuLabel.textContent = '';

                        // Verifica se é Imóvel com IPTU pendente
                        if (preselectedItem && preselectedItem.category === 'Imóvel' && preselectedItem.iptu && preselectedItem.iptu[currentYear] && preselectedItem.iptu[currentYear].paidInstallments < preselectedItem.iptu[currentYear].installments) {
                            const iptuData = preselectedItem.iptu[currentYear];
                            const installmentValue = iptuData.totalValue / iptuData.installments;

                            // Configura e exibe o checkbox
                            autoIptuLabel.textContent = `Adicionar 1 parcela IPTU (${iptuData.paidInstallments + 1}/${iptuData.installments}) - ${formatCurrency(installmentValue)}`;
                            autoIptuCheckbox.dataset.iptuValue = installmentValue;
                            autoIptuContainer.classList.remove('hidden');
                        }
                    }
                    
                    showModal('addTransactionModal');
                };

                // --- MODIFICADO AQUI ---
                if (settings.managedItemWarningEnabled && isItemManagedByGestor(itemId)) { // Verificação
                    showConfirmModal('Item Gerenciado', 'Este item é gerenciado por um gestor. Adicionar receita pode afetar o painel do gestor. Deseja continuar?', action);
                } else {
                    action();
                }
            }

            // --- INÍCIO: Listener para o botão "Pagar IPTU" (Item Disponível) ---
            const payIptuExpenseButton = e.target.closest('.pay-iptu-expense-btn');
            if (payIptuExpenseButton) {
                const itemId = parseInt(payIptuExpenseButton.dataset.id);
                const item = items.find(i => i.id === itemId);

                const action = () => { // Ação
                    const currentYear = new Date().getFullYear();

                    if (item && item.iptu && item.iptu[currentYear]) {
                        const iptuData = item.iptu[currentYear];
                        if (iptuData.paidInstallments < iptuData.installments) {
                            const installmentValue = iptuData.installments > 0 ? (iptuData.totalValue / iptuData.installments) : 0;

                            // Abre o modal de transação configurado para despesa de IPTU
                            document.getElementById('transactionModalTitle').textContent = 'Registrar Pagamento IPTU';
                            document.getElementById('transactionType').value = 'expense'; // Define como Despesa
                            document.getElementById('managementFeeContainer').style.display = 'none'; // Esconde taxa
                            addTransactionForm.reset(); // Limpa o formulário
                            document.getElementById('transactionDate').value = getTodayDateString(); // Data atual
                            populateTransactionItemSelect('transactionItemLink', item.id); // Seleciona o item
                            // Preenche descrição e valor
                            const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
                            document.getElementById('transactionDescription').value = `Pagamento IPTU ${currentYear} (${iptuData.paidInstallments + 1}/${iptuData.installments}) - ${displayName}`;
                            document.getElementById('transactionAmount').value = installmentValue.toFixed(2);
                            // Define a flag oculta
                            document.getElementById('isDirectIptuPayment').value = 'true';

                            // Esconde campos irrelevantes que possam ter ficado visíveis
                            document.getElementById('debtAmountDisplay').classList.add('hidden');
                            document.getElementById('debtInfoContainer').classList.add('hidden');
                            document.getElementById('autoIptuContainer').classList.add('hidden');

                            showModal('addTransactionModal');
                        } else {
                            alert("IPTU já está pago para este ano."); // Caso o botão apareça por erro
                        }
                    }
                };

                // --- MODIFICADO AQUI ---
                if (settings.managedItemWarningEnabled && isItemManagedByGestor(itemId)) { // Verificação
                     showConfirmModal('Item Gerenciado', 'Este item é gerenciado por um gestor. Pagar o IPTU pode afetar o painel do gestor. Deseja continuar?', action);
                } else {
                    action();
                }
            }
            
            const editRentButton = e.target.closest('.edit-rent-btn');
            if (editRentButton) {
                const itemId = parseInt(editRentButton.dataset.id);
                const item = items.find(i => i.id === itemId);

                const action = () => { // Ação
                    document.getElementById('rentModalTitle').textContent = "Editar Aluguel";
                    document.getElementById('rentItemId').value = item.id;
                    document.getElementById('tenantName').value = item.rentedTo; document.getElementById('tenantPhone').value = item.tenantPhone || ''; document.getElementById('tenantCPF').value = item.tenantCPF || '';
                    document.getElementById('rentStartDate').value = item.rentStartDate; document.getElementById('rentEndDate').value = item.rentEndDate; document.getElementById('rentValue').value = item.rentValue; document.getElementById('paymentDay').value = item.paymentDay;
                    showModal('rentItemModal');
                };

                // --- MODIFICADO AQUI ---
                if (settings.managedItemWarningEnabled && isItemManagedByGestor(itemId)) { // Verificação
                    showConfirmModal('Item Gerenciado', 'Este item é gerenciado por um gestor. Editar o aluguel pode afetar o painel do gestor. Deseja continuar?', action);
                } else {
                    action();
                }
            }
            
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const itemId = parseInt(deleteButton.dataset.id);
                const item = items.find(i => i.id === itemId);

                // --- MODIFICADO AQUI ---
                const isManaged = settings.managedItemWarningEnabled && isItemManagedByGestor(itemId);
                const warningTitle = isManaged ? " (Item Gerenciado)" : "";
                const warningMsg = isManaged ? " Esta ação também pode afetar o painel do gestor." : "";
                // --- FIM DA MODIFICAÇÃO ---

                if (item.rentedTo) {
                    showConfirmModal('Finalizar Aluguel' + warningTitle, `Isso irá finalizar o aluguel do item "${(item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name}" e o tornará disponível.${warningMsg} Deseja continuar?`, () => {
                        finalizeRental(itemId);
                        saveData();
                        renderAll();
                    });
                } else {
                    showConfirmModal('Apagar Item' + warningTitle, `Você tem certeza que deseja apagar o item "${(item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name}"?${warningMsg} Esta ação não pode ser desfeita.`, () => {
                        items = items.filter(i => i.id !== itemId);
                        // Also remove from any manager
                        managers.forEach(m => {
                            m.assignedItemIds = m.assignedItemIds.filter(id => id !== itemId);
                        });
                        saveData();
                        renderAll();
                    });
                }
            }
            
            const editItemButton = e.target.closest('.edit-item-btn');
            if (editItemButton) {
                const itemId = parseInt(editItemButton.dataset.id);
                const item = items.find(i => i.id === itemId);

                const action = () => { // Ação
                    document.getElementById('editItemId').value = item.id;
                    document.getElementById('editItemName').value = item.name; document.getElementById('editItemDescription').value = item.description;
                    
                    const editDescriptionTextarea = document.getElementById('editItemDescription'); // Pega o textarea
                    setTimeout(() => autoResizeTextarea(editDescriptionTextarea), 0); // Ajusta o tamanho
                    
                    document.getElementById('editItemValue').value = item.value; document.getElementById('editItemPaymentFrequency').value = item.paymentFrequency;
                    const categorySelect = document.getElementById('editItemCategorySelect');
                    const otherWrapper = document.getElementById('editItemCategoryOtherWrapper'); const otherInput = document.getElementById('editItemCategoryOther'); const imovelWrapper = document.getElementById('editImovelFieldsWrapper');
                    const predefinedCategories = Array.from(categorySelect.options).map(opt => opt.value);
                    if (predefinedCategories.includes(item.category) && item.category !== 'outro') { categorySelect.value = item.category; otherWrapper.classList.add('hidden'); } 
                    else { categorySelect.value = 'outro'; otherInput.value = item.category; otherWrapper.classList.remove('hidden'); }
                    
                    const isImovel = categorySelect.value === 'Imóvel';
                    imovelWrapper.classList.toggle('hidden', !isImovel);
                    if(isImovel) { 
                        document.getElementById('editItemEndereco').value = item.endereco || ''; 
                        document.getElementById('editItemCep').value = item.cep || ''; 
                        const managedBySelect = document.getElementById('editItemManagedBy');
                        const managerNameWrapper = document.getElementById('editItemManagerName').parentElement;
                        const feeWrapper = document.getElementById('editItemHasManagementFee').parentElement.parentElement;
                        const feeCheckbox = document.getElementById('editItemHasManagementFee');
                        const feePercentageWrapper = document.getElementById('editItemManagementFeePercentage').parentElement;

                        managedBySelect.value = item.managedBy || 'particular';
                        const showManagerFields = managedBySelect.value === 'imobiliaria' || managedBySelect.value === 'outros';
                        managerNameWrapper.classList.toggle('hidden', !showManagerFields);
                        feeWrapper.classList.toggle('hidden', !showManagerFields);

                        if (showManagerFields) {
                            document.getElementById('editItemManagerName').value = item.managerName || '';
                            feeCheckbox.checked = item.hasManagementFee || false;
                            feePercentageWrapper.classList.toggle('hidden', !feeCheckbox.checked);
                            if (feeCheckbox.checked) {
                                document.getElementById('editItemManagementFeePercentage').value = item.managementFeePercentage || 10;
                            }
                        }
                    }
                    document.getElementById('editItemIncludeInTaxReport').checked = (item.includeInTaxReport === undefined || item.includeInTaxReport === true);
                    toggleRequiredFields('editItem', isImovel);
                    showModal('editItemModal');
                };

                // --- MODIFICADO AQUI ---
                if (settings.managedItemWarningEnabled && isItemManagedByGestor(itemId)) { // Verificação
                    showConfirmModal('Item Gerenciado', 'Este item é gerenciado por um gestor. Editar os dados do item pode afetar o painel do gestor. Deseja continuar?', action);
                } else {
                    action();
                }
            }
            
            const editTransactionButton = e.target.closest('.edit-transaction-btn');
            if (editTransactionButton) {
                const transactionId = parseInt(editTransactionButton.dataset.id);
                const transaction = transactions.find(t => t.id === transactionId);
                
                const action = () => { // Ação
                    document.getElementById('editTransactionId').value = transaction.id;
                    document.getElementById('editTransactionDescription').value = transaction.description;
                    document.getElementById('editTransactionAmount').value = transaction.amount;
                    document.getElementById('editTransactionDate').value = transaction.date;
                    showModal('editTransactionModal');
                };

                // --- MODIFICADO AQUI ---
                if (settings.managedItemWarningEnabled && transaction.itemId && isItemManagedByGestor(transaction.itemId)) { // Verificação
                    showConfirmModal('Item Gerenciado', 'Esta transação é de um item gerenciado. Alterá-la pode afetar o balanço do gestor. Deseja continuar?', action);
                } else {
                    action();
                }
            }

            const deleteTransactionButton = e.target.closest('.delete-transaction-btn');
            if (deleteTransactionButton) {
                const transactionId = parseInt(deleteTransactionButton.dataset.id);
                const transaction = transactions.find(t => t.id === transactionId);
                if (!transaction) return;

                // --- MODIFICADO AQUI ---
                const isManaged = settings.managedItemWarningEnabled && transaction.itemId && isItemManagedByGestor(transaction.itemId);
                const warningTitle = isManaged ? " (Item Gerenciado)" : "";
                const warningMsg = isManaged ? " Esta ação também pode afetar o balanço do gestor." : "";
                // --- FIM DA MODIFICAÇÃO ---

                showConfirmModal('Excluir Transação' + warningTitle, `Você tem certeza que deseja excluir a transação "${transaction.description}"?${warningMsg}`, () => {
                    const txToDelete = transactions.find(t => t.id === transactionId);

                    // --- INÍCIO: LÓGICA PARA REVERTER CONTAGEM DE IPTU (ADICIONADA) ---
                    if (txToDelete && txToDelete.type === 'expense' && txToDelete.itemId && txToDelete.description.startsWith('Pagamento IPTU')) {
                        const item = items.find(i => i.id === txToDelete.itemId);
                        // Extrai o ano da descrição da transação (ex: "Pagamento IPTU 2025 (1/6) - Nome Item")
                        const yearMatch = txToDelete.description.match(/IPTU (\d{4})/);
                        if (item && yearMatch) {
                            const year = parseInt(yearMatch[1], 10);
                            // Verifica se existe IPTU para aquele ano e se há parcelas pagas para decrementar
                            if (item.iptu && item.iptu[year] && item.iptu[year].paidInstallments > 0) {
                                item.iptu[year].paidInstallments -= 1; // Decrementa o contador
                            }
                        }
                    }
                    // --- FIM: LÓGICA PARA REVERTER CONTAGEM DE IPTU ---

                    // --- Lógica existente para reverter dívida/pagamento (mantida) ---
                    if (txToDelete && txToDelete.type === 'revenue' && txToDelete.itemId) {
                        const item = items.find(i => i.id === txToDelete.itemId);
                        if (item && item.rentedTo) {

                            const transactionDate = new Date(txToDelete.date + 'T00:00:00');
                            const paymentPeriod = `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}`;

                            const otherPaymentsInPeriod = transactions.filter(t =>
                                t.id !== txToDelete.id &&
                                t.itemId === txToDelete.itemId &&
                                t.type === 'revenue' &&
                                `${new Date(t.date + 'T00:00:00').getFullYear()}-${String(new Date(t.date + 'T00:00:00').getMonth() + 1).padStart(2, '0')}` === paymentPeriod
                            );

                            // Reverte o cálculo da dívida (se aplicável)
                            if (item.debt) {
                                const amountDeleted = txToDelete.amount;
                                const rentValue = item.rentValue;
                                const difference = rentValue - amountDeleted;

                                // Se o pagamento apagado era parcial e gerou uma dívida
                                if (difference > 0) {
                                    item.debt.amount -= difference;

                                    // LÓGICA CORRIGIDA: Só decrementa o ciclo se este for o único pagamento do período
                                    if (otherPaymentsInPeriod.length === 0) {
                                        if (item.debt.cycles > 0) {
                                            item.debt.cycles -= 1;
                                        }
                                    }
                                }
                                // Se o pagamento apagado era maior e abateu uma dívida
                                else if (difference < 0) {
                                    const surplus = -difference;
                                    item.debt.amount += surplus;
                                    // Se ao restaurar a dívida, ela volta a existir, e não havia ciclo, adiciona um.
                                    if (item.debt.amount > 0 && item.debt.cycles === 0) {
                                        item.debt.cycles = 1;
                                    }
                                }

                                if (item.debt.amount < 0.01) {
                                    item.debt.amount = 0;
                                    item.debt.cycles = 0; // Zera os ciclos se a dívida for zerada
                                }
                            }

                            // Se não houver outros pagamentos, desmarca o mês como "pago".
                            if (otherPaymentsInPeriod.length === 0 && item.paymentsMade) {
                                const index = item.paymentsMade.indexOf(paymentPeriod);
                                if (index > -1) {
                                    item.paymentsMade.splice(index, 1);
                                }
                            }
                        }
                    }
                    // --- Fim da lógica existente ---

                    // Remove a transação da lista
                    transactions = transactions.filter(t => t.id !== transactionId);

                    saveData();
                    renderAll();
                });
            }
            
            const resolvePaymentBtn = e.target.closest('.resolve-payment-btn');
            if(resolvePaymentBtn) {
                const itemId = parseInt(resolvePaymentBtn.dataset.id);
                const item = items.find(i => i.id === itemId);

                const action = () => { // Ação
                    document.getElementById('paymentAlertItemId').value = item.id;
                    const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
                    document.getElementById('paymentAlertItemName').textContent = displayName;
                    showModal('paymentAlertModal');
                };

                // Verificação (alertas SÓ aparecem para itens alugados, que podem ser gerenciados)
                // --- MODIFICADO AQUI ---
                if (settings.managedItemWarningEnabled && isItemManagedByGestor(itemId)) { 
                    showConfirmModal('Item Gerenciado', 'Este item é gerenciado. Resolver este alerta pode afetar o painel do gestor. Deseja continuar?', action);
                } else {
                    action();
                }
            }
            
            const resolveContractEndBtn = e.target.closest('.resolve-contract-end-btn');
            if(resolveContractEndBtn) {
                const itemId = parseInt(resolveContractEndBtn.dataset.id);
                const item = items.find(i => i.id === itemId);
                
                const action = () => { // Ação
                    document.getElementById('contractEndItemId').value = item.id;
                    const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
                    document.getElementById('contractEndItemName').textContent = displayName;
                    showModal('contractEndModal');
                };
                
                // --- MODIFICADO AQUI ---
                if (settings.managedItemWarningEnabled && isItemManagedByGestor(itemId)) { // Verificação
                    showConfirmModal('Item Gerenciado', 'Este item é gerenciado. Resolver este alerta de contrato pode afetar o painel do gestor. Deseja continuar?', action);
                } else {
                    action();
                }
            }
        });

        tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
        document.getElementById('openAddItemModal').addEventListener('click', () => { addItemForm.reset(); document.getElementById('itemCategorySelect').value = ""; document.getElementById('imovelFieldsWrapper').classList.add('hidden'); document.getElementById('itemCategoryOtherWrapper').classList.add('hidden'); toggleRequiredFields('item', false); showModal('addItemModal'); });
        document.getElementById('openAddTransactionModalRevenue').addEventListener('click', () => { document.getElementById('transactionModalTitle').textContent = 'Adicionar Receita'; document.getElementById('transactionType').value = 'revenue'; document.getElementById('managementFeeContainer').style.display = 'block'; addTransactionForm.reset(); document.getElementById('transactionDate').value = getTodayDateString(); populateTransactionItemSelect('transactionItemLink'); showModal('addTransactionModal'); });
        document.getElementById('openAddTransactionModalExpense').addEventListener('click', () => { document.getElementById('transactionModalTitle').textContent = 'Adicionar Despesa'; document.getElementById('transactionType').value = 'expense'; document.getElementById('managementFeeContainer').style.display = 'none'; addTransactionForm.reset(); document.getElementById('transactionDate').value = getTodayDateString(); populateTransactionItemSelect('transactionItemLink'); showModal('addTransactionModal'); });
        document.getElementById('openTaxReportModal').addEventListener('click', () => { initTaxReportFilters(); showModal('taxReportModal'); });
        document.getElementById('generateTaxReportBtn').addEventListener('click', generateTaxReport);
        modals.forEach(modal => { 
            modal.addEventListener('click', (e) => { 
                if (e.target.classList.contains('modal') || e.target.closest('.modal-close-btn')) {
                    hideModal(modal.id);
                }
            }); 
        });
        
        document.getElementById('itemCategorySelect').addEventListener('change', (e) => {
            const isImovel = e.target.value === 'Imóvel'; // <-- Verifica se é Imóvel
            document.getElementById('itemCategoryOtherWrapper').classList.toggle('hidden', e.target.value !== 'outro');
            document.getElementById('imovelFieldsWrapper').classList.toggle('hidden', !isImovel);
            toggleRequiredFields('item', isImovel); // <-- CHAMA A NOVA FUNÇÃO
        });

        
        document.getElementById('editItemCategorySelect').addEventListener('change', (e) => {
            const isImovel = e.target.value === 'Imóvel'; // <-- Verifica se é Imóvel
            document.getElementById('editItemCategoryOtherWrapper').classList.toggle('hidden', e.target.value !== 'outro');
            document.getElementById('editImovelFieldsWrapper').classList.toggle('hidden', !isImovel);
            toggleRequiredFields('editItem', isImovel); // <-- CHAMA A NOVA FUNÇÃO
        });

        document.querySelectorAll('.itemManagedBySelect').forEach(select => { select.addEventListener('change', (e) => { const wrapper = e.target.closest('form').querySelector('.itemManagerNameWrapper'); const feeWrapper = e.target.closest('form').querySelector('.itemFeeWrapper'); const show = e.target.value === 'imobiliaria' || e.target.value === 'outros'; wrapper.classList.toggle('hidden', !show); feeWrapper.classList.toggle('hidden', !show);}); });
        document.querySelectorAll('input[type="checkbox"][id$="HasManagementFee"]').forEach(checkbox => { checkbox.addEventListener('change', (e) => { const wrapper = e.target.closest('.itemFeeWrapper').querySelector('.itemFeePercentageWrapper'); wrapper.classList.toggle('hidden', !e.target.checked); }); });
        

        document.getElementById('addTransactionModal').addEventListener('change', (e) => {
    // --- INÍCIO DO CÓDIGO CORRIGIDO PARA SUBSTITUIR ---

    // Lógica existente para a taxa de gerência (não mexer)
    if (e.target.id === 'addManagementFee') {
        document.getElementById('managementFeeDiv').classList.toggle('hidden', !e.target.checked);
        return; // Sai da função se foi só o checkbox da taxa
    }

    // Lógica principal quando o ITEM selecionado muda
    if (e.target.id === 'transactionItemLink') {
        const itemId = e.target.value;
        const debtDisplay = document.getElementById('debtAmountDisplay');
        const transactionAmountInput = document.getElementById('transactionAmount'); // Input do valor

        // --- Resetar campos antes de verificar o novo item ---
        debtDisplay.classList.add('hidden'); // Esconde display de dívida
        const autoIptuContainer = document.getElementById('autoIptuContainer');
        const autoIptuCheckbox = document.getElementById('autoIptuCheckbox');
        const autoIptuLabel = document.getElementById('autoIptuLabel');

        // Garante que o checkbox IPTU está desmarcado e esconde
        if(autoIptuCheckbox.checked) {
             autoIptuCheckbox.checked = false;
             // Não precisa disparar o 'change' aqui, pois o valor será resetado abaixo
        }
        autoIptuContainer.classList.add('hidden');
        autoIptuCheckbox.dataset.iptuValue = 0;
        autoIptuLabel.textContent = '';


        // --- Lógica se um item FOI selecionado ---
        if (itemId) {
            const item = items.find(i => i.id === parseInt(itemId));
            if (item) {
                // Atualiza o valor padrão da transação
                transactionAmountInput.value = item.rentedTo ? item.rentValue.toFixed(2) : item.value.toFixed(2); // Usa toFixed(2) para garantir formato
                // Verifica e mostra a dívida existente
                checkAndDisplayDebt(item);

                // Verifica se mostra a opção de IPTU
                const currentYear = new Date().getFullYear();
                if (item.category === 'Imóvel' && item.iptu && item.iptu[currentYear] && item.iptu[currentYear].paidInstallments < item.iptu[currentYear].installments) {
                    const iptuData = item.iptu[currentYear];
                    const installmentValue = iptuData.totalValue / iptuData.installments;

                    autoIptuLabel.textContent = `Adicionar 1 parcela IPTU (${iptuData.paidInstallments + 1}/${iptuData.installments}) - ${formatCurrency(installmentValue)}`;
                    autoIptuCheckbox.dataset.iptuValue = installmentValue;
                    autoIptuContainer.classList.remove('hidden');
                }
            } else {
                // Caso o item ID exista mas não seja encontrado (improvável, mas seguro)
                transactionAmountInput.value = '';
            }
        }
        // --- Lógica se NENHUM item foi selecionado ("Nenhum / Outra") ---
        else {
            transactionAmountInput.value = ''; // Limpa o valor
        }
    } // Fim do if (e.target.id === 'transactionItemLink')

    // --- FIM DO CÓDIGO CORRIGIDO PARA SUBSTITUIR ---
});

// Adiciona o listener para o botão de perdoar dívida
document.getElementById('forgiveDebtBtn').addEventListener('click', () => {
    const itemId = document.getElementById('transactionItemLink').value;
    if (!itemId) return; // Não faz nada se nenhum item estiver selecionado

    // Pede confirmação ao usuário
    showConfirmModal('Perdoar Dívida', 'Você tem certeza que deseja zerar a dívida deste item? Esta ação não pode ser desfeita.', () => {
        const item = items.find(i => i.id === parseInt(itemId));
        if (item) {
           item.debt = { amount: 0, cycles: 0 }; // Zera a dívida
            saveData();
            renderAll(); // Atualiza toda a interface
            document.getElementById('debtInfoContainer').classList.add('hidden'); // Esconde o campo no modal
        }
    });
});


        document.getElementById('setTenPercentFeeBtn').addEventListener('click', () => {
            // 1. Pega o valor total que está no campo "Valor (R$)"
            const totalInField = parseFloat(document.getElementById('transactionAmount').value) || 0;
            
            // 2. Pega o checkbox do IPTU
            const iptuCheckbox = document.getElementById('autoIptuCheckbox');
            
            let rentValue = totalInField; // Por padrão, o valor do aluguel é o valor total

            // 3. Verifica se o checkbox de IPTU está MARCADO
            if (iptuCheckbox.checked) {
                // Se estiver marcado, pega o valor da parcela do IPTU guardado no 'dataset'
                const iptuValue = parseFloat(iptuCheckbox.dataset.iptuValue) || 0;
                
                // 4. Subtrai o valor do IPTU do total, para termos apenas o valor do aluguel
                rentValue = totalInField - iptuValue;
            }

            // 5. Calcula 10% APENAS sobre o valor do aluguel (rentValue)
            //    (Também garante que o valor não seja negativo)
            if (rentValue > 0) {
                document.getElementById('managementFeeAmount').value = (rentValue * 0.10).toFixed(2);
            } else {
                document.getElementById('managementFeeAmount').value = '0.00';
            }
        });        

        document.getElementById('setOneYearBtn').addEventListener('click', () => { const startDateInput = document.getElementById('rentStartDate'); if(startDateInput.value) { const startDate = new Date(startDateInput.value + "T00:00:00"); startDate.setFullYear(startDate.getFullYear() + 1); document.getElementById('rentEndDate').value = dateToYMD(startDate); } });

        addItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const categorySelect = document.getElementById('itemCategorySelect');
            if (!categorySelect.value) { alert('Por favor, selecione uma categoria.'); return; }
            let category = categorySelect.value;
            if (category === 'outro') category = document.getElementById('itemCategoryOther').value || 'Outro';
            
            let managedBy = null, managerName = null, hasManagementFee = false, managementFeePercentage = 0;
            if (category === 'Imóvel') {
                managedBy = document.getElementById('itemManagedBy').value;
                if (managedBy === 'imobiliaria' || managedBy === 'outros') {
                    managerName = document.getElementById('itemManagerName').value;
                    hasManagementFee = document.getElementById('itemHasManagementFee').checked;
                    if(hasManagementFee) {
                        managementFeePercentage = parseFloat(document.getElementById('itemManagementFeePercentage').value);
                    }
                }
            }

            const newItem = {
                id: Date.now(),
                name: document.getElementById('itemName').value, 
                description: document.getElementById('itemDescription').value, 
                category: category,
                value: parseFloat(document.getElementById('itemValue').value), 
                paymentFrequency: document.getElementById('itemPaymentFrequency').value, 
                rentedTo: null,
                endereco: category === 'Imóvel' ? document.getElementById('itemEndereco').value : null, 
                cep: category === 'Imóvel' ? document.getElementById('itemCep').value : null,
                managedBy, 
                managerName, 
                hasManagementFee, 
                managementFeePercentage,
                includeInTaxReport: document.getElementById('itemIncludeInTaxReport').checked,
                iptu: {}
            };
            items.push(newItem);

            saveData();
            renderAll();
            hideModal('addItemModal');
            addItemForm.reset();
            document.getElementById('imovelFieldsWrapper').classList.add('hidden');
            document.getElementById('itemCategoryOtherWrapper').classList.add('hidden');
        });
        
        editItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const itemId = parseInt(document.getElementById('editItemId').value);
            const item = items.find(i => i.id === itemId);
            if (item) {
                const categorySelect = document.getElementById('editItemCategorySelect');
                if (!categorySelect.value) { alert('Por favor, selecione uma categoria.'); return; }
                let category = categorySelect.value;
                if (category === 'outro') category = document.getElementById('editItemCategoryOther').value || 'Outro';
                item.name = document.getElementById('editItemName').value;
                item.description = document.getElementById('editItemDescription').value;
                item.category = category;
                item.value = parseFloat(document.getElementById('editItemValue').value);
                item.paymentFrequency = document.getElementById('editItemPaymentFrequency').value;
                item.includeInTaxReport = document.getElementById('editItemIncludeInTaxReport').checked;
                
                if (category === 'Imóvel') {
                    item.endereco = document.getElementById('editItemEndereco').value;
                    item.cep = document.getElementById('editItemCep').value;
                    item.managedBy = document.getElementById('editItemManagedBy').value;
                    if (item.managedBy === 'imobiliaria' || item.managedBy === 'outros') {
                        item.managerName = document.getElementById('editItemManagerName').value;
                        item.hasManagementFee = document.getElementById('editItemHasManagementFee').checked;
                        if(item.hasManagementFee) {
                            item.managementFeePercentage = parseFloat(document.getElementById('editItemManagementFeePercentage').value);
                        } else {
                            item.managementFeePercentage = 0;
                        }
                    } else {
                        item.managerName = null;
                        item.hasManagementFee = false;
                        item.managementFeePercentage = 0;
                    }
                } else {
                    item.endereco = null; item.cep = null; item.managedBy = null; item.managerName = null; item.hasManagementFee = false; item.managementFeePercentage = 0;
                }
            }
            saveData();
            renderAll();
            hideModal('editItemModal');
        });
        
        editTransactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const transactionId = parseInt(document.getElementById('editTransactionId').value);
            const transaction = transactions.find(t => t.id === transactionId);
            if (transaction) {
                transaction.description = document.getElementById('editTransactionDescription').value;
                transaction.amount = parseFloat(document.getElementById('editTransactionAmount').value);
                transaction.date = document.getElementById('editTransactionDate').value;
            }
            saveData();
            renderAll();
            hideModal('editTransactionModal');
        });

        iptuForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const itemId = parseInt(document.getElementById('iptuItemId').value);
    // Lê o VALOR DA PARCELA do input modificado
    const installmentValue = parseFloat(document.getElementById('iptuInstallmentValue').value);
    const installments = parseInt(document.getElementById('iptuInstallments').value);
    const item = items.find(i => i.id === itemId);

    // Calcula o VALOR TOTAL
    const totalValue = installmentValue * installments;

    // Verifica se os valores são válidos ANTES de salvar
    if (item && !isNaN(installmentValue) && installmentValue > 0 && installments > 0) {
        const currentYear = new Date().getFullYear();
        if (!item.iptu) item.iptu = {};

        // Salva o VALOR TOTAL calculado e as outras informações
        item.iptu[currentYear] = {
            totalValue: totalValue, // <-- Salva o valor TOTAL calculado
            installments: installments,
            paidInstallments: 0
        };
        saveData();
        renderAll();
        hideModal('iptuModal');
    } else {
         // Adiciona um feedback se os valores forem inválidos
         alert("Por favor, insira um valor de parcela válido e selecione o número de parcelas.");
    }
});

        
        

        rentItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const itemId = parseInt(document.getElementById('rentItemId').value);
            const item = items.find(i => i.id === itemId);

            item.rentedTo = document.getElementById('tenantName').value;
            item.tenantPhone = document.getElementById('tenantPhone').value;
            item.tenantCPF = document.getElementById('tenantCPF').value;
            item.rentStartDate = document.getElementById('rentStartDate').value;
            item.rentEndDate = document.getElementById('rentEndDate').value;
            item.rentValue = parseFloat(document.getElementById('rentValue').value);
            item.paymentDay = parseInt(document.getElementById('paymentDay').value);
            
            if (!item.paymentsMade) {
                item.paymentsMade = [];
            }
            item.lastPaymentAlertDate = null;
            item.endOfContractNotified = false;
            item.renewalPending = false;
            item.debt = { amount: 0, cycles: 0 };
            
            saveData();
            renderAll();
            hideModal('rentItemModal');
            rentItemForm.reset();
        });

       addTransactionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const selectedItemId = document.getElementById('transactionItemLink').value;
        const description = document.getElementById('transactionDescription').value;
        let amountPaidFromForm = parseFloat(document.getElementById('transactionAmount').value);
        const transactionDate = document.getElementById('transactionDate').value;

        // --- INÍCIO: Lê e reseta a flag ---
        const isDirectPayment = document.getElementById('isDirectIptuPayment').value === 'true';
        document.getElementById('isDirectIptuPayment').value = 'false'; // Reseta a flag imediatamente
        // --- FIM: Lê e reseta a flag ---

        const iptuCheckbox = document.getElementById('autoIptuCheckbox');
        let iptuTransactionToCreate = null; // Usado SÓ se veio do checkbox de Receita
        let revenueAmount = amountPaidFromForm;
        let finalDescription = description;

        // Lógica de separação via CHECKBOX (Só executa se NÃO for pagamento direto)
        if (!isDirectPayment && selectedItemId && iptuCheckbox.checked) {
            const item = items.find(i => i.id === parseInt(selectedItemId));
            const currentYear = new Date().getFullYear();
            if (item && item.iptu && item.iptu[currentYear]) {
                const iptuData = item.iptu[currentYear];
                // Verifica se ainda há parcelas a pagar ANTES de processar
                if (iptuData.paidInstallments < iptuData.installments) {
                    const installmentValue = parseFloat(iptuCheckbox.dataset.iptuValue) || 0;
                    revenueAmount = amountPaidFromForm - installmentValue;
                    iptuData.paidInstallments += 1; // Incrementa aqui se veio do checkbox
                    iptuTransactionToCreate = {
                         id: Date.now() + 2, // ID ligeiramente diferente
                         type: 'expense',
                         description: `Pagamento IPTU ${currentYear} (${iptuData.paidInstallments}/${iptuData.installments}) - ${displayName}`,
                         amount: installmentValue,
                         date: transactionDate,
                         itemId: item.id,
                         excludeFromDashboard: true // Flag para ocultar
                     };
                } else {
                     console.warn("IPTU já pago para o ano, mas checkbox foi marcado. Ignorando IPTU.");
                     iptuCheckbox.checked = false; // Desmarca visualmente se já estiver pago
                }
            }
        }

        // Ajusta a descrição se for receita padrão
        if (selectedItemId && description.startsWith('Recebimento aluguel:')) {
            finalDescription = 'Recebimento de Aluguel';
        }

        // Cria a transação PRINCIPAL (Receita ajustada OU Despesa Direta de IPTU)
        const newTransaction = {
            id: Date.now(),
            type: document.getElementById('transactionType').value,
            description: finalDescription,
            amount: revenueAmount, // Usa o valor ajustado se veio do checkbox, ou o valor direto se for despesa IPTU
            date: transactionDate,
            itemId: selectedItemId ? parseInt(selectedItemId) : null
        };

        // --- INÍCIO: Lógica para pagamento DIRETO de IPTU ---
        if (isDirectPayment && newTransaction.type === 'expense' && selectedItemId) {
            newTransaction.excludeFromDashboard = true; // Adiciona a flag para ocultar do painel
            const item = items.find(i => i.id === parseInt(selectedItemId));
            // Tenta extrair o ano da descrição preenchida
            const yearMatch = newTransaction.description.match(/IPTU (\d{4})/);
            if (item && yearMatch) {
                 const year = parseInt(yearMatch[1], 10);
                 if (item.iptu && item.iptu[year]) {
                      // Verifica se ainda há parcelas a pagar ANTES de incrementar
                      if (item.iptu[year].paidInstallments < item.iptu[year].installments) {
                           // Incrementa o contador AQUI para pagamento direto
                           item.iptu[year].paidInstallments += 1;
                      } else {
                           console.warn("Tentativa de registrar pagamento direto de IPTU já quitado.");
                           // Decide se quer alertar o usuário ou apenas não registrar/incrementar
                           // alert("Este IPTU já consta como totalmente pago.");
                           // Poderia até impedir o salvamento retornando aqui, se desejado.
                      }
                 }
            }
        }
        // --- FIM: Lógica para pagamento DIRETO de IPTU ---


        // Lógica de dívida (Só executa se for RECEITA e NÃO for pagamento direto de IPTU)
        if (!isDirectPayment && newTransaction.type === 'revenue' && selectedItemId) {
            const item = items.find(i => i.id === parseInt(selectedItemId));
                if (item && item.rentedTo) {
                    if (!item.debt) item.debt = { amount: 0, cycles: 0 };
                    const difference = item.rentValue - revenueAmount;
                    const paymentPeriod = `${new Date(transactionDate + 'T00:00:00').getFullYear()}-${String(new Date(transactionDate + 'T00:00:00').getMonth() + 1).padStart(2, '0')}`;
                    const hasPaymentForPeriod = item.paymentsMade && item.paymentsMade.includes(paymentPeriod);

                    if (difference > 0) {
                        item.debt.amount += difference;
                        if (!hasPaymentForPeriod) {
                            item.debt.cycles = (item.debt.cycles || 0) + 1;
                        }
                    } else if (difference < 0 && item.debt.amount > 0) {
                        const surplus = -difference;
                        item.debt.amount -= surplus;
                        if (item.debt.amount < 0.01) {
                            item.debt.amount = 0;
                            item.debt.cycles = 0;
                        }
                    }

                    if (!item.paymentsMade) item.paymentsMade = [];
                    if (!item.paymentsMade.includes(paymentPeriod)) {
                        item.paymentsMade.push(paymentPeriod);
                    }
                }
        }

        transactions.push(newTransaction); // Adiciona a transação principal

        // Adiciona taxa de gerência (Só se for receita e NÃO pagamento direto)
        const addFee = document.getElementById('addManagementFee').checked;
        const feeAmount = parseFloat(document.getElementById('managementFeeAmount').value);
        if (!isDirectPayment && addFee && !isNaN(feeAmount) && feeAmount > 0 && newTransaction.type === 'revenue') {
             const item = items.find(i => i.id === parseInt(selectedItemId));
             const displayName = (item && item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
             const feeDescription = `Taxa de Gerência - ${item ? displayName : description}`;
             const feeTransaction = {
                 id: Date.now() + 1, // ID ligeiramente diferente
                 type: 'management_fee',
                 description: feeDescription,
                 amount: feeAmount,
                 date: newTransaction.date,
                 itemId: newTransaction.itemId
             };
             transactions.push(feeTransaction);
        }

        // Adiciona a despesa IPTU SEPARADA (Só se veio do checkbox de receita)
        if (iptuTransactionToCreate) {
            transactions.push(iptuTransactionToCreate);
        }

        saveData();
        renderAll();
        hideModal('addTransactionModal');
        addTransactionForm.reset();
    });
        
        editDebtForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const itemId = parseInt(document.getElementById('editDebtItemId').value);
    const newAmount = parseFloat(document.getElementById('newDebtAmount').value);
    const item = items.find(i => i.id === itemId);

    if (item && !isNaN(newAmount)) {
        if (!item.debt) item.debt = { amount: 0 };
        item.debt.amount = newAmount >= 0 ? newAmount : 0; // Garante que não seja negativo

        if (item.debt.amount < 0.005) {
            item.debt.amount = 0;
        }

        saveData();
        renderAll();
        hideModal('editDebtModal');
    }
});

        document.getElementById('paymentReceivedBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('paymentAlertItemId').value);
            const item = items.find(i => i.id === itemId);
            
            item.lastPaymentAlertDate = getTodayDateString();
            saveData(); 
            hideModal('paymentAlertModal');
            
            switchTab('finance');
            
            document.getElementById('transactionModalTitle').textContent = 'Adicionar Receita';
            document.getElementById('transactionType').value = 'revenue'; document.getElementById('managementFeeContainer').style.display = 'block';
            addTransactionForm.reset(); document.getElementById('transactionDate').value = getTodayDateString();
            populateTransactionItemSelect('transactionItemLink', item.id);
            document.getElementById('transactionDescription').value = `Recebimento aluguel: ${displayName}`; document.getElementById('transactionAmount').value = item.rentValue;
            showModal('addTransactionModal');

            renderAll();
        });

        document.getElementById('snoozePaymentBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('paymentAlertItemId').value);
            const item = items.find(i => i.id === itemId);
            const today = new Date();
            today.setDate(today.getDate() + 7);
            item.lastPaymentAlertDate = dateToYMD(today);
            saveData();
            renderAll();
            hideModal('paymentAlertModal');
        });

        document.getElementById('forgetReminderBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('paymentAlertItemId').value);
            const item = items.find(i => i.id === itemId);
            const today = new Date();
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            item.lastPaymentAlertDate = dateToYMD(endOfMonth);
            saveData();
            renderAll();
            hideModal('paymentAlertModal');
        });
        
        document.getElementById('setPaymentPendingBtn').addEventListener('click', () => hideModal('paymentAlertModal'));
        
        document.getElementById('renewContractBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('contractEndItemId').value);
            const item = items.find(i => i.id === itemId);
            
            item.endOfContractNotified = true;
            saveData();
            hideModal('contractEndModal');
            
            document.getElementById('rentModalTitle').textContent = "Renovar Aluguel";
            document.getElementById('rentItemId').value = item.id; document.getElementById('rentValue').value = item.rentValue;
            const newStartDate = new Date(item.rentEndDate + 'T00:00:00'); newStartDate.setDate(newStartDate.getDate() + 1);
            document.getElementById('rentStartDate').value = dateToYMD(newStartDate); document.getElementById('rentEndDate').value = '';
            document.getElementById('tenantName').value = item.rentedTo; document.getElementById('paymentDay').value = item.paymentDay;
            showModal('rentItemModal');
            renderAll();
        });

        document.getElementById('setRenewalPendingBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('contractEndItemId').value);
            const item = items.find(i => i.id === itemId);
            item.renewalPending = true;
            item.endOfContractNotified = true;
            saveData();
            renderAll();
            hideModal('contractEndModal');
        });
        
        document.getElementById('endContractBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('contractEndItemId').value);
            
            finalizeRental(itemId);
            saveData();
            renderAll();
            hideModal('contractEndModal');
        });
        
        document.getElementById('confirmActionConfirm').addEventListener('click', () => { if (typeof onConfirm === 'function') onConfirm(); hideModal('confirmActionModal'); onConfirm = null; });
        document.getElementById('confirmActionCancel').addEventListener('click', () => { hideModal('confirmActionModal'); onConfirm = null; });

        const settingsBtn = document.getElementById('settingsBtn');
        const settingsTabButtons = document.querySelectorAll('.settings-tab-button');
        const settingsTabContents = document.querySelectorAll('.settings-tab-content');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const passwordChangeFeedback = document.getElementById('passwordChangeFeedback');
        const managerForm = document.getElementById('managerForm');

        settingsBtn.addEventListener('click', () => {
            showModal('settingsModal');
            passwordChangeFeedback.innerHTML = '';
            changePasswordForm.reset();
        });

        document.getElementById('openAddManagerModal').addEventListener('click', () => {
    document.getElementById('managerModalTitle').textContent = 'Adicionar Novo Gestor';
    managerForm.reset();
    document.getElementById('managerId').value = '';

    const rentalsListDiv = document.getElementById('managerRentalsList');
    rentalsListDiv.innerHTML = '';
    const allItems = items;

    // Cria um conjunto de todos os IDs de itens que já estão sendo gerenciados
    const allAssignedItemIds = new Set();
    managers.forEach(m => {
        m.assignedItemIds.forEach(id => allAssignedItemIds.add(id));
    });

    if (allItems.length === 0) {
        rentalsListDiv.innerHTML = '<p class="text-gray-400">Nenhum item cadastrado para associar.</p>';
    } else {
        allItems.forEach(item => {
            const checkboxId = `manager-item-add-${item.id}`;
            const label = document.createElement('label');

            const isManaged = allAssignedItemIds.has(item.id);
            const isDisabled = isManaged ? 'disabled' : '';
            const cursorClass = isManaged ? 'cursor-not-allowed' : 'cursor-pointer hover:bg-gray-600/50';

            label.htmlFor = checkboxId;
            label.className = `flex items-center space-x-3 p-2 rounded-md ${cursorClass}`;

            let statusText = item.rentedTo ? `(Alugado para: ${item.rentedTo})` : '(Disponível)';
            if(isManaged) {
                const managingManager = managers.find(m => m.assignedItemIds.includes(item.id));
                statusText = `(Gerenciado por: ${managingManager.name})`;
            }

            label.innerHTML = `
                <input type="checkbox" id="${checkboxId}" value="${item.id}" name="assignedItems" class="h-4 w-4 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600" ${isDisabled}>
                <span>${(item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name} <span class="text-xs ${isManaged ? 'text-yellow-400' : 'text-gray-400'}">${statusText}</span></span>
            `;
            rentalsListDiv.appendChild(label);
        });
    }
    showModal('managerModal');
});

        managerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const assignedItemsCheckboxes = document.querySelectorAll('#managerRentalsList input[type="checkbox"]:checked');
            const assignedItemIds = Array.from(assignedItemsCheckboxes).map(cb => parseInt(cb.value));
            const managerId = parseInt(document.getElementById('managerId').value);

            if (managerId) { // Edit
                const manager = managers.find(m => m.id === managerId);
                if (manager) {
                    manager.type = document.getElementById('managerType').value;
                    manager.name = document.getElementById('managerName').value;
                    manager.password = document.getElementById('managerPassword').value;
                    manager.assignedItemIds = assignedItemIds;
                }
            } else { // Add
                const newManager = {
                    id: Date.now(),
                    type: document.getElementById('managerType').value,
                    name: document.getElementById('managerName').value,
                    password: document.getElementById('managerPassword').value,
                    assignedItemIds: assignedItemIds
                };
                managers.push(newManager);
            }
            
            saveData();
            renderAll();
            hideModal('managerModal');
        });


        const switchSettingsTab = (tabId) => {
    settingsTabButtons.forEach(btn => {
        const isCorrectTab = btn.dataset.tab === tabId;
        btn.classList.toggle('active-settings-tab', isCorrectTab);
        btn.classList.toggle('text-gray-100', isCorrectTab);
        btn.classList.toggle('bg-gray-700', isCorrectTab);
        btn.classList.toggle('text-gray-400', !isCorrectTab);
         btn.classList.toggle('hover:bg-gray-700/50', !isCorrectTab);
    });
    settingsTabContents.forEach(content => content.classList.add('hidden'));
    // Adiciona a busca pelo novo ID
    const contentToShow = document.getElementById(`${tabId}-settings-content`);
    if (contentToShow) {
        contentToShow.classList.remove('hidden');
    }
};

        settingsTabButtons.forEach(button => button.addEventListener('click', () => switchSettingsTab(button.dataset.tab)));
        
        changePasswordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            passwordChangeFeedback.innerHTML = '';
            passwordChangeFeedback.classList.remove('text-green-400', 'text-red-400');

            if (currentPassword !== settings.password) {
                passwordChangeFeedback.textContent = 'A senha atual está incorreta.';
                passwordChangeFeedback.classList.add('text-red-400');
                return;
            }
            if (!newPassword || newPassword.length < 4) {
                passwordChangeFeedback.textContent = 'A nova senha deve ter pelo menos 4 caracteres.';
                passwordChangeFeedback.classList.add('text-red-400');
                return;
            }
            if (newPassword !== confirmNewPassword) {
                passwordChangeFeedback.textContent = 'As novas senhas não correspondem.';
                passwordChangeFeedback.classList.add('text-red-400');
                return;
            }

            settings.password = newPassword;
            saveData();
            passwordChangeFeedback.textContent = 'Senha alterada com sucesso!';
            passwordChangeFeedback.classList.add('text-green-400');
            changePasswordForm.reset();
        });

        iptuForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const itemId = parseInt(document.getElementById('iptuItemId').value);
    const totalValue = parseFloat(document.getElementById('iptuTotalValue').value);
    const installments = parseInt(document.getElementById('iptuInstallments').value);
    const item = items.find(i => i.id === itemId);

    if (item && !isNaN(totalValue) && totalValue > 0) {
        const currentYear = new Date().getFullYear();
        if (!item.iptu) {
            item.iptu = {};
        }
        // Salva ou atualiza os dados do IPTU para o ano corrente
        item.iptu[currentYear] = {
            totalValue: totalValue,
            installments: installments,
            paidInstallments: 0 // Começa (ou reseta) com 0 parcelas pagas
        };
        saveData();
        renderAll(); // Atualiza toda a interface para mostrar o novo status
        hideModal('iptuModal');
    }
});

    // --- INÍCIO: LISTENERS PARA O MODAL manageIptuModal ---

    const manageIptuForm = document.getElementById('manageIptuForm');
    const manageIptuInstallmentsSelect = document.getElementById('manageIptuInstallments');
    const deleteIptuBtn = document.getElementById('deleteIptuBtn');

    // Mostra aviso ao tentar mudar número de parcelas
    manageIptuInstallmentsSelect.addEventListener('change', () => {
         document.getElementById('manageIptuWarning').classList.remove('hidden');
    });


    // Listener para SALVAR ALTERAÇÕES no IPTU
manageIptuForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const itemId = parseInt(document.getElementById('manageIptuItemId').value);
    const year = parseInt(document.getElementById('manageIptuYear').value);
    // Lê o VALOR DA PARCELA editado
    const newInstallmentValue = parseFloat(document.getElementById('manageIptuInstallmentValue').value);
    const newInstallments = parseInt(document.getElementById('manageIptuInstallments').value);
    const item = items.find(i => i.id === itemId);

    // Calcula o NOVO VALOR TOTAL
    const newTotalValue = newInstallmentValue * newInstallments;

    // Valida o VALOR DA PARCELA e as parcelas
    if (item && item.iptu && item.iptu[year] && !isNaN(newInstallmentValue) && newInstallmentValue >= 0 && newInstallments > 0) {
        const iptuData = item.iptu[year];

        // Atualiza com o NOVO VALOR TOTAL calculado
        iptuData.totalValue = newTotalValue;

        // Se o número de parcelas mudou, reseta as pagas (mantém a lógica anterior)
        if (iptuData.installments !== newInstallments) {
             iptuData.paidInstallments = 0;
             console.warn("Número de parcelas alterado. Parcelas pagas foram resetadas para 0. Transações existentes não foram alteradas.");
        }
         iptuData.installments = newInstallments;


        saveData();
        renderAll();
        hideModal('manageIptuModal');
    } else {
         alert("Erro ao salvar. Verifique o valor da parcela e o número de parcelas.");
    }
});

    // Listener para APAGAR o IPTU do ano
    deleteIptuBtn.addEventListener('click', () => {
        const itemId = parseInt(document.getElementById('manageIptuItemId').value);
        const year = parseInt(document.getElementById('manageIptuYear').value);
        const item = items.find(i => i.id === itemId);

        if (item && item.iptu && item.iptu[year]) {
            showConfirmModal(
                `Apagar IPTU ${year}`,
                `Tem certeza que deseja apagar o registro do IPTU de ${year} para "${(item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name}"? Isso também removerá as transações de pagamento de IPTU associadas a este ano.`,
                () => {
                    // 1. Remove as transações de despesa de IPTU daquele ano
                    transactions = transactions.filter(t =>
                        !(t.itemId === itemId && t.type === 'expense' && t.description.includes(`Pagamento IPTU ${year}`))
                    );

                    // 2. Remove o registro do IPTU daquele ano no item
                    delete item.iptu[year];

                    saveData();
                    renderAll();
                    hideModal('manageIptuModal');
                }
            );
        }
    });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            // No futuro, isso levará para index.html
            window.location.href = 'index.html'; 
        });

        // --- Carga Inicial ---
        loadData();
        initDashboardFilters();
        initAdvancedFilters();
        renderAll();
    });
    </script>
</body>
</html>

