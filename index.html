<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Aluguéis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .tab-button .notification-badge {
            display: none;
        }
        .tab-button.has-notifications .notification-badge {
            display: inline-flex;
        }
        /* Hide scrollbar for tabs navigation */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Responsive table for transactions */
        @media (max-width: 767px) {
            #transactions-list thead {
                display: none;
            }
            #transactions-list tr {
                display: block;
                border: 1px solid #374151; /* gray-700 */
                border-radius: 0.75rem; /* rounded-xl */
                margin-bottom: 1rem;
                background-color: #1f2937; /* gray-800 */
            }
            #transactions-list td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 1rem;
                text-align: right;
                border-bottom: 1px solid #374151; /* gray-700 */
            }
            #transactions-list td:last-child {
                border-bottom: 0;
            }
            #transactions-list td:before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                margin-right: 1rem;
                color: #9ca3af; /* gray-400 */
            }
            #transactions-list .actions-cell {
                justify-content: flex-end; /* Align buttons to the right */
            }
             #transactions-list .actions-cell:before {
                margin-right: auto;
             }
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Cabeçalho -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-cyan-400">Meu Gestor de Aluguéis</h1>
            <button id="openAddItemModal" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg flex items-center transition-transform transform hover:scale-105">
                <i data-lucide="plus-circle" class="h-5 w-5 sm:mr-2"></i>
                <span class="hidden sm:inline">Adicionar Item</span>
            </button>
        </header>

        <!-- Navegação Principal -->
        <div class="mb-6">
            <div class="border-b border-gray-700">
                <div class="overflow-x-auto no-scrollbar">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button class="tab-button active-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-cyan-500 text-cyan-400" data-tab="dashboard">Painel</button>
                        <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="items">Meus Itens</button>
                        <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="finance">Financeiro</button>
                        <button id="notifications-tab-btn" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 relative" data-tab="notifications">
                            Notificações
                            <span class="notification-badge absolute top-3 -right-4 ml-2 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                        </button>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Conteúdo das Abas -->
        <main>
            <!-- Aba Painel -->
            <div id="dashboard-content" class="tab-content">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-sm font-medium text-gray-400">Total de Itens</h3>
                        <p id="total-items" class="mt-1 text-3xl font-semibold">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-sm font-medium text-gray-400">Itens Alugados</h3>
                        <p id="rented-items" class="mt-1 text-3xl font-semibold">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-sm font-medium text-gray-400">Itens Disponíveis</h3>
                        <p id="available-items" class="mt-1 text-3xl font-semibold">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 id="month-balance-title" class="text-sm font-medium text-gray-400">Saldo do Mês</h3>
                        <p id="month-balance" class="mt-1 text-3xl font-semibold">R$ 0,00</p>
                    </div>
                </div>

                <!-- Gráfico Financeiro -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                         <h2 id="financial-overview-title" class="text-lg sm:text-xl font-semibold">Visão Geral Financeira</h2>
                         <div class="flex items-center gap-2 self-start md:self-center">
                            <label for="filterMonth" class="text-sm">Mês:</label>
                            <select id="filterMonth" class="bg-gray-700 border border-gray-600 rounded-md px-2 sm:px-3 py-1 text-sm"></select>
                            <label for="filterYear" class="text-sm">Ano:</label>
                            <select id="filterYear" class="bg-gray-700 border border-gray-600 rounded-md px-2 sm:px-3 py-1 text-sm"></select>
                         </div>
                    </div>
                    <div class="h-[300px] sm:h-[350px]">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Aba Meus Itens -->
            <div id="items-content" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="package-check" class="mr-3 text-green-400"></i>Disponíveis para Alugar</h2>
                        <div id="available-list" class="space-y-4">
                           <!-- Itens disponíveis aqui -->
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="package-x" class="mr-3 text-red-400"></i>Atualmente Alugados</h2>
                        <div id="rented-list" class="space-y-4">
                            <!-- Itens alugados aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Financeiro -->
            <div id="finance-content" class="tab-content hidden">
                 <div class="flex space-x-4 mb-6">
                     <button id="openAddTransactionModalRevenue" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                        <i data-lucide="trending-up" class="mr-2 h-5 w-5"></i>
                        <span>Adicionar Receita</span>
                    </button>
                    <button id="openAddTransactionModalExpense" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                        <i data-lucide="trending-down" class="mr-2 h-5 w-5"></i>
                        <span>Adicionar Despesa</span>
                    </button>
                 </div>

                 <!-- Filtros de Transações -->
                 <div class="bg-gray-800 p-4 rounded-xl mb-6">
                    <h3 class="text-lg font-semibold mb-3">Filtrar Transações</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="sm:col-span-2 lg:col-span-2">
                            <label for="filterDescription" class="block text-sm font-medium mb-1">Descrição</label>
                            <input type="text" id="filterDescription" placeholder="Filtrar por descrição..." class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
                        </div>
                        <div>
                            <label for="filterType" class="block text-sm font-medium mb-1">Tipo</label>
                            <select id="filterType" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
                                <option value="all">Todos</option>
                                <option value="revenue">Receita</option>
                                <option value="expense">Despesa</option>
                                <option value="management_fee">Taxa de Gerência</option>
                            </select>
                        </div>
                         <div class="flex items-end space-x-2">
                            <div class="flex-grow">
                                <label for="filterStartDate" class="block text-sm font-medium mb-1">A partir de</label>
                                <input type="date" id="filterStartDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
                            </div>
                            <button id="clearFiltersBtn" title="Limpar Filtros" class="bg-gray-600 hover:bg-gray-500 text-white font-bold p-2 rounded-md text-sm">
                                <i data-lucide="rotate-ccw" class="h-5 w-5"></i>
                            </button>
                        </div>
                    </div>
                 </div>

                 <h2 class="text-xl sm:text-2xl font-semibold mb-4">Histórico de Transações</h2>
                 <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="p-4">Data</th>
                                    <th class="p-4">Descrição</th>
                                    <th class="p-4">Tipo</th>
                                    <th class="p-4 text-right">Valor</th>
                                    <th class="p-4 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-list">
                                <!-- Transações aqui -->
                            </tbody>
                        </table>
                     </div>
                 </div>
            </div>

            <!-- Aba Notificações -->
            <div id="notifications-content" class="tab-content hidden">
                <div id="alerts-section">
                     <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="bell-ring" class="mr-3 text-yellow-400"></i>Alertas Pendentes</h2>
                     <div id="alerts-container" class="space-y-4">
                         <!-- Alertas serão inseridos aqui -->
                     </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Adicionar Item -->
    <div id="addItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="addItemForm">
                <h2 class="text-2xl font-bold mb-4">Adicionar Novo Item</h2>
                <div class="space-y-4">
                    <div>
                        <label for="itemName" class="block mb-1 font-medium">Nome do Item/Serviço</label>
                        <input type="text" id="itemName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="itemDescription" class="block mb-1 font-medium">Descrição</label>
                        <textarea id="itemDescription" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Ex: Apartamento de 2 quartos, carro ano 2020..."></textarea>
                    </div>
                    <div>
                        <label for="itemCategorySelect" class="block mb-1 font-medium">Categoria</label>
                        <select id="itemCategorySelect" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <option value="" disabled selected>Selecione uma categoria...</option>
                            <option value="Imóvel">Imóvel</option>
                            <option value="Veículo">Veículo</option>
                            <option value="Equipamento">Equipamento</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div id="itemCategoryOtherWrapper" class="hidden">
                        <label for="itemCategoryOther" class="block mb-1 font-medium">Qual categoria?</label>
                        <input type="text" id="itemCategoryOther" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                    </div>
                    <div id="imovelFieldsWrapper" class="hidden space-y-4 border-t border-gray-700 pt-4 mt-4">
                        <div>
                            <label for="itemEndereco" class="block mb-1 font-medium">Endereço (Opcional)</label>
                            <input type="text" id="itemEndereco" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="itemCep" class="block mb-1 font-medium">CEP (Opcional)</label>
                            <input type="text" id="itemCep" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                    </div>
                    <div>
                        <label for="itemValue" class="block mb-1 font-medium">Valor Padrão do Aluguel (R$)</label>
                        <input type="number" step="0.01" id="itemValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="itemPaymentFrequency" class="block mb-1 font-medium">Frequência de Recebimento</label>
                        <select id="itemPaymentFrequency" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                            <option value="monthly">Mensal</option>
                            <option value="weekly">Semanal</option>
                            <option value="daily">Diário</option>
                            <option value="single">Pagamento Único</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Editar Item -->
    <div id="editItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="editItemForm">
                <h2 class="text-2xl font-bold mb-4">Editar Item</h2>
                <input type="hidden" id="editItemId">
                <div class="space-y-4">
                    <div>
                        <label for="editItemName" class="block mb-1 font-medium">Nome do Item/Serviço</label>
                        <input type="text" id="editItemName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editItemDescription" class="block mb-1 font-medium">Descrição</label>
                        <textarea id="editItemDescription" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></textarea>
                    </div>
                    <div>
                        <label for="editItemCategorySelect" class="block mb-1 font-medium">Categoria</label>
                        <select id="editItemCategorySelect" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <option value="" disabled>Selecione uma categoria...</option>
                            <option value="Imóvel">Imóvel</option>
                            <option value="Veículo">Veículo</option>
                            <option value="Equipamento">Equipamento</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div id="editItemCategoryOtherWrapper" class="hidden">
                        <label for="editItemCategoryOther" class="block mb-1 font-medium">Qual categoria?</label>
                        <input type="text" id="editItemCategoryOther" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                    </div>
                    <div id="editImovelFieldsWrapper" class="hidden space-y-4 border-t border-gray-700 pt-4 mt-4">
                        <div>
                            <label for="editItemEndereco" class="block mb-1 font-medium">Endereço (Opcional)</label>
                            <input type="text" id="editItemEndereco" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="editItemCep" class="block mb-1 font-medium">CEP (Opcional)</label>
                            <input type="text" id="editItemCep" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                    </div>
                    <div>
                        <label for="editItemValue" class="block mb-1 font-medium">Valor Padrão do Aluguel (R$)</label>
                        <input type="number" step="0.01" id="editItemValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editItemPaymentFrequency" class="block mb-1 font-medium">Frequência de Recebimento</label>
                        <select id="editItemPaymentFrequency" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                            <option value="monthly">Mensal</option>
                            <option value="weekly">Semanal</option>
                            <option value="daily">Diário</option>
                            <option value="single">Pagamento Único</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Alugar Item -->
    <div id="rentItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4">
         <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="rentItemForm">
                <h2 id="rentModalTitle" class="text-2xl font-bold mb-4">Registrar Aluguel</h2>
                <input type="hidden" id="rentItemId">
                <div class="space-y-4">
                    <div>
                        <label for="tenantName" class="block mb-1 font-medium">Nome do Inquilino/Cliente</label>
                        <input type="text" id="tenantName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="tenantPhone" class="block mb-1 font-medium">Telefone (Opcional)</label>
                            <input type="tel" id="tenantPhone" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="tenantCPF" class="block mb-1 font-medium">CPF (Opcional)</label>
                            <input type="text" id="tenantCPF" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                    </div>
                    <div>
                        <label for="rentStartDate" class="block mb-1 font-medium">Data de Início</label>
                        <input type="date" id="rentStartDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="rentEndDate" class="block mb-1 font-medium">Data de Término</label>
                        <div class="flex items-center space-x-2">
                            <input type="date" id="rentEndDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <button type="button" id="setOneYearBtn" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-sm whitespace-nowrap">1 Ano</button>
                        </div>
                    </div>
                     <div>
                        <label for="rentValue" class="block mb-1 font-medium">Valor Combinado (R$)</label>
                        <input type="number" step="0.01" id="rentValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="paymentDay" class="block mb-1 font-medium">Dia do Pagamento Mensal</label>
                        <input type="number" id="paymentDay" min="1" max="31" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Ex: 5" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Confirmar Aluguel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Adicionar Transação -->
    <div id="addTransactionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="addTransactionForm">
                <h2 id="transactionModalTitle" class="text-2xl font-bold mb-4">Adicionar Transação</h2>
                <input type="hidden" id="transactionType">
                <div class="space-y-4">
                    <div>
                        <label for="transactionDescription" class="block mb-1 font-medium">Descrição</label>
                        <input type="text" id="transactionDescription" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="transactionItemLink" class="block mb-1 font-medium">Associar a um Item (Opcional)</label>
                        <select id="transactionItemLink" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="transactionAmount" class="block mb-1 font-medium">Valor (R$)</label>
                        <input type="number" step="0.01" id="transactionAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="transactionDate" class="block mb-1 font-medium">Data</label>
                        <input type="date" id="transactionDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div id="managementFeeContainer" class="border-t border-gray-700 pt-4 mt-4">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="addManagementFee" class="h-5 w-5 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600">
                            <span>Incluir despesa de gerência (taxa)?</span>
                        </label>
                        <div id="managementFeeDiv" class="mt-3 hidden">
                            <label for="managementFeeAmount" class="block mb-1 font-medium">Valor da Taxa de Gerência (R$)</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" step="0.01" id="managementFeeAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                                <button type="button" id="setTenPercentFeeBtn" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-sm whitespace-nowrap">10%</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Editar Transação -->
    <div id="editTransactionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <form id="editTransactionForm">
                <h2 class="text-2xl font-bold mb-4">Editar Transação</h2>
                <input type="hidden" id="editTransactionId">
                <div class="space-y-4">
                    <div>
                        <label for="editTransactionDescription" class="block mb-1 font-medium">Descrição</label>
                        <input type="text" id="editTransactionDescription" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editTransactionAmount" class="block mb-1 font-medium">Valor (R$)</label>
                        <input type="number" step="0.01" id="editTransactionAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editTransactionDate" class="block mb-1 font-medium">Data</label>
                        <input type="date" id="editTransactionDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lembrete de Pagamento Mensal -->
    <div id="paymentAlertModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6">
             <h2 class="text-2xl font-bold mb-2">Lembrete de Pagamento</h2>
             <p class="mb-4 text-gray-300">Item: <strong id="paymentAlertItemName" class="text-white"></strong></p>
             <input type="hidden" id="paymentAlertItemId">
             <div class="bg-gray-700 p-4 rounded-md">
                <p class="mb-3">O pagamento mensal deste item já venceu. O que você gostaria de fazer?</p>
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                    <button id="paymentReceivedBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Recebido</button>
                    <button id="snoozePaymentBtn" class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded-md">Adiar 7 Dias</button>
                    <button id="setPaymentPendingBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Deixar Pendente</button>
                    <button id="forgetReminderBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">Esquecer</button>
                 </div>
             </div>
             <div class="mt-6 flex justify-end">
                <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Fechar</button>
             </div>
        </div>
    </div>

    <!-- Modal Fim de Contrato -->
    <div id="contractEndModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-2">Fim de Contrato</h2>
            <p class="mb-4 text-gray-300">O contrato para o item <strong id="contractEndItemName" class="text-white"></strong> terminou.</p>
            <input type="hidden" id="contractEndItemId">
            <div class="bg-gray-700 p-4 rounded-md">
                <p class="mb-3">O que você gostaria de fazer a seguir?</p>
                <div class="flex flex-col sm:flex-row flex-wrap gap-3">
                    <button id="renewContractBtn" class="flex-1 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-md">Renovar Contrato</button>
                    <button id="setRenewalPendingBtn" class="flex-1 bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-md">Deixar Pendente</button>
                    <button id="endContractBtn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Finalizar Aluguel</button>
                </div>
            </div>
             <div class="mt-6 flex justify-end">
                <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Fechar</button>
             </div>
        </div>
    </div>

    <!-- Modal Confirmar Ação -->
    <div id="confirmActionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h2 id="confirmActionTitle" class="text-xl font-bold mb-4">Confirmar Ação</h2>
            <p id="confirmActionMessage" class="mb-6 text-gray-300">Você tem certeza?</p>
            <div class="flex justify-center space-x-3">
                <button id="confirmActionCancel" class="px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                <button id="confirmActionConfirm" class="px-6 py-2 bg-red-600 hover:bg-red-500 rounded-md font-semibold">Confirmar</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Inicialização dos Ícones Lucide
        lucide.createIcons();

        // Estado da Aplicação
        let items = [];
        let transactions = [];
        let financialChart;
        let onConfirm = null;

        // Elementos do DOM
        const app = document.getElementById('app');
        const modals = document.querySelectorAll('.modal');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        const addItemForm = document.getElementById('addItemForm');
        const editItemForm = document.getElementById('editItemForm');
        const rentItemForm = document.getElementById('rentItemForm');
        const addTransactionForm = document.getElementById('addTransactionForm');
        const editTransactionForm = document.getElementById('editTransactionForm');
        
        // --- Funções de Persistência de Dados ---
        const saveData = () => {
            localStorage.setItem('rentalManagerItems', JSON.stringify(items));
            localStorage.setItem('rentalManagerTransactions', JSON.stringify(transactions));
        };

        const loadData = () => {
            const storedItems = localStorage.getItem('rentalManagerItems');
            const storedTransactions = localStorage.getItem('rentalManagerTransactions');
            items = storedItems ? JSON.parse(storedItems) : [];
            transactions = storedTransactions ? JSON.parse(storedTransactions) : [];
        };

        // --- Funções de Renderização ---
        const renderAll = () => {
            renderSummaryCards();
            renderItems();
            applyFiltersAndRender(); 
            checkAlerts();
            updateDashboardView();
            lucide.createIcons();
        };

        const renderSummaryCards = () => {
            const rentedCount = items.filter(item => item.rentedTo).length;
            document.getElementById('total-items').textContent = items.length;
            document.getElementById('rented-items').textContent = rentedCount;
            document.getElementById('available-items').textContent = items.length - rentedCount;
        };
        
        const renderItems = () => {
            const availableList = document.getElementById('available-list');
            const rentedList = document.getElementById('rented-list');
            availableList.innerHTML = '';
            rentedList.innerHTML = '';

            if (items.length === 0) {
                 availableList.innerHTML = `<p class="text-gray-400">Nenhum item cadastrado. Clique em "Adicionar Item" para começar.</p>`;
            }

            items.forEach(item => {
                const actionButtons = `
                    <div class="mt-4 flex justify-end items-center space-x-2">
                        <button data-id="${item.id}" class="edit-item-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Item">
                            <i data-lucide="file-signature" class="h-5 w-5"></i>
                        </button>
                        ${item.rentedTo ? `
                        <button data-id="${item.id}" class="edit-rent-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Aluguel">
                            <i data-lucide="clipboard-edit" class="h-5 w-5"></i>
                        </button>
                        ` : ''}
                        <button data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full" title="${item.rentedTo ? 'Finalizar Aluguel' : 'Excluir Item'}">
                            <i data-lucide="trash-2" class="h-5 w-5"></i>
                        </button>
                        ${!item.rentedTo ? `
                        <button data-id="${item.id}" class="rent-btn bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-md flex items-center text-sm">
                            <i data-lucide="key-round" class="mr-2 h-4 w-4"></i>Alugar
                        </button>` : ''}
                    </div>
                `;

                if (item.rentedTo) {
                    // Item Alugado
                    const endDate = new Date(item.rentEndDate);
                    const isOverdue = new Date() > endDate;
                    
                    let borderColor = 'border-yellow-500'; // Padrão para alugado
                    if (item.renewalPending) {
                        borderColor = 'border-pink-500'; // Rosa choque para pendente de renovação
                    } else if (isOverdue) {
                        borderColor = 'border-red-500'; // Vencido
                    }

                    const card = `
                        <div class="bg-gray-800 p-4 rounded-lg border-l-4 ${borderColor} flex flex-col h-full">
                             <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-lg">${item.name}</h3>
                                        <p class="text-sm text-gray-400">${item.category}</p>
                                    </div>
                                    <span class="text-lg font-semibold">${formatCurrency(item.rentValue)}</span>
                                </div>
                                ${item.description ? `<p class="text-sm text-gray-300 mt-2">${item.description}</p>` : ''}
                                ${item.endereco ? `<p class="text-xs text-gray-400 mt-2"><i data-lucide="map-pin" class="inline-block h-3 w-3 mr-1"></i>${item.endereco}${item.cep ? `, ${item.cep}`: ''}</p>` : ''}
                                <div class="mt-3 text-sm space-y-1">
                                    <p><strong class="text-gray-300">Inquilino:</strong> ${item.rentedTo}</p>
                                    ${item.tenantPhone ? `<p><strong class="text-gray-300">Telefone:</strong> ${item.tenantPhone}</p>` : ''}
                                    ${item.tenantCPF ? `<p><strong class="text-gray-300">CPF:</strong> ${item.tenantCPF}</p>` : ''}
                                    <p><strong class="text-gray-300">Pagamento Dia:</strong> ${item.paymentDay}</p>
                                    <p><strong class="text-gray-300">Término Contrato:</strong> <span class="${isOverdue ? 'text-red-400 font-bold' : ''}">${formatDate(item.rentEndDate)}</span></p>
                                </div>
                            </div>
                            ${actionButtons}
                        </div>
                    `;
                    rentedList.innerHTML += card;
                } else {
                    // Item Disponível
                    const card = `
                        <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-green-500 flex flex-col h-full">
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-lg">${item.name}</h3>
                                        <p class="text-sm text-gray-400">${item.category}</p>
                                    </div>
                                    <span class="text-lg font-semibold">${formatCurrency(item.value)}</span>
                                </div>
                                ${item.description ? `<p class="text-sm text-gray-300 mt-2">${item.description}</p>` : ''}
                                ${item.endereco ? `<p class="text-xs text-gray-400 mt-2"><i data-lucide="map-pin" class="inline-block h-3 w-3 mr-1"></i>${item.endereco}${item.cep ? `, ${item.cep}`: ''}</p>` : ''}
                            </div>
                            ${actionButtons}
                        </div>
                    `;
                    availableList.innerHTML += card;
                }
            });
            if (rentedList.innerHTML === '') rentedList.innerHTML = `<p class="text-gray-400">Nenhum item alugado no momento.</p>`;
            if (availableList.innerHTML === '') availableList.innerHTML = `<p class="text-gray-400">Nenhum item disponível no momento.</p>`;
        };
        
        const renderTransactions = (transactionsToRender) => {
            const list = document.getElementById('transactions-list');
            list.innerHTML = '';
            
            const sortedTransactions = [...transactionsToRender].sort((a,b) => new Date(b.date) - new Date(a.date));

            if(sortedTransactions.length === 0){
                list.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">Nenhuma transação encontrada.</td></tr>`;
                return;
            }

            sortedTransactions.forEach(t => {
                let typeClass = '', typeText = '', amountClass = '', amountPrefix = '';
                
                if (t.type === 'revenue') {
                    typeClass = 'bg-green-900 text-green-300';
                    typeText = 'Receita';
                    amountClass = 'text-green-400';
                    amountPrefix = '+';
                } else if (t.type === 'expense') {
                    typeClass = 'bg-red-900 text-red-300';
                    typeText = 'Despesa';
                    amountClass = 'text-red-400';
                    amountPrefix = '-';
                } else if (t.type === 'management_fee') {
                    typeClass = 'bg-yellow-900 text-yellow-300';
                    typeText = 'Taxa Gerência';
                    amountClass = 'text-yellow-400';
                    amountPrefix = '-';
                }

                const row = `
                    <tr class="border-b border-gray-700">
                        <td data-label="Data" class="p-4">${formatDate(t.date)}</td>
                        <td data-label="Descrição" class="p-4">${t.description}</td>
                        <td data-label="Tipo" class="p-4">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${typeClass}">
                                ${typeText}
                            </span>
                        </td>
                        <td data-label="Valor" class="p-4 text-right font-semibold ${amountClass}">
                            ${amountPrefix} ${formatCurrency(t.amount)}
                        </td>
                        <td data-label="Ações" class="p-4 text-center actions-cell">
                           <div class="flex items-center justify-center md:justify-center space-x-2">
                                <button data-id="${t.id}" class="edit-transaction-btn text-gray-400 hover:text-cyan-400 transition-colors p-1 rounded-full" title="Editar Transação">
                                    <i data-lucide="edit" class="h-4 w-4"></i>
                                </button>
                                <button data-id="${t.id}" class="delete-transaction-btn text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full" title="Excluir Transação">
                                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                                </button>
                           </div>
                        </td>
                    </tr>
                `;
                list.innerHTML += row;
            });
        };

        const checkAlerts = () => {
            const container = document.getElementById('alerts-container');
            const notificationBadge = document.querySelector('#notifications-tab-btn .notification-badge');
            const notificationsTabBtn = document.getElementById('notifications-tab-btn');
            container.innerHTML = '';
            let alertCount = 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            items.forEach(item => {
                if (!item.rentedTo || item.paymentFrequency === 'single') return;

                const endDate = new Date(item.rentEndDate + 'T00:00:00');
                
                if (today > endDate && !item.endOfContractNotified) {
                    alertCount++;
                    const alertHTML = `
                        <div class="bg-red-900/50 border border-red-700 p-4 rounded-lg flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                            <div>
                                <p class="font-semibold text-red-300">O contrato de "${item.name}" terminou.</p>
                                <p class="text-sm text-red-400">Ação necessária: renovar, finalizar ou deixar pendente.</p>
                            </div>
                            <button data-id="${item.id}" class="resolve-contract-end-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-md text-sm whitespace-nowrap self-end sm:self-center">Resolver</button>
                        </div>
                    `;
                    container.innerHTML += alertHTML;
                    return; 
                }

                const startDate = new Date(item.rentStartDate + 'T00:00:00');
                let firstPaymentDueDate = new Date(startDate);

                if (item.paymentFrequency === 'monthly') {
                     firstPaymentDueDate.setMonth(firstPaymentDueDate.getMonth() + 1);
                     firstPaymentDueDate.setDate(item.paymentDay);
                } else if (item.paymentFrequency === 'weekly') {
                    firstPaymentDueDate.setDate(firstPaymentDueDate.getDate() + 7);
                } else if (item.paymentFrequency === 'daily') {
                    firstPaymentDueDate.setDate(firstPaymentDueDate.getDate() + 1);
                }
                
                if (today < firstPaymentDueDate) {
                    return; 
                }

                const paymentDueDateThisMonth = new Date(today.getFullYear(), today.getMonth(), item.paymentDay);
                const lastPaymentDate = item.lastPaymentAlertDate ? new Date(item.lastPaymentAlertDate) : null;

                if (today >= paymentDueDateThisMonth && (!lastPaymentDate || lastPaymentDate < paymentDueDateThisMonth)) {
                    alertCount++;
                    const alertHTML = `
                        <div class="bg-yellow-900/50 border border-yellow-700 p-4 rounded-lg flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                            <div>
                                <p class="font-semibold text-yellow-300">Pagamento de "${item.name}" está pendente este mês.</p>
                                <p class="text-sm text-yellow-400">A data de vencimento foi dia ${item.paymentDay}.</p>
                            </div>
                            <button data-id="${item.id}" class="resolve-payment-btn bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-3 rounded-md text-sm whitespace-nowrap self-end sm:self-center">Resolver</button>
                        </div>
                    `;
                    container.innerHTML += alertHTML;
                }
            });

            notificationBadge.textContent = alertCount;
            if (alertCount > 0) {
                notificationsTabBtn.classList.add('has-notifications');
            } else {
                notificationsTabBtn.classList.remove('has-notifications');
                container.innerHTML = `<p class="text-gray-400">Nenhum alerta no momento.</p>`;
            }
        };
        
        const renderBalanceCard = (year, month) => {
            const balance = transactions.reduce((acc, t) => {
                const tDate = new Date(t.date);
                if (tDate.getMonth() === month && tDate.getFullYear() === year) {
                    return acc + (t.type === 'revenue' ? t.amount : -t.amount);
                }
                return acc;
            }, 0);

            const monthName = new Date(year, month).toLocaleString('pt-BR', { month: 'long' });
            document.getElementById('month-balance-title').textContent = `Saldo de ${monthName}/${year}`;
            document.getElementById('month-balance').textContent = formatCurrency(balance);
        }

        const renderChart = (year) => {
             const ctx = document.getElementById('financialChart').getContext('2d');
             
             let labels = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
             let revenueData = Array(12).fill(0);
             let expenseData = Array(12).fill(0);
             let managementFeeData = Array(12).fill(0);
            
             transactions.forEach(t => {
                 const tDate = new Date(t.date);
                 if (tDate.getFullYear() === year) {
                     const monthIndex = tDate.getMonth();
                     if (t.type === 'revenue') revenueData[monthIndex] += t.amount;
                     else if (t.type === 'expense') expenseData[monthIndex] += t.amount;
                     else if (t.type === 'management_fee') managementFeeData[monthIndex] += t.amount;
                 }
             });

             if (financialChart) {
                 financialChart.destroy();
             }

             financialChart = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: labels,
                     datasets: [{
                         label: 'Receitas',
                         data: revenueData,
                         backgroundColor: 'rgba(16, 185, 129, 0.2)',
                         borderColor: 'rgba(16, 185, 129, 1)',
                         borderWidth: 2,
                         tension: 0.1,
                         fill: true,
                     }, {
                         label: 'Despesas',
                         data: expenseData,
                         backgroundColor: 'rgba(239, 68, 68, 0.2)',
                         borderColor: 'rgba(239, 68, 68, 1)',
                         borderWidth: 2,
                         tension: 0.1,
                         fill: true,
                     }, {
                        label: 'Taxa de Gerência',
                        data: managementFeeData,
                        backgroundColor: 'rgba(252, 211, 77, 0.2)',
                        borderColor: 'rgba(252, 211, 77, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                     }]
                 },
                 options: {
                     scales: {
                         y: {
                             beginAtZero: true,
                             ticks: { color: '#9ca3af' },
                             grid: { color: '#374151' }
                         },
                         x: {
                             ticks: { color: '#9ca3af' },
                             grid: { color: '#374151' }
                         }
                     },
                     plugins: {
                         legend: {
                             labels: {
                                 color: '#d1d5db'
                             }
                         }
                     },
                     responsive: true,
                     maintainAspectRatio: false
                 }
             });
        };
        
        const applyFiltersAndRender = () => {
            const description = document.getElementById('filterDescription').value.toLowerCase();
            const type = document.getElementById('filterType').value;
            const startDate = document.getElementById('filterStartDate').value;

            let filtered = transactions.filter(t => {
                const tDate = new Date(t.date + 'T00:00:00');
                const start = startDate ? new Date(startDate + 'T00:00:00') : null;
                
                const matchesDescription = t.description.toLowerCase().includes(description);
                const matchesType = type === 'all' || t.type === type;
                const matchesDate = !start || tDate >= start;

                return matchesDescription && matchesType && matchesDate;
            });
            renderTransactions(filtered);
        };

        // --- Funções de Utilitários ---
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatDate = (dateString) => {
            if(!dateString) return '';
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('pt-BR');
        };
        const dateToYMD = (date) => date.toISOString().split('T')[0];
        const getTodayDateString = () => dateToYMD(new Date());
        const showModal = (modalId) => document.getElementById(modalId).classList.add('active');
        const hideModal = (modalId) => document.getElementById(modalId).classList.remove('active');

        const populateTransactionItemSelect = (selectElementId, selectedId) => {
            const select = document.getElementById(selectElementId);
            select.innerHTML = '<option value="">Nenhum / Outra</option>';

            const rentedItems = items.filter(item => item.rentedTo);
            const availableItems = items.filter(item => !item.rentedTo);

            if (rentedItems.length > 0) {
                const rentedGroup = document.createElement('optgroup');
                rentedGroup.label = 'Alugados';
                rentedItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} (Inquilino: ${item.rentedTo})`;
                    rentedGroup.appendChild(option);
                });
                select.appendChild(rentedGroup);
            }

            if (availableItems.length > 0) {
                const availableGroup = document.createElement('optgroup');
                availableGroup.label = 'Disponíveis';
                availableItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    availableGroup.appendChild(option);
                });
                select.appendChild(availableGroup);
            }

            if (selectedId) {
                select.value = selectedId;
            }
        };

        const showConfirmModal = (title, message, onConfirmCallback) => {
            document.getElementById('confirmActionTitle').textContent = title;
            document.getElementById('confirmActionMessage').textContent = message;
            onConfirm = onConfirmCallback;
            showModal('confirmActionModal');
        };

        const switchTab = (tabId) => {
            tabButtons.forEach(btn => {
                btn.classList.toggle('active-tab', btn.dataset.tab === tabId);
                btn.classList.toggle('border-cyan-500', btn.dataset.tab === tabId);
                btn.classList.toggle('text-cyan-400', btn.dataset.tab === tabId);
                btn.classList.toggle('border-transparent', btn.dataset.tab !== tabId);
                btn.classList.toggle('text-gray-400', btn.dataset.tab !== tabId);
            });
            tabContents.forEach(content => content.classList.add('hidden'));
            document.getElementById(`${tabId}-content`).classList.remove('hidden');
        };
        
        const finalizeRental = (itemId) => {
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.rentedTo = null;
                item.rentStartDate = null;
                item.rentEndDate = null;
                item.rentValue = null;
                item.paymentDay = null;
                item.lastPaymentAlertDate = null;
                item.endOfContractNotified = false;
                item.renewalPending = false;
                item.tenantPhone = null;
                item.tenantCPF = null;
            }
        };
        
        const updateDashboardView = () => {
            const year = parseInt(document.getElementById('filterYear').value);
            const month = parseInt(document.getElementById('filterMonth').value);
            renderBalanceCard(year, month);
            renderChart(year);
        }
        
        const initDashboardFilters = () => {
            const monthSelect = document.getElementById('filterMonth');
            const yearSelect = document.getElementById('filterYear');
            const now = new Date();
            
            // Populate months
            for(let i=0; i<12; i++) {
                const monthName = new Date(2000, i).toLocaleString('pt-BR', {month: 'long'});
                monthSelect.innerHTML += `<option value="${i}">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</option>`;
            }
            
            // Populate years
            const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))];
            if (!years.includes(now.getFullYear())) {
                years.push(now.getFullYear());
            }
            years.sort((a,b) => b-a);
            years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);

            // Set current month/year
            monthSelect.value = now.getMonth();
            yearSelect.value = now.getFullYear();
            
            monthSelect.addEventListener('change', updateDashboardView);
            yearSelect.addEventListener('change', updateDashboardView);
        }

        // --- Manipuladores de Eventos ---

        // Navegação por Abas
        tabButtons.forEach(button => {
            button.addEventListener('click', () => switchTab(button.dataset.tab));
        });
        
        // Abrir Modais
        document.getElementById('openAddItemModal').addEventListener('click', () => {
            addItemForm.reset();
            document.getElementById('itemCategorySelect').value = "";
            document.getElementById('imovelFieldsWrapper').classList.add('hidden');
            document.getElementById('itemCategoryOtherWrapper').classList.add('hidden');
            showModal('addItemModal');
        });
        
        document.getElementById('openAddTransactionModalRevenue').addEventListener('click', () => {
            document.getElementById('transactionModalTitle').textContent = 'Adicionar Receita';
            document.getElementById('transactionType').value = 'revenue';
            document.getElementById('managementFeeContainer').style.display = 'block';
            addTransactionForm.reset();
            document.getElementById('transactionDate').value = getTodayDateString();
            populateTransactionItemSelect('transactionItemLink');
            showModal('addTransactionModal');
        });

        document.getElementById('openAddTransactionModalExpense').addEventListener('click', () => {
            document.getElementById('transactionModalTitle').textContent = 'Adicionar Despesa';
            document.getElementById('transactionType').value = 'expense';
            document.getElementById('managementFeeContainer').style.display = 'none';
            addTransactionForm.reset();
            document.getElementById('transactionDate').value = getTodayDateString();
            populateTransactionItemSelect('transactionItemLink');
            showModal('addTransactionModal');
        });

        // Fechar Modais
        modals.forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal') || e.target.classList.contains('modal-close-btn')) {
                    hideModal(modal.id);
                }
            });
        });

        // Lógica de Categoria Dinâmica
        document.getElementById('itemCategorySelect').addEventListener('change', (e) => {
            document.getElementById('itemCategoryOtherWrapper').classList.toggle('hidden', e.target.value !== 'outro');
            document.getElementById('imovelFieldsWrapper').classList.toggle('hidden', e.target.value !== 'Imóvel');
        });
        document.getElementById('editItemCategorySelect').addEventListener('change', (e) => {
            document.getElementById('editItemCategoryOtherWrapper').classList.toggle('hidden', e.target.value !== 'outro');
            document.getElementById('editImovelFieldsWrapper').classList.toggle('hidden', e.target.value !== 'Imóvel');
        });
        
        // Lógica dos Filtros
        ['filterDescription', 'filterType', 'filterStartDate'].forEach(id => {
            document.getElementById(id).addEventListener('input', applyFiltersAndRender);
        });
        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            document.getElementById('filterDescription').value = '';
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterStartDate').value = '';
            applyFiltersAndRender();
        });


        document.getElementById('addTransactionModal').addEventListener('change', (e) => {
            if (e.target.id === 'addManagementFee') {
                document.getElementById('managementFeeDiv').classList.toggle('hidden', !e.target.checked);
            }
            if (e.target.id === 'transactionItemLink') {
                const itemId = e.target.value;
                const amountInput = document.getElementById('transactionAmount');
                if (itemId) {
                    const item = items.find(i => i.id === parseInt(itemId));
                    if (item) {
                        amountInput.value = item.rentedTo ? item.rentValue : item.value;
                    }
                }
            }
        });
        
        document.getElementById('setTenPercentFeeBtn').addEventListener('click', () => {
            const totalAmount = parseFloat(document.getElementById('transactionAmount').value);
            if (!isNaN(totalAmount) && totalAmount > 0) {
                const feeAmount = totalAmount * 0.10;
                document.getElementById('managementFeeAmount').value = feeAmount.toFixed(2);
            }
        });
        
        document.getElementById('setOneYearBtn').addEventListener('click', () => {
            const startDateInput = document.getElementById('rentStartDate');
            const endDateInput = document.getElementById('rentEndDate');
            if(startDateInput.value) {
                const startDate = new Date(startDateInput.value + "T00:00:00");
                startDate.setFullYear(startDate.getFullYear() + 1);
                endDateInput.value = dateToYMD(startDate);
            }
        });

        // Lógica dos Formulários
        addItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const categorySelect = document.getElementById('itemCategorySelect');
            if (!categorySelect.value) {
                alert('Por favor, selecione uma categoria.');
                return;
            }
            let category = categorySelect.value;
            if (category === 'outro') {
                category = document.getElementById('itemCategoryOther').value || 'Outro';
            }

            const newItem = {
                id: Date.now(),
                name: document.getElementById('itemName').value,
                description: document.getElementById('itemDescription').value,
                category: category,
                value: parseFloat(document.getElementById('itemValue').value),
                paymentFrequency: document.getElementById('itemPaymentFrequency').value,
                rentedTo: null,
                endereco: category === 'Imóvel' ? document.getElementById('itemEndereco').value : null,
                cep: category === 'Imóvel' ? document.getElementById('itemCep').value : null,
            };
            items.push(newItem);
            saveData();
            renderAll();
            hideModal('addItemModal');
            addItemForm.reset();
            document.getElementById('imovelFieldsWrapper').classList.add('hidden');
            document.getElementById('itemCategoryOtherWrapper').classList.add('hidden');
        });
        
        editItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const itemId = parseInt(document.getElementById('editItemId').value);
            const item = items.find(i => i.id === itemId);
            if (item) {
                const categorySelect = document.getElementById('editItemCategorySelect');
                 if (!categorySelect.value) {
                    alert('Por favor, selecione uma categoria.');
                    return;
                }
                let category = categorySelect.value;
                if (category === 'outro') {
                    category = document.getElementById('editItemCategoryOther').value || 'Outro';
                }
                item.name = document.getElementById('editItemName').value;
                item.description = document.getElementById('editItemDescription').value;
                item.category = category;
                item.value = parseFloat(document.getElementById('editItemValue').value);
                item.paymentFrequency = document.getElementById('editItemPaymentFrequency').value;
                item.endereco = category === 'Imóvel' ? document.getElementById('editItemEndereco').value : null;
                item.cep = category === 'Imóvel' ? document.getElementById('editItemCep').value : null;
            }
            saveData();
            renderAll();
            hideModal('editItemModal');
        });
        
        editTransactionForm.addEventListener('submit', (e) => {
             e.preventDefault();
             const transactionId = parseInt(document.getElementById('editTransactionId').value);
             const transaction = transactions.find(t => t.id === transactionId);
             if (transaction) {
                 transaction.description = document.getElementById('editTransactionDescription').value;
                 transaction.amount = parseFloat(document.getElementById('editTransactionAmount').value);
                 transaction.date = document.getElementById('editTransactionDate').value;
             }
             saveData();
             renderAll();
             hideModal('editTransactionModal');
        });
        
        app.addEventListener('click', (e) => {
            const rentButton = e.target.closest('.rent-btn');
            if (rentButton) {
                const itemId = parseInt(rentButton.dataset.id);
                const item = items.find(i => i.id === itemId);
                
                rentItemForm.reset();
                document.getElementById('rentModalTitle').textContent = "Registrar Aluguel";
                document.getElementById('rentItemId').value = item.id;
                document.getElementById('rentValue').value = item.value;
                document.getElementById('rentStartDate').value = getTodayDateString();
                showModal('rentItemModal');
            }
            
            const editRentButton = e.target.closest('.edit-rent-btn');
            if (editRentButton) {
                const itemId = parseInt(editRentButton.dataset.id);
                const item = items.find(i => i.id === itemId);

                document.getElementById('rentModalTitle').textContent = "Editar Aluguel";
                document.getElementById('rentItemId').value = item.id;
                document.getElementById('tenantName').value = item.rentedTo;
                document.getElementById('tenantPhone').value = item.tenantPhone || '';
                document.getElementById('tenantCPF').value = item.tenantCPF || '';
                document.getElementById('rentStartDate').value = item.rentStartDate;
                document.getElementById('rentEndDate').value = item.rentEndDate;
                document.getElementById('rentValue').value = item.rentValue;
                document.getElementById('paymentDay').value = item.paymentDay;
                showModal('rentItemModal');
            }
            
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const itemId = parseInt(deleteButton.dataset.id);
                const item = items.find(i => i.id === itemId);

                if (item.rentedTo) {
                    showConfirmModal(
                        'Finalizar Aluguel',
                        `Isso irá finalizar o aluguel do item "${item.name}" e o tornará disponível. Deseja continuar?`,
                        () => {
                            finalizeRental(itemId);
                            saveData();
                            renderAll();
                        }
                    );
                } else {
                    showConfirmModal(
                        'Apagar Item',
                        `Você tem certeza que deseja apagar o item "${item.name}"? Esta ação não pode ser desfeita.`,
                        () => {
                            items = items.filter(i => i.id !== itemId);
                            saveData();
                            renderAll();
                        }
                    );
                }
            }
            
            const editItemButton = e.target.closest('.edit-item-btn');
            if (editItemButton) {
                const itemId = parseInt(editItemButton.dataset.id);
                const item = items.find(i => i.id === itemId);
                document.getElementById('editItemId').value = item.id;
                document.getElementById('editItemName').value = item.name;
                document.getElementById('editItemDescription').value = item.description;
                document.getElementById('editItemValue').value = item.value;
                document.getElementById('editItemPaymentFrequency').value = item.paymentFrequency;

                const categorySelect = document.getElementById('editItemCategorySelect');
                const otherWrapper = document.getElementById('editItemCategoryOtherWrapper');
                const otherInput = document.getElementById('editItemCategoryOther');
                const imovelWrapper = document.getElementById('editImovelFieldsWrapper');

                const predefinedCategories = Array.from(categorySelect.options).map(opt => opt.value);
                if (predefinedCategories.includes(item.category) && item.category !== 'outro') {
                    categorySelect.value = item.category;
                    otherWrapper.classList.add('hidden');
                } else {
                    categorySelect.value = 'outro';
                    otherInput.value = item.category;
                    otherWrapper.classList.remove('hidden');
                }
                
                imovelWrapper.classList.toggle('hidden', categorySelect.value !== 'Imóvel');
                if(categorySelect.value === 'Imóvel') {
                    document.getElementById('editItemEndereco').value = item.endereco || '';
                    document.getElementById('editItemCep').value = item.cep || '';
                }

                showModal('editItemModal');
            }
            
            const editTransactionButton = e.target.closest('.edit-transaction-btn');
            if (editTransactionButton) {
                const transactionId = parseInt(editTransactionButton.dataset.id);
                const transaction = transactions.find(t => t.id === transactionId);
                document.getElementById('editTransactionId').value = transaction.id;
                document.getElementById('editTransactionDescription').value = transaction.description;
                document.getElementById('editTransactionAmount').value = transaction.amount;
                document.getElementById('editTransactionDate').value = transaction.date;
                showModal('editTransactionModal');
            }

            const deleteTransactionButton = e.target.closest('.delete-transaction-btn');
            if (deleteTransactionButton) {
                const transactionId = parseInt(deleteTransactionButton.dataset.id);
                const transaction = transactions.find(t => t.id === transactionId);
                showConfirmModal(
                    'Excluir Transação',
                    `Você tem certeza que deseja excluir a transação "${transaction.description}"? Esta ação não pode ser desfeita.`,
                    () => {
                        transactions = transactions.filter(t => t.id !== transactionId);
                        saveData();
                        renderAll();
                    }
                );
            }
            
            const resolvePaymentBtn = e.target.closest('.resolve-payment-btn');
            if(resolvePaymentBtn) {
                 const itemId = parseInt(resolvePaymentBtn.dataset.id);
                 const item = items.find(i => i.id === itemId);
                 document.getElementById('paymentAlertItemId').value = item.id;
                 document.getElementById('paymentAlertItemName').textContent = item.name;
                 showModal('paymentAlertModal');
            }
            
            const resolveContractEndBtn = e.target.closest('.resolve-contract-end-btn');
            if(resolveContractEndBtn) {
                 const itemId = parseInt(resolveContractEndBtn.dataset.id);
                 const item = items.find(i => i.id === itemId);
                 document.getElementById('contractEndItemId').value = item.id;
                 document.getElementById('contractEndItemName').textContent = item.name;
                 showModal('contractEndModal');
            }
        });

        rentItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const itemId = parseInt(document.getElementById('rentItemId').value);
            const item = items.find(i => i.id === itemId);

            item.rentedTo = document.getElementById('tenantName').value;
            item.tenantPhone = document.getElementById('tenantPhone').value;
            item.tenantCPF = document.getElementById('tenantCPF').value;
            item.rentStartDate = document.getElementById('rentStartDate').value;
            item.rentEndDate = document.getElementById('rentEndDate').value;
            item.rentValue = parseFloat(document.getElementById('rentValue').value);
            item.paymentDay = parseInt(document.getElementById('paymentDay').value);
            
            const isNewRental = !item.endOfContractNotified;
            if(isNewRental){
                item.lastPaymentAlertDate = null;
                item.endOfContractNotified = false;
                item.renewalPending = false;
            }
            
            saveData();
            renderAll();
            hideModal('rentItemModal');
            rentItemForm.reset();
        });

        addTransactionForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const selectedItemId = document.getElementById('transactionItemLink').value;
            const description = document.getElementById('transactionDescription').value;
            let finalDescription = description;

            if (selectedItemId) {
                const selectedItem = items.find(i => i.id === parseInt(selectedItemId));
                if (selectedItem) {
                    finalDescription = `[${selectedItem.name}] ${description}`;
                }
            }

            const newTransaction = {
                id: Date.now(),
                type: document.getElementById('transactionType').value,
                description: finalDescription,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                date: document.getElementById('transactionDate').value,
                itemId: selectedItemId ? parseInt(selectedItemId) : null
            };
            transactions.push(newTransaction);

            const addFee = document.getElementById('addManagementFee').checked;
            const feeAmount = parseFloat(document.getElementById('managementFeeAmount').value);

            if (addFee && !isNaN(feeAmount) && feeAmount > 0 && newTransaction.type === 'revenue') {
                const feeTransaction = {
                    id: Date.now() + 1,
                    type: 'management_fee',
                    description: `Taxa de Gerência - ${finalDescription}`,
                    amount: feeAmount,
                    date: newTransaction.date,
                    itemId: newTransaction.itemId
                };
                transactions.push(feeTransaction);
            }

            saveData();
            renderAll();
            hideModal('addTransactionModal');
            addTransactionForm.reset();
        });
        
        // --- Handlers para Modais de Alerta ---

        document.getElementById('paymentReceivedBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('paymentAlertItemId').value);
            const item = items.find(i => i.id === itemId);
            
            item.lastPaymentAlertDate = getTodayDateString();
            saveData(); 
            hideModal('paymentAlertModal');
            
            switchTab('finance');
            
            document.getElementById('transactionModalTitle').textContent = 'Adicionar Receita';
            document.getElementById('transactionType').value = 'revenue';
            document.getElementById('managementFeeContainer').style.display = 'block';
            addTransactionForm.reset();
            document.getElementById('transactionDate').value = getTodayDateString();
            populateTransactionItemSelect('transactionItemLink', item.id);
            document.getElementById('transactionDescription').value = `Recebimento aluguel: ${item.name}`;
            document.getElementById('transactionAmount').value = item.rentValue;
            showModal('addTransactionModal');

            renderAll();
        });

        document.getElementById('snoozePaymentBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('paymentAlertItemId').value);
            const item = items.find(i => i.id === itemId);
            const today = new Date();
            today.setDate(today.getDate() + 7);
            item.lastPaymentAlertDate = dateToYMD(today);
            saveData();
            renderAll();
            hideModal('paymentAlertModal');
        });

        document.getElementById('forgetReminderBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('paymentAlertItemId').value);
            const item = items.find(i => i.id === itemId);
            const today = new Date();
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            item.lastPaymentAlertDate = dateToYMD(endOfMonth);
            saveData();
            renderAll();
            hideModal('paymentAlertModal');
        });
        
        document.getElementById('setPaymentPendingBtn').addEventListener('click', () => {
             hideModal('paymentAlertModal');
        });

        document.getElementById('renewContractBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('contractEndItemId').value);
            const item = items.find(i => i.id === itemId);
            
            item.endOfContractNotified = true;
            saveData();
            hideModal('contractEndModal');
            
            document.getElementById('rentModalTitle').textContent = "Renovar Aluguel";
            document.getElementById('rentItemId').value = item.id;
            document.getElementById('rentValue').value = item.rentValue;
            const newStartDate = new Date(item.rentEndDate + 'T00:00:00');
            newStartDate.setDate(newStartDate.getDate() + 1);
            document.getElementById('rentStartDate').value = dateToYMD(newStartDate);
            document.getElementById('rentEndDate').value = '';
            document.getElementById('tenantName').value = item.rentedTo;
            document.getElementById('paymentDay').value = item.paymentDay;
            showModal('rentItemModal');
            renderAll();
        });

        document.getElementById('setRenewalPendingBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('contractEndItemId').value);
            const item = items.find(i => i.id === itemId);
            item.renewalPending = true;
            item.endOfContractNotified = true;
            saveData();
            renderAll();
            hideModal('contractEndModal');
        });
        
        document.getElementById('endContractBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('contractEndItemId').value);
            const item = items.find(i => i.id === itemId);
            
            finalizeRental(itemId);
            saveData();
            renderAll();
            hideModal('contractEndModal');
        });
        
        document.getElementById('confirmActionConfirm').addEventListener('click', () => {
            if (typeof onConfirm === 'function') {
                onConfirm();
            }
            hideModal('confirmActionModal');
            onConfirm = null;
        });

        document.getElementById('confirmActionCancel').addEventListener('click', () => {
            hideModal('confirmActionModal');
            onConfirm = null;
        });

        // Carga Inicial
        loadData();
        initDashboardFilters();
        renderAll();
    });
    </script>
</body>
</html>

