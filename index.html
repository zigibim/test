<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Aluguéis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .tab-button .notification-badge {
            display: none;
        }
        .tab-button.has-notifications .notification-badge {
            display: inline-flex;
        }
        /* Hide scrollbar for tabs navigation */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Responsive table for transactions */
        @media (max-width: 767px) {
            #transactions-list thead {
                display: none;
            }
            #transactions-list tr {
                display: block;
                border: 1px solid #374151; /* gray-700 */
                border-radius: 0.75rem; /* rounded-xl */
                margin-bottom: 1rem;
                background-color: #1f2937; /* gray-800 */
            }
            #transactions-list td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 1rem;
                text-align: right;
                border-bottom: 1px solid #374151; /* gray-700 */
            }
            #transactions-list td:last-child {
                border-bottom: 0;
            }
            #transactions-list td:before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                margin-right: 1rem;
                color: #9ca3af; /* gray-400 */
            }
            #transactions-list .actions-cell {
                justify-content: flex-end; /* Align buttons to the right */
            }
             #transactions-list .actions-cell:before {
                margin-right: auto;
             }
        }
        
        /* Shake animation for login error */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Bottom Nav Active State */
        .bottom-nav-btn.active-tab {
            color: #22d3ee; /* cyan-400 */
        }

        .settings-tab-button.active-settings-tab {
            background-color: #374151;
            color: #e5e7eb;
        }
        
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">

    <div id="login-screen" class="fixed inset-0 bg-gray-900 flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400 mb-8">Gestor de Aluguéis</h1>
            <form id="login-form" class="bg-gray-800 p-8 rounded-xl shadow-lg space-y-6">
                <div>
                    <label for="password" class="block text-left mb-2 font-medium text-gray-300">Senha de Acesso</label>
                    <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition" placeholder="••••••••">
                    <p id="login-error" class="text-red-400 text-sm mt-2 text-left hidden">Senha incorreta. Tente novamente.</p>
                </div>
                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-2 sm:p-6 lg:p-8 hidden pb-24 md:pb-8">
        
        <!-- Cabeçalho -->
        <header class="flex justify-between items-center mb-6">
            <h1 id="app-title" class="text-2xl sm:text-3xl font-bold text-cyan-400">Meu Gestor de Aluguéis</h1>
            <div class="flex items-center space-x-2">
                <button id="settingsBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-lg flex items-center transition-colors" title="Configurações">
                    <i data-lucide="settings" class="h-5 w-5"></i>
                </button>
                <button id="logoutBtn" class="bg-red-800 hover:bg-red-700 text-white font-bold p-2 rounded-lg flex items-center transition-colors" title="Sair">
                    <i data-lucide="log-out" class="h-5 w-5"></i>
                </button>
            </div>
        </header>

        <!-- Navegação Principal (Desktop) -->
        <div class="mb-6 hidden md:block">
            <div class="border-b border-gray-700">
                <nav id="top-nav" class="-mb-px flex space-x-6 overflow-x-auto no-scrollbar" aria-label="Tabs">
                    <button class="tab-button active-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-cyan-500 text-cyan-400" data-tab="dashboard"><span>Painel</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="items"><span id="top-nav-items-text">Meus Itens</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="rentals"><span id="top-nav-rentals-text">Meus Aluguéis</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="finance"><span>Financeiro</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 relative" data-tab="notifications">
                        <span>Notificações</span>
                        <span id="top-nav-badge" class="notification-badge absolute top-3 -right-4 ml-2 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                    </button>
                    <button id="gestores-main-tab" class="tab-button hidden whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="gestores"><span>Gestores</span></button>
                </nav>
            </div>
        </div>

        <!-- Conteúdo das Abas -->
        <main>
            <!-- Aba Painel -->
            <div id="dashboard-content" class="tab-content">
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-8">
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="package" class="h-8 w-8 text-cyan-400"></i>
                        <div>
                            <h3 id="total-items-title" class="text-sm font-medium text-gray-400">Total de Itens</h3>
                            <p id="total-items" class="mt-1 text-xl sm:text-3xl font-semibold">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex items-center gap-4">
                         <i data-lucide="package-x" class="h-8 w-8 text-cyan-400"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-400">Alugados</h3>
                            <p id="rented-items" class="mt-1 text-xl sm:text-3xl font-semibold">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="package-check" class="h-8 w-8 text-cyan-400"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-400">Disponíveis</h3>
                            <p id="available-items" class="mt-1 text-xl sm:text-3xl font-semibold">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="wallet" class="h-8 w-8 text-green-400"></i>
                        <div>
                            <h3 id="month-balance-title" class="text-sm font-medium text-gray-400">Saldo do Mês</h3>
                            <p id="month-balance" class="mt-1 text-xl sm:text-3xl font-semibold">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="arrow-down-circle" class="h-8 w-8 text-red-400"></i>
                        <div>
                             <h3 id="month-expense-title" class="text-sm font-medium text-gray-400">Despesas</h3>
                            <p id="month-expense" class="mt-1 text-xl sm:text-3xl font-semibold text-red-400">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="percent" class="h-8 w-8 text-yellow-400"></i>
                        <div>
                            <h3 id="month-fee-title" class="text-sm font-medium text-gray-400">Taxa Gerência</h3>
                            <p id="month-fee" class="mt-1 text-xl sm:text-3xl font-semibold text-yellow-400">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <!-- Gráfico Financeiro -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                         <h2 id="financial-overview-title" class="text-lg sm:text-xl font-semibold">Visão Geral Financeira</h2>
                         <div class="flex flex-wrap items-center gap-4 self-start md:self-center">
                            <div class="flex items-center gap-2">
                                <label for="chart-view" class="text-sm">Visualização:</label>
                                <select id="chart-view" class="bg-gray-700 border border-gray-600 rounded-md px-2 sm:px-3 py-1 text-sm">
                                    <option value="monthly">Mensal</option>
                                    <option value="yearly">Anual</option>
                                </select>
                            </div>
                            <div id="monthly-filters" class="flex items-center gap-2">
                                <label for="filterMonth" class="text-sm">Mês:</label>
                                <select id="filterMonth" class="bg-gray-700 border border-gray-600 rounded-md px-2 sm:px-3 py-1 text-sm"></select>
                                <label for="filterYear" class="text-sm">Ano:</label>
                                <select id="filterYear" class="bg-gray-700 border border-gray-600 rounded-md px-2 sm:px-3 py-1 text-sm"></select>
                            </div>
                       </div>
                    </div>
                    <div class="h-[300px] sm:h-[350px]">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Aba Meus Itens -->
            <div id="items-content" class="tab-content hidden">
                <div class="mb-6 text-right">
                    <button id="openAddItemModal" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105 inline-flex">
                       <i data-lucide="plus-circle" class="h-5 w-5 mr-2"></i>
                       <span>Adicionar Item</span>
                   </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="package-check" class="mr-3 text-green-400"></i>Disponíveis para Alugar</h2>
                        <div id="available-list" class="space-y-4">
                            <!-- Itens disponíveis aqui -->
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="package-x" class="mr-3 text-red-400"></i>Atualmente Alugados</h2>
                        <div id="rented-list" class="space-y-4">
                            <!-- Itens alugados aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Meus Aluguéis -->
            <div id="rentals-content" class="tab-content hidden">
                <h2 id="rentals-title" class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="calendar-clock" class="mr-3 text-cyan-400"></i>Aluguéis Ativos (por pendência)</h2>
                <div id="sorted-rentals-list" class="space-y-4">
                    <!-- Sorted rented items will be inserted here -->
                </div>
            </div>

            <!-- Aba Financeiro -->
            <div id="finance-content" class="tab-content hidden">
                 <div class="flex flex-wrap gap-4 mb-6">
                     <button id="openAddTransactionModalRevenue" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                         <i data-lucide="trending-up" class="mr-2 h-5 w-5"></i>
                         <span>Adicionar Receita</span>
                     </button>
                     <button id="openAddTransactionModalExpense" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                         <i data-lucide="trending-down" class="mr-2 h-5 w-5"></i>
                         <span>Adicionar Despesa</span>
                     </button>
                     <button id="openTaxReportModal" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                         <i data-lucide="file-text" class="mr-2 h-5 w-5"></i>
                         <span>Planilha de Imposto de Renda</span>
                     </button>
                 </div>

                 <!-- Filtros de Transações -->
                 <div class="bg-gray-800 p-4 rounded-xl mb-6">
                    <h3 class="text-lg font-semibold mb-3">Filtrar Transações</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="sm:col-span-2 lg:col-span-2">
                            <label for="filterDescription" class="block text-sm font-medium mb-1">Descrição</label>
                            <input type="text" id="filterDescription" placeholder="Filtrar por descrição..." class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
                        </div>
                        <div>
                            <label for="filterType" class="block text-sm font-medium mb-1">Tipo</label>
                            <select id="filterType" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
                                <option value="all">Todos</option>
                                <option value="revenue">Receita</option>
                                <option value="expense">Despesa</option>
                                <option value="management_fee">Taxa de Gerência</option>
                            </select>
                        </div>
                         <div class="flex items-end space-x-2">
                            <div class="flex-grow">
                                <label for="filterStartDate" class="block text-sm font-medium mb-1">A partir de</label>
                                <input type="date" id="filterStartDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
                            </div>
                            <button id="clearFiltersBtn" title="Limpar Filtros" class="bg-gray-600 hover:bg-gray-500 text-white font-bold p-2 rounded-md text-sm">
                                <i data-lucide="rotate-ccw" class="h-5 w-5"></i>
                            </button>
                        </div>
                    </div>
                 </div>

                 <h2 class="text-xl sm:text-2xl font-semibold mb-4">Histórico de Transações</h2>
                 <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                     <div class="overflow-x-auto">
                         <table class="w-full text-left">
                             <thead class="bg-gray-700">
                                 <tr>
                                     <th class="p-4">Data</th>
                                     <th class="p-4">Descrição</th>
                                     <th class="p-4">Tipo</th>
                                     <th class="p-4 text-right">Valor</th>
                                     <th class="p-4 text-center">Ações</th>
                                 </tr>
                             </thead>
                             <tbody id="transactions-list">
                                 <!-- Transações aqui -->
                             </tbody>
                         </table>
                     </div>
                 </div>
            </div>

            <!-- Aba Notificações -->
            <div id="notifications-content" class="tab-content hidden">
                <div id="alerts-section">
                     <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="bell-ring" class="mr-3 text-yellow-400"></i>Alertas Pendentes</h2>
                     <div id="alerts-container" class="space-y-4">
                         <!-- Alertas serão inseridos aqui -->
                     </div>
                </div>
            </div>

            <!-- Aba Gestores (Admin view) -->
            <div id="gestores-content" class="tab-content hidden">
                 <h2 class="text-xl sm:text-2xl font-semibold mb-4">Painel de Gestores</h2>
                 <div id="admin-managers-dashboard" class="space-y-6">
                    <!-- Cards de resumo dos gestores serão inseridos aqui -->
                 </div>
            </div>
        </main>
    </div>

    <!-- Navegação Inferior (Mobile) -->
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around p-2 z-40 overflow-x-auto no-scrollbar">
        <button class="tab-button bottom-nav-btn active-tab flex flex-col items-center text-gray-400 p-2" data-tab="dashboard">
            <i data-lucide="layout-dashboard" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Painel</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2" data-tab="items">
            <i data-lucide="archive" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Itens</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2" data-tab="rentals">
            <i data-lucide="calendar-clock" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Aluguéis</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2" data-tab="finance">
            <i data-lucide="piggy-bank" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Financeiro</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2 relative" data-tab="notifications">
            <i data-lucide="bell" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Notificações</span>
            <span id="bottom-nav-badge" class="notification-badge absolute top-1 right-3 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
        </button>
         <button id="gestores-bottom-tab" class="tab-button bottom-nav-btn hidden flex-col items-center text-gray-400 p-2" data-tab="gestores">
            <i data-lucide="users" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Gestores</span>
        </button>
    </nav>


    <!-- Modal Adicionar Item -->
    <div id="addItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="addItemForm">
                <h2 class="text-2xl font-bold mb-4">Adicionar Novo Item</h2>
                <div class="space-y-4">
                    <div>
                        <label for="itemName" class="block mb-1 font-medium">Nome do Item/Serviço</label>
                        <input type="text" id="itemName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="itemDescription" class="block mb-1 font-medium">Descrição</label>
                        <textarea id="itemDescription" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Ex: Apartamento de 2 quartos, carro ano 2020..."></textarea>
                    </div>
                    <div>
                        <label for="itemCategorySelect" class="block mb-1 font-medium">Categoria</label>
                        <select id="itemCategorySelect" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <option value="" disabled selected>Selecione uma categoria...</option>
                            <option value="Imóvel">Imóvel</option>
                            <option value="Veículo">Veículo</option>
                            <option value="Equipamento">Equipamento</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div id="itemCategoryOtherWrapper" class="hidden">
                        <label for="itemCategoryOther" class="block mb-1 font-medium">Qual categoria?</label>
                        <input type="text" id="itemCategoryOther" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                    </div>
                    <div id="imovelFieldsWrapper" class="hidden space-y-4 border-t border-gray-700 pt-4 mt-4">
                        <div>
                            <label for="itemEndereco" class="block mb-1 font-medium">Endereço (Opcional)</label>
                            <input type="text" id="itemEndereco" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="itemCep" class="block mb-1 font-medium">CEP (Opcional)</label>
                            <input type="text" id="itemCep" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="itemManagedBy" class="block mb-1 font-medium">Gerido por: (Opcional)</label>
                            <select id="itemManagedBy" class="itemManagedBySelect w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                                <option value="particular" selected>Particular</option>
                                <option value="imobiliaria">Imobiliária</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="itemManagerNameWrapper hidden">
                            <label for="itemManagerName" class="block mb-1 font-medium">Nome da Imobiliária/Outro</label>
                            <input type="text" id="itemManagerName" class="itemManagerNameInput w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div class="itemFeeWrapper hidden space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="itemHasManagementFee" class="h-5 w-5 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600">
                                <span>Incluir taxa de gerência automática?</span>
                            </label>
                            <div class="itemFeePercentageWrapper hidden">
                                <label for="itemManagementFeePercentage" class="block mb-1 font-medium">Taxa (%)</label>
                                <input type="number" id="itemManagementFeePercentage" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" value="10">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="itemValue" class="block mb-1 font-medium">Valor Padrão do Aluguel (R$)</label>
                        <input type="number" step="0.01" id="itemValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="itemPaymentFrequency" class="block mb-1 font-medium">Frequência de Recebimento</label>
                        <select id="itemPaymentFrequency" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                            <option value="monthly">Mensal</option>
                            <option value="weekly">Semanal</option>
                            <option value="daily">Diário</option>
                            <option value="single">Pagamento Único</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Editar Item -->
    <div id="editItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="editItemForm">
                <h2 class="text-2xl font-bold mb-4">Editar Item</h2>
                <input type="hidden" id="editItemId">
                <div class="space-y-4">
                    <div>
                        <label for="editItemName" class="block mb-1 font-medium">Nome do Item/Serviço</label>
                        <input type="text" id="editItemName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editItemDescription" class="block mb-1 font-medium">Descrição</label>
                        <textarea id="editItemDescription" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2"></textarea>
                    </div>
                    <div>
                        <label for="editItemCategorySelect" class="block mb-1 font-medium">Categoria</label>
                        <select id="editItemCategorySelect" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <option value="" disabled>Selecione uma categoria...</option>
                            <option value="Imóvel">Imóvel</option>
                            <option value="Veículo">Veículo</option>
                            <option value="Equipamento">Equipamento</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div id="editItemCategoryOtherWrapper" class="hidden">
                        <label for="editItemCategoryOther" class="block mb-1 font-medium">Qual categoria?</label>
                        <input type="text" id="editItemCategoryOther" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                    </div>
                    <div id="editImovelFieldsWrapper" class="hidden space-y-4 border-t border-gray-700 pt-4 mt-4">
                        <div>
                            <label for="editItemEndereco" class="block mb-1 font-medium">Endereço (Opcional)</label>
                            <input type="text" id="editItemEndereco" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="editItemCep" class="block mb-1 font-medium">CEP (Opcional)</label>
                            <input type="text" id="editItemCep" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="editItemManagedBy" class="block mb-1 font-medium">Gerido por: (Opcional)</label>
                            <select id="editItemManagedBy" class="itemManagedBySelect w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                                <option value="particular">Particular</option>
                                <option value="imobiliaria">Imobiliária</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="itemManagerNameWrapper hidden">
                            <label for="editItemManagerName" class="block mb-1 font-medium">Nome da Imobiliária/Outro</label>
                            <input type="text" id="editItemManagerName" class="itemManagerNameInput w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                         <div class="itemFeeWrapper hidden space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="editItemHasManagementFee" class="h-5 w-5 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600">
                                <span>Incluir taxa de gerência automática?</span>
                            </label>
                            <div class="itemFeePercentageWrapper hidden">
                                <label for="editItemManagementFeePercentage" class="block mb-1 font-medium">Taxa (%)</label>
                                <input type="number" id="editItemManagementFeePercentage" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" value="10">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="editItemValue" class="block mb-1 font-medium">Valor Padrão do Aluguel (R$)</label>
                        <input type="number" step="0.01" id="editItemValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editItemPaymentFrequency" class="block mb-1 font-medium">Frequência de Recebimento</label>
                        <select id="editItemPaymentFrequency" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                            <option value="monthly">Mensal</option>
                            <option value="weekly">Semanal</option>
                            <option value="daily">Diário</option>
                            <option value="single">Pagamento Único</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Alugar Item -->
    <div id="rentItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
         <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="rentItemForm">
                <h2 id="rentModalTitle" class="text-2xl font-bold mb-4">Registrar Aluguel</h2>
                <input type="hidden" id="rentItemId">
                <div class="space-y-4">
                    <div>
                        <label for="tenantName" class="block mb-1 font-medium">Nome do Inquilino/Cliente</label>
                        <input type="text" id="tenantName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="tenantPhone" class="block mb-1 font-medium">Telefone (Opcional)</label>
                            <input type="tel" id="tenantPhone" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                        <div>
                            <label for="tenantCPF" class="block mb-1 font-medium">CPF (Opcional)</label>
                            <input type="text" id="tenantCPF" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                        </div>
                    </div>
                    <div>
                        <label for="rentStartDate" class="block mb-1 font-medium">Data de Início</label>
                        <input type="date" id="rentStartDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="rentEndDate" class="block mb-1 font-medium">Data de Término</label>
                        <div class="flex items-center space-x-2">
                            <input type="date" id="rentEndDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <button type="button" id="setOneYearBtn" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-sm whitespace-nowrap">1 Ano</button>
                        </div>
                    </div>
                     <div>
                        <label for="rentValue" class="block mb-1 font-medium">Valor Combinado (R$)</label>
                        <input type="number" step="0.01" id="rentValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="paymentDay" class="block mb-1 font-medium">Dia do Pagamento Mensal</label>
                        <input type="number" id="paymentDay" min="1" max="31" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Ex: 5" required>
                    </div>
                </div>
                <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Confirmar Aluguel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Adicionar Transação -->
    <div id="addTransactionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="addTransactionForm">
                <h2 id="transactionModalTitle" class="text-2xl font-bold mb-4">Adicionar Transação</h2>
                <input type="hidden" id="transactionType">
                <div class="space-y-4">
                    <div>
                        <label for="transactionDescription" class="block mb-1 font-medium">Descrição</label>
                        <input type="text" id="transactionDescription" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="transactionItemLink" class="block mb-1 font-medium">Associar a um Item (Opcional)</label>
                        <select id="transactionItemLink" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="transactionAmount" class="block mb-1 font-medium">Valor (R$)</label>
                        <input type="number" step="0.01" id="transactionAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="transactionDate" class="block mb-1 font-medium">Data</label>
                        <input type="date" id="transactionDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div id="managementFeeContainer" class="border-t border-gray-700 pt-4 mt-4">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="addManagementFee" class="h-5 w-5 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600">
                            <span>Incluir despesa de gerência (taxa)?</span>
                        </label>
                        <div id="managementFeeDiv" class="mt-3 hidden">
                            <label for="managementFeeAmount" class="block mb-1 font-medium">Valor da Taxa de Gerência (R$)</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" step="0.01" id="managementFeeAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                                <button type="button" id="setTenPercentFeeBtn" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-sm whitespace-nowrap">10%</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Editar Transação -->
    <div id="editTransactionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <form id="editTransactionForm">
                <h2 class="text-2xl font-bold mb-4">Editar Transação</h2>
                <input type="hidden" id="editTransactionId">
                <div class="space-y-4">
                    <div>
                        <label for="editTransactionDescription" class="block mb-1 font-medium">Descrição</label>
                        <input type="text" id="editTransactionDescription" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editTransactionAmount" class="block mb-1 font-medium">Valor (R$)</label>
                        <input type="number" step="0.01" id="editTransactionAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editTransactionDate" class="block mb-1 font-medium">Data</label>
                        <input type="date" id="editTransactionDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                </div>
                <div class="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lembrete de Pagamento Mensal -->
    <div id="paymentAlertModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6">
             <h2 class="text-2xl font-bold mb-2">Lembrete de Pagamento</h2>
             <p class="mb-4 text-gray-300">Item: <strong id="paymentAlertItemName" class="text-white"></strong></p>
             <input type="hidden" id="paymentAlertItemId">
             <div class="bg-gray-700 p-4 rounded-md">
                 <p class="mb-3">O pagamento mensal deste item já venceu. O que você gostaria de fazer?</p>
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                     <button id="paymentReceivedBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Recebido</button>
                     <button id="snoozePaymentBtn" class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded-md">Adiar 7 Dias</button>
                     <button id="setPaymentPendingBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Deixar Pendente</button>
                     <button id="forgetReminderBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">Esquecer</button>
                 </div>
             </div>
             <div class="mt-6 flex justify-end">
                 <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Fechar</button>
             </div>
        </div>
    </div>

    <!-- Modal Fim de Contrato -->
    <div id="contractEndModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-2">Fim de Contrato</h2>
            <p class="mb-4 text-gray-300">O contrato para o item <strong id="contractEndItemName" class="text-white"></strong> terminou.</p>
            <input type="hidden" id="contractEndItemId">
            <div class="bg-gray-700 p-4 rounded-md">
                <p class="mb-3">O que você gostaria de fazer a seguir?</p>
                <div class="flex flex-col sm:flex-row flex-wrap gap-3">
                    <button id="renewContractBtn" class="flex-1 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-md">Renovar Contrato</button>
                    <button id="setRenewalPendingBtn" class="flex-1 bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-md">Deixar Pendente</button>
                    <button id="endContractBtn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Finalizar Aluguel</button>
                </div>
            </div>
             <div class="mt-6 flex justify-end">
                 <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Fechar</button>
             </div>
        </div>
    </div>

    <!-- Modal Relatório de Imposto de Renda -->
    <div id="taxReportModal" class="modal fixed inset-0 bg-gray-900 z-50 p-0">
        <div class="bg-gray-800 w-full h-full p-4 sm:p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold">Relatório para Imposto de Renda</h2>
                    <button type="button" class="modal-close-btn p-2 rounded-full bg-gray-700 hover:bg-gray-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6 p-4 bg-gray-700 rounded-lg">
                    <label for="taxReportMonth" class="text-sm font-medium">Selecione o Período:</label>
                    <div class="flex items-center gap-2">
                        <select id="taxReportMonth" class="bg-gray-600 border border-gray-500 rounded-md px-3 py-1 text-sm"></select>
                        <select id="taxReportYear" class="bg-gray-600 border border-gray-500 rounded-md px-3 py-1 text-sm"></select>
                    </div>
                    <button id="generateTaxReportBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm">Gerar Relatório</button>
                </div>
                <div id="taxReportResult" class="bg-gray-900 p-4 rounded-md">
                    <p class="text-gray-400">Selecione um mês e ano e clique em "Gerar Relatório" para ver os recebimentos de aluguéis de imóveis.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Configurações -->
    <div id="settingsModal" class="modal fixed inset-0 bg-gray-900 z-50 p-0">
        <div class="bg-gray-800 w-full h-full p-4 sm:p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold">Configurações</h2>
                    <button type="button" class="modal-close-btn p-2 rounded-full bg-gray-700 hover:bg-gray-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <div class="border-b border-gray-700">
                        <nav class="-mb-px flex space-x-6" aria-label="Settings Tabs">
                            <button class="settings-tab-button active-settings-tab whitespace-nowrap py-3 px-4 rounded-t-md text-sm font-medium bg-gray-700 text-gray-100" data-tab="profile">Perfil</button>
                            <button class="settings-tab-button whitespace-nowrap py-3 px-4 rounded-t-md text-sm font-medium text-gray-400 hover:bg-gray-700/50" data-tab="managers">Gestores</button>
                        </nav>
                    </div>
                </div>

                <div>
                    <!-- Aba Perfil -->
                    <div id="profile-settings-content" class="settings-tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg">
                            <h3 class="text-xl font-semibold mb-4">Alterar Senha</h3>
                            <form id="changePasswordForm" class="space-y-4">
                                <div>
                                    <label for="currentPassword" class="block text-sm font-medium mb-1">Senha Atual</label>
                                    <input type="password" id="currentPassword" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                                </div>
                                <div>
                                    <label for="newPassword" class="block text-sm font-medium mb-1">Nova Senha</label>
                                    <input type="password" id="newPassword" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                                </div>
                                <div>
                                    <label for="confirmNewPassword" class="block text-sm font-medium mb-1">Confirmar Nova Senha</label>
                                    <input type="password" id="confirmNewPassword" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                                </div>
                                <div id="passwordChangeFeedback" class="text-sm pt-2"></div>
                                <div class="text-right">
                                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Salvar Alterações</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Aba Gestores -->
                    <div id="managers-settings-content" class="settings-tab-content hidden">
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold">Gerenciar Gestores</h3>
                                <button id="openAddManagerModal" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg flex items-center text-sm">
                                    <i data-lucide="plus" class="h-4 w-4 mr-2"></i> Adicionar Gestor
                                </button>
                            </div>
                            <div id="managers-list" class="space-y-4">
                                <!-- Lista de gestores será inserida aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

     <!-- Modal Adicionar/Editar Gestor -->
    <div id="managerModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 overflow-y-auto max-h-[90vh]">
            <form id="managerForm">
                <h2 id="managerModalTitle" class="text-2xl font-bold mb-6">Adicionar Novo Gestor</h2>
                <input type="hidden" id="managerId">
                <div class="space-y-4">
                    <div>
                        <label for="managerType" class="block mb-1 font-medium">Tipo de Gestor</label>
                        <select id="managerType" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <option value="Imobiliária">Imobiliária</option>
                            <option value="Agente">Agente</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div>
                        <label for="managerName" class="block mb-1 font-medium">Nome do Gestor</label>
                        <input type="text" id="managerName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="managerPassword" class="block mb-1 font-medium">Senha de Acesso</label>
                        <input type="text" id="managerPassword" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div class="border-t border-gray-700 pt-4">
                        <label class="block mb-2 font-medium">Selecionar Aluguéis para Administrar</label>
                        <div id="managerRentalsList" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                            <!-- Checkboxes dos aluguéis serão inseridos aqui -->
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                    <button type="button" class="modal-close-btn w-full sm:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal Confirmar Ação -->
    <div id="confirmActionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h2 id="confirmActionTitle" class="text-xl font-bold mb-4">Confirmar Ação</h2>
            <p id="confirmActionMessage" class="mb-6 text-gray-300">Você tem certeza?</p>
            <div class="flex flex-col-reverse sm:flex-row sm:justify-center sm:space-x-3 space-y-2 space-y-reverse sm:space-y-0">
                <button id="confirmActionCancel" class="w-full sm:w-auto px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                <button id="confirmActionConfirm" class="w-full sm:w-auto px-6 py-2 bg-red-600 hover:bg-red-500 rounded-md font-semibold">Confirmar</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let settings = { password: 'davi' };
        let managers = [];
        let currentUser = null;

        const loadSettings = () => {
            const storedSettings = localStorage.getItem('rentalManagerSettings');
            if (storedSettings) {
                settings = JSON.parse(storedSettings);
            }
            const storedManagers = localStorage.getItem('rentalManagerManagers');
            if(storedManagers) {
                managers = JSON.parse(storedManagers);
            }
        };

        const saveSettings = () => {
            localStorage.setItem('rentalManagerSettings', JSON.stringify(settings));
        };

        const saveManagers = () => {
            localStorage.setItem('rentalManagerManagers', JSON.stringify(managers));
        };
        
        loadSettings();

        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const enteredPassword = passwordInput.value;

            if (enteredPassword === settings.password) {
                currentUser = { type: 'admin' };
                initializeApp();
            } else {
                const manager = managers.find(m => m.password === enteredPassword);
                if (manager) {
                    currentUser = { type: 'manager', ...manager };
                    initializeApp();
                } else {
                    loginError.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordInput.focus();
                    loginForm.classList.add('animate-shake');
                    setTimeout(() => {
                        loginForm.classList.remove('animate-shake');
                    }, 500);
                }
            }
        });

        passwordInput.addEventListener('input', () => {
            loginError.classList.add('hidden');
        });

        function initializeApp() {
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');

            // Inicialização dos Ícones Lucide
            lucide.createIcons();

            // Estado da Aplicação
            let items = [];
            let transactions = [];
            let financialChart;
            let onConfirm = null;

            // Elementos do DOM
            const modals = document.querySelectorAll('.modal');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            const addItemForm = document.getElementById('addItemForm');
            const editItemForm = document.getElementById('editItemForm');
            const rentItemForm = document.getElementById('rentItemForm');
            const addTransactionForm = document.getElementById('addTransactionForm');
            const editTransactionForm = document.getElementById('editTransactionForm');
            
            // --- Funções de Persistência de Dados ---
            const saveData = () => {
                localStorage.setItem('rentalManagerItems', JSON.stringify(items));
                localStorage.setItem('rentalManagerTransactions', JSON.stringify(transactions));
                saveSettings();
                saveManagers();
            };

            const loadData = () => {
                const storedItems = localStorage.getItem('rentalManagerItems');
                const storedTransactions = localStorage.getItem('rentalManagerTransactions');
                items = storedItems ? JSON.parse(storedItems) : [];
                transactions = storedTransactions ? JSON.parse(storedTransactions) : [];
                loadSettings();
            };

            const getDataForCurrentUser = () => {
                if (currentUser.type === 'admin') {
                    return { currentItems: items, currentTransactions: transactions };
                }
                
                if (currentUser.type === 'manager') {
                    const currentItems = items.filter(item => currentUser.assignedItemIds.includes(item.id));
                    const currentItemIds = currentItems.map(item => item.id);
                    const currentTransactions = transactions.filter(t => t.itemId && currentItemIds.includes(t.itemId));
                    return { currentItems, currentTransactions };
                }
                return { currentItems: [], currentTransactions: [] };
            };

            // --- Funções de Renderização ---
            const renderAll = () => {
                const { currentItems, currentTransactions } = getDataForCurrentUser();
                customizeUIForUser();
                
                renderDashboard(currentItems, currentTransactions);
                renderItems(currentItems);
                renderRentals(currentItems);
                renderTransactions(currentTransactions); // Initial render with all transactions
                
                if(currentUser.type === 'admin') {
                    checkAlerts();
                    renderManagers();
                    renderAdminManagersDashboard();
                }
                
                lucide.createIcons();
            };

            const renderDashboard = (dashboardItems, dashboardTransactions) => {
                renderSummaryCards(dashboardItems);

                const view = document.getElementById('chart-view').value;
                const year = parseInt(document.getElementById('filterYear').value, 10);
                const month = parseInt(document.getElementById('filterMonth').value, 10);
                
                if (view === 'monthly') {
                    renderBalanceCard(year, month, dashboardTransactions);
                    renderChart(year, 'monthly', dashboardTransactions);
                } else {
                    renderChart(null, 'yearly', dashboardTransactions);
                }
            };


            const renderSummaryCards = (summaryItems) => {
                const rentedCount = summaryItems.filter(item => item.rentedTo).length;
                document.getElementById('total-items').textContent = summaryItems.length;
                document.getElementById('rented-items').textContent = rentedCount;
                document.getElementById('available-items').textContent = summaryItems.length - rentedCount;
            };
            
            const renderItems = (itemsToRender) => {
                const availableList = document.getElementById('available-list');
                const rentedList = document.getElementById('rented-list');
                availableList.innerHTML = '';
                rentedList.innerHTML = '';

                if (itemsToRender.length === 0) {
                    availableList.innerHTML = `<p class="text-gray-400">Nenhum item cadastrado.</p>`;
                }

                itemsToRender.forEach(item => {
                    const actionButtons = `
                        <div class="mt-4 flex justify-end items-center space-x-2">
                            <button data-id="${item.id}" class="edit-item-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Item">
                                <i data-lucide="file-signature" class="h-5 w-5"></i>
                            </button>
                            ${item.rentedTo ? `
                            <button data-id="${item.id}" class="edit-rent-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Aluguel">
                                <i data-lucide="clipboard-edit" class="h-5 w-5"></i>
                            </button>
                            ` : ''}
                            <button data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full" title="${item.rentedTo ? 'Finalizar Aluguel' : 'Excluir Item'}">
                                <i data-lucide="trash-2" class="h-5 w-5"></i>
                            </button>
                            ${!item.rentedTo ? `
                            <button data-id="${item.id}" class="rent-btn bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-md flex items-center text-sm">
                                <i data-lucide="key-round" class="mr-2 h-4 w-4"></i>Alugar
                            </button>` : ''}
                        </div>
                    `;

                    if (item.rentedTo) {
                        const endDate = new Date(item.rentEndDate);
                        const isOverdue = new Date() > endDate;
                        
                        let borderColor = 'border-yellow-500'; // Padrão para alugado
                        if (item.renewalPending) {
                            borderColor = 'border-pink-500'; // Rosa choque para pendente de renovação
                        } else if (isOverdue) {
                            borderColor = 'border-red-500'; // Vencido
                        }
                         let managementInfoHTML = '';
                        if (item.category === 'Imóvel' && item.managedBy) {
                            if (item.managedBy === 'particular') {
                                managementInfoHTML = `<p><strong class="text-gray-300">Gerido por:</strong> Particular</p>`;
                            } else if ((item.managedBy === 'imobiliaria' || item.managedBy === 'outros') && item.managerName) {
                                managementInfoHTML = `<p><strong class="text-gray-300">Gerido por:</strong> ${item.managerName} (${item.managedBy})</p>`;
                            }
                        }

                        const card = `
                            <div class="bg-gray-800 p-4 rounded-lg border-l-4 ${borderColor} flex flex-col h-full">
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="font-bold text-lg">${item.name}</h3>
                                            <p class="text-sm text-gray-400">${item.category}</p>
                                        </div>
                                        <span class="text-lg font-semibold">${formatCurrency(item.rentValue)}</span>
                                    </div>
                                    ${item.description ? `<p class="text-sm text-gray-300 mt-2">${item.description}</p>` : ''}
                                    ${item.endereco ? `<p class="text-xs text-gray-400 mt-2"><i data-lucide="map-pin" class="inline-block h-3 w-3 mr-1"></i>${item.endereco}${item.cep ? `, ${item.cep}`: ''}</p>` : ''}
                                    <div class="mt-3 text-sm space-y-1">
                                        <p><strong class="text-gray-300">Inquilino:</strong> ${item.rentedTo}</p>
                                        ${item.tenantPhone ? `<p><strong class="text-gray-300">Telefone:</strong> ${item.tenantPhone}</p>` : ''}
                                        ${item.tenantCPF ? `<p><strong class="text-gray-300">CPF:</strong> ${item.tenantCPF}</p>` : ''}
                                        ${managementInfoHTML}
                                        <p><strong class="text-gray-300">Pagamento Dia:</strong> ${item.paymentDay}</p>
                                        <p><strong class="text-gray-300">Término Contrato:</strong> <span class="${isOverdue ? 'text-red-400 font-bold' : ''}">${formatDate(item.rentEndDate)}</span></p>
                                    </div>
                                </div>
                                ${actionButtons}
                            </div>
                        `;
                        rentedList.innerHTML += card;
                    } else {
                        const card = `
                            <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-green-500 flex flex-col h-full">
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="font-bold text-lg">${item.name}</h3>
                                            <p class="text-sm text-gray-400">${item.category}</p>
                                        </div>
                                        <span class="text-lg font-semibold">${formatCurrency(item.value)}</span>
                                    </div>
                                    ${item.description ? `<p class="text-sm text-gray-300 mt-2">${item.description}</p>` : ''}
                                    ${item.endereco ? `<p class="text-xs text-gray-400 mt-2"><i data-lucide="map-pin" class="inline-block h-3 w-3 mr-1"></i>${item.endereco}${item.cep ? `, ${item.cep}`: ''}</p>` : ''}
                                </div>
                                ${actionButtons}
                            </div>
                        `;
                        availableList.innerHTML += card;
                    }
                });
                if (rentedList.innerHTML === '') rentedList.innerHTML = `<p class="text-gray-400">Nenhum item alugado no momento.</p>`;
                if (availableList.innerHTML === '') availableList.innerHTML = `<p class="text-gray-400">Nenhum item disponível no momento.</p>`;
            };

            const renderRentals = (rentedItemsToRender) => {
                const sortedRentalsList = document.getElementById('sorted-rentals-list');
                sortedRentalsList.innerHTML = '';

                const rentedItems = rentedItemsToRender.filter(item => item.rentedTo);
            
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const getSortPriority = (item) => {
                    const endDate = new Date(item.rentEndDate + 'T00:00:00');
                    const currentMonthYear = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    const isPaidThisMonth = item.paymentsMade && item.paymentsMade.includes(currentMonthYear);
                    const paymentDueDateThisMonth = new Date(today.getFullYear(), today.getMonth(), item.paymentDay);
                    const isPaymentOverdue = today >= paymentDueDateThisMonth && !isPaidThisMonth;

                    if (today > endDate && !item.renewalPending) return { priority: 1, date: endDate };
                    
                    const startDate = new Date(item.rentStartDate + 'T00:00:00');
                    let firstPaymentDueDate = new Date(startDate);
                    if (item.paymentFrequency === 'monthly') {
                        firstPaymentDueDate.setMonth(firstPaymentDueDate.getMonth() + 1);
                        firstPaymentDueDate.setDate(item.paymentDay);
                    }
                    if (isPaymentOverdue && today >= firstPaymentDueDate) return { priority: 2, date: paymentDueDateThisMonth };
                    if (item.renewalPending) return { priority: 3, date: endDate };
                    if (!isPaidThisMonth) return { priority: 4, date: paymentDueDateThisMonth };
                    if (isPaidThisMonth) return { priority: 5, date: endDate };

                    return { priority: 6, date: endDate };
                };

                rentedItems.sort((a, b) => {
                    const aSort = getSortPriority(a);
                    const bSort = getSortPriority(b);
                    if (aSort.priority !== bSort.priority) {
                        return aSort.priority - bSort.priority;
                    }
                    return aSort.date - bSort.date;
                });

                if (rentedItems.length === 0) {
                    sortedRentalsList.innerHTML = `<p class="text-gray-400">Nenhum aluguel ativo no momento.</p>`;
                    return;
                }

                rentedItems.forEach(item => {
                    const actionButtons = `
                        <div class="mt-4 flex justify-end items-center space-x-2">
                            <button data-id="${item.id}" class="add-revenue-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md flex items-center text-xs" title="Adicionar Receita">
                                <i data-lucide="dollar-sign" class="h-4 w-4 mr-1"></i>Receita
                            </button>
                            <button data-id="${item.id}" class="edit-item-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Item">
                                <i data-lucide="file-signature" class="h-5 w-5"></i>
                            </button>
                            <button data-id="${item.id}" class="edit-rent-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Aluguel">
                                <i data-lucide="clipboard-edit" class="h-5 w-5"></i>
                            </button>
                            <button data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full" title="Finalizar Aluguel">
                                <i data-lucide="trash-2" class="h-5 w-5"></i>
                            </button>
                        </div>
                    `;

                    const endDate = new Date(item.rentEndDate + 'T00:00:00');
                    const isContractOverdue = today > endDate;
                    
                    let paymentStatusHTML = '';
                    const overdueMonths = [];

                    if (item.paymentFrequency === 'monthly') {
                        const startDate = new Date(item.rentStartDate + 'T00:00:00');
                        let checkDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

                        while (checkDate <= today && checkDate <= endDate) {
                            const paymentDueDateInLoop = new Date(checkDate.getFullYear(), checkDate.getMonth(), item.paymentDay);
                            
                            if (paymentDueDateInLoop <= today && paymentDueDateInLoop > startDate) {
                                const periodString = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
                                if (!item.paymentsMade || !item.paymentsMade.includes(periodString)) {
                                    const monthName = checkDate.toLocaleString('pt-BR', { month: 'long' });
                                    overdueMonths.push(monthName.charAt(0).toUpperCase() + monthName.slice(1));
                                }
                            }
                            checkDate.setMonth(checkDate.getMonth() + 1);
                        }
                    }

                    const currentMonthYear = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    const isPaidThisMonth = item.paymentsMade && item.paymentsMade.includes(currentMonthYear);

                    let borderColor = 'border-gray-600';
                    if (isContractOverdue && !item.renewalPending) borderColor = 'border-red-500';
                    else if (item.renewalPending) borderColor = 'border-pink-500';
                    else if (overdueMonths.length > 0) borderColor = 'border-yellow-500';
                    else if (isPaidThisMonth) borderColor = 'border-green-500';

                    if (overdueMonths.length > 0) {
                        const debtCount = overdueMonths.length;
                        paymentStatusHTML = `<p><strong class="text-gray-300">Situação:</strong> <span class="text-xs font-medium bg-yellow-900 text-yellow-300 px-2 py-1 rounded-full">Vencido (${overdueMonths.join(', ')}) (${debtCount} débito${debtCount > 1 ? 's' : ''})</span></p>`;
                    } else if (isPaidThisMonth) {
                        const currentMonthName = today.toLocaleString('pt-BR', { month: 'long' });
                        paymentStatusHTML = `<p><strong class="text-gray-300">Situação:</strong> <span class="text-xs font-medium bg-green-900 text-green-300 px-2 py-1 rounded-full">Pagamento de ${currentMonthName} OK</span></p>`;
                    }
                    
                    let managementInfoHTML = '';
                    if (item.category === 'Imóvel' && item.managedBy) {
                        if (item.managedBy === 'particular') {
                            managementInfoHTML = `<p><strong class="text-gray-300">Gerido por:</strong> Particular</p>`;
                        } else if ((item.managedBy === 'imobiliaria' || item.managedBy === 'outros') && item.managerName) {
                            managementInfoHTML = `<p><strong class="text-gray-300">Gerido por:</strong> ${item.managerName} (${item.managedBy.charAt(0).toUpperCase() + item.managedBy.slice(1)})</p>`;
                        }
                    }

                    const card = `
                        <div class="bg-gray-800 p-4 rounded-lg border-l-4 ${borderColor} flex flex-col h-full">
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-lg">${item.name}</h3>
                                        <p class="text-sm text-gray-400">${item.category}</p>
                                    </div>
                                    <span class="text-lg font-semibold">${formatCurrency(item.rentValue)}</span>
                                </div>
                                <div class="mt-3 text-sm space-y-1">
                                    <p><strong class="text-gray-300">Inquilino:</strong> ${item.rentedTo}</p>
                                    ${managementInfoHTML}
                                    <p><strong class="text-gray-300">Dia do Pagamento:</strong> ${item.paymentDay}</p>
                                    <p><strong class="text-gray-300">Término Contrato:</strong> <span class="${isContractOverdue && !item.renewalPending ? 'text-red-400 font-bold' : ''}">${formatDate(item.rentEndDate)}</span></p>
                                    ${paymentStatusHTML}
                                </div>
                            </div>
                            ${actionButtons}
                        </div>
                    `;
                    sortedRentalsList.innerHTML += card;
                });
            };
            
            const renderTransactions = (transactionsToRender) => {
                const list = document.getElementById('transactions-list');
                list.innerHTML = '';
                
                const sortedTransactions = [...transactionsToRender].sort((a,b) => b.id - a.id);

                if(sortedTransactions.length === 0){
                    list.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">Nenhuma transação encontrada.</td></tr>`;
                    return;
                }

                sortedTransactions.forEach(t => {
                    let typeClass = '', typeText = '', amountClass = '', amountPrefix = '';
                    
                    if (t.type === 'revenue') {
                        typeClass = 'bg-green-900 text-green-300'; typeText = 'Receita'; amountClass = 'text-green-400'; amountPrefix = '+';
                    } else if (t.type === 'expense') {
                        typeClass = 'bg-red-900 text-red-300'; typeText = 'Despesa'; amountClass = 'text-red-400'; amountPrefix = '-';
                    } else if (t.type === 'management_fee') {
                        typeClass = 'bg-yellow-900 text-yellow-300'; typeText = 'Taxa Gerência'; amountClass = 'text-yellow-400'; amountPrefix = '-';
                    }
                    
                    let displayDescription = t.description;
                    if (t.type === 'revenue' && t.itemId && (t.description.startsWith('Recebimento aluguel:') || t.description === 'Recebimento de Aluguel')) {
                        const item = items.find(i => i.id === t.itemId);
                        if (item && item.rentedTo) {
                            displayDescription = `${item.name} - ${item.rentedTo}`;
                        }
                    }

                    const row = `
                        <tr class="border-b border-gray-700">
                            <td data-label="Data" class="p-4">${formatDate(t.date)}</td>
                            <td data-label="Descrição" class="p-4">${displayDescription}</td>
                            <td data-label="Tipo" class="p-4"><span class="px-2 py-1 rounded-full text-xs font-medium ${typeClass}">${typeText}</span></td>
                            <td data-label="Valor" class="p-4 text-right font-semibold ${amountClass}">${amountPrefix} ${formatCurrency(t.amount)}</td>
                            <td data-label="Ações" class="p-4 text-center actions-cell">
                            <div class="flex items-center justify-center md:justify-center space-x-2">
                                    <button data-id="${t.id}" class="edit-transaction-btn text-gray-400 hover:text-cyan-400 transition-colors p-1 rounded-full" title="Editar Transação"><i data-lucide="edit" class="h-4 w-4"></i></button>
                                    <button data-id="${t.id}" class="delete-transaction-btn text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full" title="Excluir Transação"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                            </div>
                            </td>
                        </tr>
                    `;
                    list.innerHTML += row;
                });
            };

            const checkAlerts = () => {
                const container = document.getElementById('alerts-container');
                const notificationBadges = document.querySelectorAll('.notification-badge');
                const notificationsTabBtns = document.querySelectorAll('.tab-button[data-tab="notifications"]');
                container.innerHTML = '';
                let alertCount = 0;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                items.forEach(item => {
                    if (!item.rentedTo || item.paymentFrequency === 'single') return;

                    const endDate = new Date(item.rentEndDate + 'T00:00:00');
                    
                    if (today > endDate && !item.endOfContractNotified) {
                        alertCount++;
                        const alertHTML = `
                            <div class="bg-red-900/50 border border-red-700 p-4 rounded-lg flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                                <div><p class="font-semibold text-red-300">O contrato de "${item.name}" terminou.</p><p class="text-sm text-red-400">Ação necessária: renovar, finalizar ou deixar pendente.</p></div>
                                <button data-id="${item.id}" class="resolve-contract-end-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-md text-sm whitespace-nowrap self-end sm:self-center">Resolver</button>
                            </div>
                        `;
                        container.innerHTML += alertHTML;
                        return; 
                    }

                    const startDate = new Date(item.rentStartDate + 'T00:00:00');
                    let firstPaymentDueDate = new Date(startDate);

                    if (item.paymentFrequency === 'monthly') {
                        firstPaymentDueDate.setMonth(firstPaymentDueDate.getMonth() + 1);
                        firstPaymentDueDate.setDate(item.paymentDay);
                    } else if (item.paymentFrequency === 'weekly') {
                        firstPaymentDueDate.setDate(firstPaymentDueDate.getDate() + 7);
                    } else if (item.paymentFrequency === 'daily') {
                        firstPaymentDueDate.setDate(firstPaymentDueDate.getDate() + 1);
                    }
                    
                    if (today < firstPaymentDueDate) {
                        return; 
                    }

                    const currentMonthYear = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    const isPaidThisMonth = item.paymentsMade && item.paymentsMade.includes(currentMonthYear);

                    const paymentDueDateThisMonth = new Date(today.getFullYear(), today.getMonth(), item.paymentDay);
                    const lastPaymentDate = item.lastPaymentAlertDate ? new Date(item.lastPaymentAlertDate) : null;

                    if (today >= paymentDueDateThisMonth && !isPaidThisMonth && (!lastPaymentDate || lastPaymentDate < paymentDueDateThisMonth)) {
                        alertCount++;
                        const alertHTML = `
                            <div class="bg-yellow-900/50 border border-yellow-700 p-4 rounded-lg flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                                <div><p class="font-semibold text-yellow-300">Pagamento de "${item.name}" está pendente este mês.</p><p class="text-sm text-yellow-400">A data de vencimento foi dia ${item.paymentDay}.</p></div>
                                <button data-id="${item.id}" class="resolve-payment-btn bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-3 rounded-md text-sm whitespace-nowrap self-end sm:self-center">Resolver</button>
                            </div>
                        `;
                        container.innerHTML += alertHTML;
                    }
                });

                notificationBadges.forEach(badge => badge.textContent = alertCount);

                notificationsTabBtns.forEach(btn => {
                    if (alertCount > 0) {
                        btn.classList.add('has-notifications');
                    } else {
                        btn.classList.remove('has-notifications');
                    }
                });
                
                if (alertCount === 0) {
                    container.innerHTML = `<p class="text-gray-400">Nenhum alerta no momento.</p>`;
                }
            };

            const renderManagers = () => {
                const list = document.getElementById('managers-list');
                list.innerHTML = '';
                if (managers.length === 0) {
                    list.innerHTML = '<p class="text-gray-400">Nenhum gestor cadastrado.</p>';
                    return;
                }

                managers.forEach(manager => {
                    const assignedItems = items.filter(item => manager.assignedItemIds.includes(item.id));
                    const card = `
                        <div class="bg-gray-700 p-4 rounded-lg flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                            <div>
                                <p class="font-bold text-lg">${manager.name}</p>
                                <p class="text-sm text-gray-300">${manager.type} - <span class="text-cyan-400">${assignedItems.length} alugu(éis)</span></p>
                            </div>
                            <div class="flex items-center space-x-2 self-end sm:self-center">
                                <button data-id="${manager.id}" class="edit-manager-btn bg-gray-600 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg flex items-center text-sm">
                                    <i data-lucide="edit" class="h-4 w-4 mr-2"></i> Editar
                                </button>
                                <button data-id="${manager.id}" class="delete-manager-btn bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg flex items-center text-sm">
                                    <i data-lucide="trash-2" class="h-4 w-4 mr-2"></i> Excluir
                                </button>
                            </div>
                        </div>
                    `;
                    list.innerHTML += card;
                });
                 lucide.createIcons();
            };

            const renderAdminManagersDashboard = () => {
                const dashboard = document.getElementById('admin-managers-dashboard');
                dashboard.innerHTML = '';
                if (managers.length === 0) {
                    dashboard.innerHTML = '<p class="text-gray-400">Nenhum gestor cadastrado. Adicione gestores na aba de Configurações.</p>';
                    return;
                }

                managers.forEach(manager => {
                    const assignedItems = items.filter(item => manager.assignedItemIds.includes(item.id));
                    const rentedCount = assignedItems.filter(item => item.rentedTo).length;
                    
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();

                    const managerTransactions = transactions.filter(t => 
                        t.itemId && manager.assignedItemIds.includes(t.itemId) &&
                        new Date(t.date).getMonth() === currentMonth &&
                        new Date(t.date).getFullYear() === currentYear
                    );

                    const revenue = managerTransactions.filter(t => t.type === 'revenue').reduce((sum, t) => sum + t.amount, 0);
                    const fees = managerTransactions.filter(t => t.type === 'management_fee').reduce((sum, t) => sum + t.amount, 0);

                    const card = `
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">${manager.name} <span class="text-base font-normal text-gray-400">- ${manager.type}</span></h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-700/50 p-4 rounded-lg">
                                    <h4 class="text-sm font-medium text-gray-400">Aluguéis Gerenciados</h4>
                                    <p class="mt-1 text-2xl font-semibold">${assignedItems.length}</p>
                                </div>
                                <div class="bg-gray-700/50 p-4 rounded-lg">
                                    <h4 class="text-sm font-medium text-gray-400">Atualmente Alugados</h4>
                                    <p class="mt-1 text-2xl font-semibold">${rentedCount}</p>
                                </div>
                                <div class="bg-gray-700/50 p-4 rounded-lg">
                                    <h4 class="text-sm font-medium text-gray-400">Receita do Mês</h4>
                                    <p class="mt-1 text-2xl font-semibold text-green-400">${formatCurrency(revenue)}</p>
                                </div>
                                <div class="bg-gray-700/50 p-4 rounded-lg">
                                    <h4 class="text-sm font-medium text-gray-400">Ganho com Taxas (Mês)</h4>
                                    <p class="mt-1 text-2xl font-semibold text-yellow-400">${formatCurrency(fees)}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    dashboard.innerHTML += card;
                });
            };
            
            const renderBalanceCard = (year, month, transactionsForBalance) => {
                const monthName = new Date(year, month).toLocaleString('pt-BR', { month: 'long' });

                let balance = 0;
                let totalExpenses = 0;
                let totalFees = 0;
                let totalRevenue = 0;

                transactionsForBalance.forEach(t => {
                    const tDate = new Date(t.date);
                    if (tDate.getMonth() === month && tDate.getFullYear() === year) {
                        if(t.type === 'revenue') {
                            totalRevenue += t.amount;
                        } else if (t.type === 'expense') {
                            totalExpenses += t.amount;
                        } else if (t.type === 'management_fee') {
                            totalFees += t.amount;
                        }
                    }
                });

                balance = totalRevenue - totalExpenses - totalFees;
                
                const balanceTitle = document.getElementById('month-balance-title');
                const expenseTitle = document.getElementById('month-expense-title');
                const feeTitle = document.getElementById('month-fee-title');
                
                if (currentUser.type === 'manager') {
                    balanceTitle.textContent = `Saldo Proprietário (${monthName})`;
                    expenseTitle.textContent = `Despesas da Gerência (${monthName})`;
                    feeTitle.textContent = `Ganho c/ Taxas (${monthName})`;
                    document.getElementById('month-fee').textContent = formatCurrency(totalFees);
                } else {
                    balanceTitle.textContent = `Saldo de ${monthName}/${year}`;
                    expenseTitle.textContent = `Despesas de ${monthName}/${year}`;
                    feeTitle.textContent = `Taxa de Gerência de ${monthName}/${year}`;
                    document.getElementById('month-fee').textContent = formatCurrency(totalFees);
                }

                document.getElementById('month-balance').textContent = formatCurrency(balance);
                document.getElementById('month-expense').textContent = formatCurrency(totalExpenses);
            }

            const renderChart = (year, view, transactionsForChart) => {
                const ctx = document.getElementById('financialChart').getContext('2d');
                let labels = [];
                let revenueData = [], expenseData = [], managementFeeData = [];

                if (view === 'monthly') {
                    labels = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                    revenueData = Array(12).fill(0);
                    expenseData = Array(12).fill(0);
                    managementFeeData = Array(12).fill(0);
                    
                    transactionsForChart.forEach(t => {
                        const tDate = new Date(t.date);
                        if (tDate.getFullYear() === year) {
                            const monthIndex = tDate.getMonth();
                            if (t.type === 'revenue') revenueData[monthIndex] += t.amount;
                            else if (t.type === 'expense') expenseData[monthIndex] += t.amount;
                            else if (t.type === 'management_fee') managementFeeData[monthIndex] += t.amount;
                        }
                    });
                } else { // yearly
                    const years = [...new Set(transactionsForChart.map(t => new Date(t.date).getFullYear()))].filter(Boolean).sort();
                    if (years.length === 0) years.push(new Date().getFullYear());
                    labels = years.map(String);
                    revenueData = Array(years.length).fill(0);
                    expenseData = Array(years.length).fill(0);
                    managementFeeData = Array(years.length).fill(0);

                    transactionsForChart.forEach(t => {
                        const tYear = new Date(t.date).getFullYear();
                        const index = years.indexOf(tYear);
                        if (index !== -1) {
                            if (t.type === 'revenue') revenueData[index] += t.amount;
                            else if (t.type === 'expense') expenseData[index] += t.amount;
                            else if (t.type === 'management_fee') managementFeeData[index] += t.amount;
                        }
                    });
                }


                if (financialChart) financialChart.destroy();
                financialChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: 'Receitas', data: revenueData, backgroundColor: 'rgba(16, 185, 129, 0.2)', borderColor: 'rgba(16, 185, 129, 1)', borderWidth: 2, tension: 0.1, fill: true }, { label: 'Despesas', data: expenseData, backgroundColor: 'rgba(239, 68, 68, 0.2)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 2, tension: 0.1, fill: true }, { label: 'Taxa de Gerência', data: managementFeeData, backgroundColor: 'rgba(252, 211, 77, 0.2)', borderColor: 'rgba(252, 211, 77, 1)', borderWidth: 2, tension: 0.1, fill: true } ] }, options: { scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } }, responsive: true, maintainAspectRatio: false } });
            };
            
            const applyFiltersAndRender = () => {
                const { currentTransactions } = getDataForCurrentUser();
                const description = document.getElementById('filterDescription').value.toLowerCase();
                const type = document.getElementById('filterType').value;
                const startDate = document.getElementById('filterStartDate').value;
                let filtered = currentTransactions.filter(t => {
                    const tDate = new Date(t.date + 'T00:00:00');
                    const start = startDate ? new Date(startDate + 'T00:00:00') : null;
                    return t.description.toLowerCase().includes(description) && (type === 'all' || t.type === type) && (!start || tDate >= start);
                });
                renderTransactions(filtered);
            };

            // --- Funções de Utilitários ---
            const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
            const formatDate = (dateString) => { if(!dateString) return ''; const date = new Date(dateString); return new Date(date.getTime() + (date.getTimezoneOffset() * 60000)).toLocaleDateString('pt-BR'); };
            const dateToYMD = (date) => date.toISOString().split('T')[0];
            const getTodayDateString = () => dateToYMD(new Date());
            const showModal = (modalId) => document.getElementById(modalId).classList.add('active');
            const hideModal = (modalId) => document.getElementById(modalId).classList.remove('active');

            const populateTransactionItemSelect = (selectElementId, selectedId) => {
                const { currentItems } = getDataForCurrentUser();
                const select = document.getElementById(selectElementId);
                select.innerHTML = '<option value="">Nenhum / Outra</option>';
                const rentedItems = currentItems.filter(item => item.rentedTo);
                const availableItems = currentItems.filter(item => !item.rentedTo);
                if (rentedItems.length > 0) {
                    const rentedGroup = document.createElement('optgroup');
                    rentedGroup.label = 'Alugados';
                    rentedItems.forEach(item => { const option = document.createElement('option'); option.value = item.id; option.textContent = `${item.name} (Inquilino: ${item.rentedTo})`; rentedGroup.appendChild(option); });
                    select.appendChild(rentedGroup);
                }
                if (availableItems.length > 0) {
                    const availableGroup = document.createElement('optgroup');
                    availableGroup.label = 'Disponíveis';
                    availableItems.forEach(item => { const option = document.createElement('option'); option.value = item.id; option.textContent = item.name; availableGroup.appendChild(option); });
                    select.appendChild(availableGroup);
                }
                if (selectedId) select.value = selectedId;
            };

            const showConfirmModal = (title, message, onConfirmCallback) => {
                document.getElementById('confirmActionTitle').textContent = title;
                document.getElementById('confirmActionMessage').textContent = message;
                onConfirm = onConfirmCallback;
                showModal('confirmActionModal');
            };

            const switchTab = (tabId) => {
                document.querySelectorAll('.tab-button').forEach(btn => {
                    const isCorrectTab = btn.dataset.tab === tabId;
                    btn.classList.toggle('active-tab', isCorrectTab);
                    
                    if (btn.closest('#top-nav')) {
                        btn.classList.toggle('border-cyan-500', isCorrectTab);
                        btn.classList.toggle('text-cyan-400', isCorrectTab);
                        btn.classList.toggle('border-transparent', !isCorrectTab);
                        btn.classList.toggle('text-gray-400', !isCorrectTab);
                    }
                });
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tabId}-content`).classList.remove('hidden');
            };
            
            const finalizeRental = (itemId) => {
                const item = items.find(i => i.id === itemId);
                if (item) {
                    item.rentedTo = null;
                    item.rentStartDate = null;
                    item.rentEndDate = null;
                    item.rentValue = null;
                    item.paymentDay = null;
                    item.lastPaymentAlertDate = null;
                    item.endOfContractNotified = false;
                    item.renewalPending = false;
                    item.tenantPhone = null;
                    item.tenantCPF = null;
                    item.paymentsMade = [];
                }
            };
            
            const updateDashboardView = () => {
                const { currentItems, currentTransactions } = getDataForCurrentUser();
                renderDashboard(currentItems, currentTransactions);
            }
            
            const initDashboardFilters = () => {
                const monthSelect = document.getElementById('filterMonth'), yearSelect = document.getElementById('filterYear'), now = new Date();
                if (monthSelect.options.length > 0) return; // Evita repopular
                for(let i=0; i<12; i++) { const monthName = new Date(2000, i).toLocaleString('pt-BR', {month: 'long'}); monthSelect.innerHTML += `<option value="${i}">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</option>`; }
                
                const { currentTransactions } = getDataForCurrentUser();
                const years = [...new Set(currentTransactions.map(t => new Date(t.date).getFullYear()))].filter(Boolean);
                if (!years.includes(now.getFullYear())) {
                    years.push(now.getFullYear());
                }
                years.sort((a,b) => b-a);
                years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);
                monthSelect.value = now.getMonth(); yearSelect.value = now.getFullYear();
                
                monthSelect.addEventListener('change', updateDashboardView);
                yearSelect.addEventListener('change', updateDashboardView);
                document.getElementById('chart-view').addEventListener('change', updateDashboardView);
            }

            // --- Handlers para Relatório de Imposto de Renda ---
            const initTaxReportFilters = () => {
                const monthSelect = document.getElementById('taxReportMonth');
                const yearSelect = document.getElementById('taxReportYear');
                const now = new Date();
                
                if(monthSelect.options.length === 0){
                    for(let i=0; i<12; i++) { 
                        const monthName = new Date(2000, i).toLocaleString('pt-BR', {month: 'long'}); 
                        monthSelect.innerHTML += `<option value="${i}">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</option>`; 
                    }
                }
                
                const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))].filter(Boolean);
                if (!years.includes(now.getFullYear())) {
                    years.push(now.getFullYear());
                }
                years.sort((a,b) => b-a);
                
                yearSelect.innerHTML = ''; 
                years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);

                monthSelect.value = now.getMonth();
                yearSelect.value = now.getFullYear();
            };

            const generateTaxReport = () => {
                const month = parseInt(document.getElementById('taxReportMonth').value);
                const year = parseInt(document.getElementById('taxReportYear').value);
                const resultDiv = document.getElementById('taxReportResult');
                resultDiv.innerHTML = '';
                let totalNetValue = 0;

                const relevantTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    const item = items.find(i => i.id === t.itemId);
                    return t.type === 'revenue' && 
                        item && 
                        item.category === 'Imóvel' &&
                        tDate.getMonth() === month &&
                        tDate.getFullYear() === year;
                });

                if (relevantTransactions.length === 0) {
                    resultDiv.innerHTML = '<p class="text-gray-400">Nenhum recebimento de aluguel de imóvel encontrado para este período.</p>';
                    return;
                }

                const reportData = relevantTransactions.map(rev => {
                    const item = items.find(i => i.id === rev.itemId);
                    const feeTransaction = transactions.find(t => 
                        t.type === 'management_fee' && 
                        t.date === rev.date && 
                        t.itemId === rev.itemId
                    );

                    const grossValue = rev.amount;
                    const feeValue = feeTransaction ? feeTransaction.amount : 0;
                    const netValue = grossValue - feeValue;
                    
                    totalNetValue += netValue;

                    return {
                        managedBy: item.managedBy || 'particular',
                        managerName: item.managerName || 'N/A',
                        tenantName: item.rentedTo,
                        tenantCPF: item.tenantCPF || 'Não informado',
                        address: item.endereco || 'Não informado',
                        grossValue: grossValue,
                        feeValue: feeValue,
                        netValue: netValue,
                        grossValueForCopy: grossValue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                        feeValueForCopy: feeValue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                        netValueForCopy: netValue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                    };
                });

                const groupedData = reportData.reduce((acc, data) => {
                    const key = data.managedBy === 'particular' ? 'Particular' : `${data.managerName} (${data.managedBy === 'imobiliaria' ? 'Imobiliária' : 'Outros'})`;
                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(data);
                    return acc;
                }, {});

                const order = { 'Particular': 1, 'Outros': 2, 'Imobiliária': 3 };
                const sortedKeys = Object.keys(groupedData).sort((a, b) => {
                    const typeA = a.split(' (')[0];
                    const typeB = b.split(' (')[0];
                    return order[typeA] - order[typeB] || a.localeCompare(b);
                });


                let reportHTML = '';
                let copyIdCounter = 0;
                sortedKeys.forEach(key => {
                    reportHTML += `<h3 class="text-xl font-semibold text-cyan-400 mt-6 mb-3 border-b border-gray-700 pb-2">${key}</h3>`;
                    
                    groupedData[key].forEach(entry => {
                        const cpfId = `copy-cpf-${copyIdCounter}`;
                        const addressId = `copy-address-${copyIdCounter}`;
                        const grossValueId = `copy-gross-${copyIdCounter}`;
                        const feeValueId = `copy-fee-${copyIdCounter}`;
                        const netValueId = `copy-net-${copyIdCounter}`;
                        
                        let valuesHTML = '';
                        if (entry.feeValue > 0) {
                            valuesHTML = `
                                <div class="flex items-center gap-3">
                                    <p class="text-lg text-gray-300"><strong class="text-gray-400">Valor do Aluguel:</strong> <span>${formatCurrency(entry.grossValue)}</span></p>
                                    <span id="${grossValueId}" class="hidden">${entry.grossValueForCopy}</span>
                                    <button data-copy-target="${grossValueId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar Valor do Aluguel">
                                        <i data-lucide="copy" class="h-5 w-5"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-3">
                                    <p class="text-lg text-gray-300"><strong class="text-gray-400">Taxa de Gerência:</strong> <span>${formatCurrency(entry.feeValue)}</span></p>
                                    <span id="${feeValueId}" class="hidden">${entry.feeValueForCopy}</span>
                                    <button data-copy-target="${feeValueId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar Taxa de Gerência">
                                        <i data-lucide="copy" class="h-5 w-5"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-3">
                                    <p class="text-2xl font-semibold"><strong class="text-gray-400 text-lg">Valor Líquido:</strong> <span class="text-green-400">${formatCurrency(entry.netValue)}</span></p>
                                    <span id="${netValueId}" class="hidden">${entry.netValueForCopy}</span>
                                    <button data-copy-target="${netValueId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar Valor Líquido">
                                        <i data-lucide="copy" class="h-5 w-5"></i>
                                    </button>
                                </div>
                            `;
                        } else {
                            valuesHTML = `
                                <div class="flex items-center gap-3">
                                    <p class="text-2xl font-semibold"><strong class="text-gray-400 text-lg">Valor Recebido:</strong> <span class="text-green-400">${formatCurrency(entry.netValue)}</span></p>
                                    <span id="${netValueId}" class="hidden">${entry.netValueForCopy}</span>
                                    <button data-copy-target="${netValueId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar Valor Recebido">
                                        <i data-lucide="copy" class="h-5 w-5"></i>
                                    </button>
                                </div>
                            `;
                        }

                        reportHTML += `
                            <div class="py-6 border-b-2 border-gray-700 space-y-2">
                                <p class="text-2xl font-bold text-white">${entry.tenantName}</p>
                                
                                <div class="flex items-center gap-3">
                                    <p class="text-lg text-gray-300"><strong class="text-gray-400">CPF:</strong> <span id="${cpfId}">${entry.tenantCPF}</span></p>
                                    <button data-copy-target="${cpfId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar CPF">
                                        <i data-lucide="copy" class="h-5 w-5"></i>
                                    </button>
                                </div>
                                
                                <div class="flex items-center gap-3">
                                    <p class="text-lg text-gray-300" id="${addressId}">${entry.address}</p>
                                    <button data-copy-target="${addressId}" class="copy-btn text-gray-400 hover:text-cyan-400" title="Copiar Endereço">
                                        <i data-lucide="copy" class="h-5 w-5"></i>
                                    </button>
                                </div>

                                ${valuesHTML}
                            </div>
                        `;
                        copyIdCounter++;
                    });
                });

                reportHTML += `
                    <div class="mt-8 pt-4 border-t-2 border-gray-600 text-right">
                        <p class="text-lg font-medium text-gray-300">Soma Total Líquida do Mês:</p>
                        <p class="text-3xl font-bold text-green-400">${formatCurrency(totalNetValue)}</p>
                    </div>
                `;
                
                resultDiv.innerHTML = reportHTML;
                lucide.createIcons();
            };
            
            // --- Handlers para Gestores ---
            // A função `customizeUIForUser` foi movida para o final do script para evitar o erro de declaração duplicada.
            
            // --- Manipuladores de Eventos ---
            document.body.addEventListener('click', (e) => { 
                const copyButton = e.target.closest('.copy-btn');
                if (copyButton) {
                    const targetId = copyButton.dataset.copyTarget;
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        const textToCopy = targetElement.textContent.trim();
                        
                        const textArea = document.createElement("textarea");
                        textArea.value = textToCopy;
                        textArea.style.position = "fixed"; 
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            document.execCommand('copy');
                            copyButton.innerHTML = '<i data-lucide="check" class="h-5 w-5 text-green-400"></i>';
                            lucide.createIcons();
                            setTimeout(() => {
                                copyButton.innerHTML = '<i data-lucide="copy" class="h-5 w-5"></i>';
                                lucide.createIcons();
                            }, 1500);
                        } catch (err) {
                            console.error('Falha ao copiar texto: ', err);
                        }

                        document.body.removeChild(textArea);
                    }
                }
                if (e.target.closest('#logoutBtn')) {
                    window.location.reload();
                }

                const deleteManagerBtn = e.target.closest('.delete-manager-btn');
                if (deleteManagerBtn) {
                    const managerId = parseInt(deleteManagerBtn.dataset.id);
                    const manager = managers.find(m => m.id === managerId);
                    if(manager) {
                        showConfirmModal('Excluir Gestor', `Você tem certeza que deseja excluir o gestor "${manager.name}"?`, () => {
                            managers = managers.filter(m => m.id !== managerId);
                            saveData();
                            renderAll();
                        });
                    }
                }

                const editManagerBtn = e.target.closest('.edit-manager-btn');
                if(editManagerBtn) {
                    const managerId = parseInt(editManagerBtn.dataset.id);
                    const manager = managers.find(m => m.id === managerId);
                    if(manager) {
                        document.getElementById('managerModalTitle').textContent = 'Editar Gestor';
                        document.getElementById('managerId').value = manager.id;
                        document.getElementById('managerType').value = manager.type;
                        document.getElementById('managerName').value = manager.name;
                        document.getElementById('managerPassword').value = manager.password;
                        
                        const rentalsListDiv = document.getElementById('managerRentalsList');
                        rentalsListDiv.innerHTML = '';
                        const rentedItems = items.filter(item => item.rentedTo);
                        
                        rentedItems.forEach(item => {
                            const checkboxId = `manager-item-edit-${item.id}`;
                            const isChecked = manager.assignedItemIds.includes(item.id);
                            const label = document.createElement('label');
                            label.htmlFor = checkboxId;
                            label.className = 'flex items-center space-x-3 p-2 rounded-md hover:bg-gray-600/50 cursor-pointer';
                            label.innerHTML = `
                                <input type="checkbox" id="${checkboxId}" value="${item.id}" name="assignedItems" class="h-4 w-4 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600" ${isChecked ? 'checked' : ''}>
                                <span>${item.name} <span class="text-xs text-gray-400">(${item.rentedTo})</span></span>
                            `;
                            rentalsListDiv.appendChild(label);
                        });
                        showModal('managerModal');
                    }
                }
            });

            tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
            document.getElementById('openAddItemModal').addEventListener('click', () => { addItemForm.reset(); document.getElementById('itemCategorySelect').value = ""; document.getElementById('imovelFieldsWrapper').classList.add('hidden'); document.getElementById('itemCategoryOtherWrapper').classList.add('hidden'); showModal('addItemModal'); });
            document.getElementById('openAddTransactionModalRevenue').addEventListener('click', () => { document.getElementById('transactionModalTitle').textContent = 'Adicionar Receita'; document.getElementById('transactionType').value = 'revenue'; document.getElementById('managementFeeContainer').style.display = 'block'; addTransactionForm.reset(); document.getElementById('transactionDate').value = getTodayDateString(); populateTransactionItemSelect('transactionItemLink'); showModal('addTransactionModal'); });
            document.getElementById('openAddTransactionModalExpense').addEventListener('click', () => { document.getElementById('transactionModalTitle').textContent = 'Adicionar Despesa'; document.getElementById('transactionType').value = 'expense'; document.getElementById('managementFeeContainer').style.display = 'none'; addTransactionForm.reset(); document.getElementById('transactionDate').value = getTodayDateString(); populateTransactionItemSelect('transactionItemLink'); showModal('addTransactionModal'); });
            document.getElementById('openTaxReportModal').addEventListener('click', () => { initTaxReportFilters(); showModal('taxReportModal'); });
            document.getElementById('generateTaxReportBtn').addEventListener('click', generateTaxReport);
            modals.forEach(modal => { 
                modal.addEventListener('click', (e) => { 
                    if (e.target.classList.contains('modal') || e.target.closest('.modal-close-btn')) {
                        hideModal(modal.id);
                    }
                }); 
            });
            document.getElementById('itemCategorySelect').addEventListener('change', (e) => { document.getElementById('itemCategoryOtherWrapper').classList.toggle('hidden', e.target.value !== 'outro'); document.getElementById('imovelFieldsWrapper').classList.toggle('hidden', e.target.value !== 'Imóvel'); });
            document.getElementById('editItemCategorySelect').addEventListener('change', (e) => { document.getElementById('editItemCategoryOtherWrapper').classList.toggle('hidden', e.target.value !== 'outro'); document.getElementById('editImovelFieldsWrapper').classList.toggle('hidden', e.target.value !== 'Imóvel'); });
            document.querySelectorAll('.itemManagedBySelect').forEach(select => { select.addEventListener('change', (e) => { const wrapper = e.target.closest('form').querySelector('.itemManagerNameWrapper'); const feeWrapper = e.target.closest('form').querySelector('.itemFeeWrapper'); const show = e.target.value === 'imobiliaria' || e.target.value === 'outros'; wrapper.classList.toggle('hidden', !show); feeWrapper.classList.toggle('hidden', !show);}); });
            document.querySelectorAll('input[type="checkbox"][id$="HasManagementFee"]').forEach(checkbox => { checkbox.addEventListener('change', (e) => { const wrapper = e.target.closest('.itemFeeWrapper').querySelector('.itemFeePercentageWrapper'); wrapper.classList.toggle('hidden', !e.target.checked); }); });
            ['filterDescription', 'filterType', 'filterStartDate'].forEach(id => { document.getElementById(id).addEventListener('input', applyFiltersAndRender); });
            document.getElementById('clearFiltersBtn').addEventListener('click', () => { document.getElementById('filterDescription').value = ''; document.getElementById('filterType').value = 'all'; document.getElementById('filterStartDate').value = ''; applyFiltersAndRender(); });
            document.getElementById('addTransactionModal').addEventListener('change', (e) => { if (e.target.id === 'addManagementFee') document.getElementById('managementFeeDiv').classList.toggle('hidden', !e.target.checked); if (e.target.id === 'transactionItemLink') { const itemId = e.target.value; if (itemId) { const item = items.find(i => i.id === parseInt(itemId)); if (item) document.getElementById('transactionAmount').value = item.rentedTo ? item.rentValue : item.value; } } });
            document.getElementById('setTenPercentFeeBtn').addEventListener('click', () => { const totalAmount = parseFloat(document.getElementById('transactionAmount').value); if (!isNaN(totalAmount) && totalAmount > 0) document.getElementById('managementFeeAmount').value = (totalAmount * 0.10).toFixed(2); });
            document.getElementById('setOneYearBtn').addEventListener('click', () => { const startDateInput = document.getElementById('rentStartDate'); if(startDateInput.value) { const startDate = new Date(startDateInput.value + "T00:00:00"); startDate.setFullYear(startDate.getFullYear() + 1); document.getElementById('rentEndDate').value = dateToYMD(startDate); } });

            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const categorySelect = document.getElementById('itemCategorySelect');
                if (!categorySelect.value) { alert('Por favor, selecione uma categoria.'); return; }
                let category = categorySelect.value;
                if (category === 'outro') category = document.getElementById('itemCategoryOther').value || 'Outro';

                if(currentUser.type === 'manager' && currentUser.type === 'Imobiliária' && category !== 'Imóvel'){
                    alert('Gestores do tipo Imobiliária só podem cadastrar itens da categoria "Imóvel".');
                    return;
                }
                
                let managedBy = null, managerName = null, hasManagementFee = false, managementFeePercentage = 0;
                if (category === 'Imóvel') {
                    managedBy = document.getElementById('itemManagedBy').value;
                    if (managedBy === 'imobiliaria' || managedBy === 'outros') {
                        managerName = document.getElementById('itemManagerName').value;
                        hasManagementFee = document.getElementById('itemHasManagementFee').checked;
                        if(hasManagementFee) {
                            managementFeePercentage = parseFloat(document.getElementById('itemManagementFeePercentage').value);
                        }
                    }
                }

                const newItem = {
                    id: Date.now(),
                    name: document.getElementById('itemName').value, description: document.getElementById('itemDescription').value, category: category,
                    value: parseFloat(document.getElementById('itemValue').value), paymentFrequency: document.getElementById('itemPaymentFrequency').value, rentedTo: null,
                    endereco: category === 'Imóvel' ? document.getElementById('itemEndereco').value : null, 
                    cep: category === 'Imóvel' ? document.getElementById('itemCep').value : null,
                    managedBy, managerName, hasManagementFee, managementFeePercentage
                };
                items.push(newItem);

                if(currentUser.type === 'manager'){
                    currentUser.assignedItemIds.push(newItem.id);
                    const managerInDb = managers.find(m => m.id === currentUser.id);
                    if(managerInDb) managerInDb.assignedItemIds.push(newItem.id);
                }

                saveData();
                renderAll();
                hideModal('addItemModal');
                addItemForm.reset();
                document.getElementById('imovelFieldsWrapper').classList.add('hidden');
                document.getElementById('itemCategoryOtherWrapper').classList.add('hidden');
            });
            
            editItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const itemId = parseInt(document.getElementById('editItemId').value);
                const item = items.find(i => i.id === itemId);
                if (item) {
                    const categorySelect = document.getElementById('editItemCategorySelect');
                    if (!categorySelect.value) { alert('Por favor, selecione uma categoria.'); return; }
                    let category = categorySelect.value;
                    if (category === 'outro') category = document.getElementById('editItemCategoryOther').value || 'Outro';
                    item.name = document.getElementById('editItemName').value;
                    item.description = document.getElementById('editItemDescription').value;
                    item.category = category;
                    item.value = parseFloat(document.getElementById('editItemValue').value);
                    item.paymentFrequency = document.getElementById('editItemPaymentFrequency').value;
                    
                    if (category === 'Imóvel') {
                        item.endereco = document.getElementById('editItemEndereco').value;
                        item.cep = document.getElementById('editItemCep').value;
                        item.managedBy = document.getElementById('editItemManagedBy').value;
                        if (item.managedBy === 'imobiliaria' || item.managedBy === 'outros') {
                            item.managerName = document.getElementById('editItemManagerName').value;
                            item.hasManagementFee = document.getElementById('editItemHasManagementFee').checked;
                            if(item.hasManagementFee) {
                                item.managementFeePercentage = parseFloat(document.getElementById('editItemManagementFeePercentage').value);
                            } else {
                                item.managementFeePercentage = 0;
                            }
                        } else {
                            item.managerName = null;
                            item.hasManagementFee = false;
                            item.managementFeePercentage = 0;
                        }
                    } else {
                        item.endereco = null; item.cep = null; item.managedBy = null; item.managerName = null; item.hasManagementFee = false; item.managementFeePercentage = 0;
                    }
                }
                saveData();
                renderAll();
                hideModal('editItemModal');
            });
            
            editTransactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const transactionId = parseInt(document.getElementById('editTransactionId').value);
                const transaction = transactions.find(t => t.id === transactionId);
                if (transaction) {
                    transaction.description = document.getElementById('editTransactionDescription').value;
                    transaction.amount = parseFloat(document.getElementById('editTransactionAmount').value);
                    transaction.date = document.getElementById('editTransactionDate').value;
                }
                saveData();
                renderAll();
                hideModal('editTransactionModal');
            });
            
            appContainer.addEventListener('click', (e) => {
                const rentButton = e.target.closest('.rent-btn');
                if (rentButton) {
                    const itemId = parseInt(rentButton.dataset.id);
                    const item = items.find(i => i.id === itemId);
                    
                    rentItemForm.reset();
                    document.getElementById('rentModalTitle').textContent = "Registrar Aluguel";
                    document.getElementById('rentItemId').value = item.id;
                    document.getElementById('rentValue').value = item.value;
                    document.getElementById('rentStartDate').value = getTodayDateString();
                    showModal('rentItemModal');
                }

                const addRevenueButton = e.target.closest('.add-revenue-btn');
                if (addRevenueButton) {
                    const itemId = parseInt(addRevenueButton.dataset.id);
                    const item = items.find(i => i.id === itemId);
                    
                    switchTab('finance');
                    
                    document.getElementById('transactionModalTitle').textContent = 'Adicionar Receita';
                    document.getElementById('transactionType').value = 'revenue';
                    document.getElementById('managementFeeContainer').style.display = 'block';
                    addTransactionForm.reset();
                    document.getElementById('transactionDate').value = getTodayDateString();
                    populateTransactionItemSelect('transactionItemLink', item.id);
                    document.getElementById('transactionDescription').value = `Recebimento aluguel: ${item.name}`;
                    document.getElementById('transactionAmount').value = item.rentValue;
                    
                    if (item.hasManagementFee && item.managementFeePercentage > 0) {
                        const feeCheckbox = document.getElementById('addManagementFee');
                        const feeDiv = document.getElementById('managementFeeDiv');
                        const feeAmountInput = document.getElementById('managementFeeAmount');
                        const fee = item.rentValue * (item.managementFeePercentage / 100);

                        feeCheckbox.checked = true;
                        feeDiv.classList.remove('hidden');
                        feeAmountInput.value = fee.toFixed(2);
                    }
                    
                    showModal('addTransactionModal');
                }
                
                const editRentButton = e.target.closest('.edit-rent-btn');
                if (editRentButton) {
                    const itemId = parseInt(editRentButton.dataset.id);
                    const item = items.find(i => i.id === itemId);

                    document.getElementById('rentModalTitle').textContent = "Editar Aluguel";
                    document.getElementById('rentItemId').value = item.id;
                    document.getElementById('tenantName').value = item.rentedTo; document.getElementById('tenantPhone').value = item.tenantPhone || ''; document.getElementById('tenantCPF').value = item.tenantCPF || '';
                    document.getElementById('rentStartDate').value = item.rentStartDate; document.getElementById('rentEndDate').value = item.rentEndDate; document.getElementById('rentValue').value = item.rentValue; document.getElementById('paymentDay').value = item.paymentDay;
                    showModal('rentItemModal');
                }
                
                const deleteButton = e.target.closest('.delete-btn');
                if (deleteButton) {
                    const itemId = parseInt(deleteButton.dataset.id);
                    const item = items.find(i => i.id === itemId);
                    if (item.rentedTo) {
                        showConfirmModal('Finalizar Aluguel', `Isso irá finalizar o aluguel do item "${item.name}" e o tornará disponível. Deseja continuar?`, () => {
                            finalizeRental(itemId);
                            saveData();
                            renderAll();
                        });
                    } else {
                        showConfirmModal('Apagar Item', `Você tem certeza que deseja apagar o item "${item.name}"? Esta ação não pode ser desfeita.`, () => {
                            items = items.filter(i => i.id !== itemId);
                            // Also remove from any manager
                            managers.forEach(m => {
                                m.assignedItemIds = m.assignedItemIds.filter(id => id !== itemId);
                            });
                            saveData();
                            renderAll();
                        });
                    }
                }
                
                const editItemButton = e.target.closest('.edit-item-btn');
                if (editItemButton) {
                    const itemId = parseInt(editItemButton.dataset.id);
                    const item = items.find(i => i.id === itemId);
                    document.getElementById('editItemId').value = item.id;
                    document.getElementById('editItemName').value = item.name; document.getElementById('editItemDescription').value = item.description;
                    document.getElementById('editItemValue').value = item.value; document.getElementById('editItemPaymentFrequency').value = item.paymentFrequency;
                    const categorySelect = document.getElementById('editItemCategorySelect');
                    const otherWrapper = document.getElementById('editItemCategoryOtherWrapper'); const otherInput = document.getElementById('editItemCategoryOther'); const imovelWrapper = document.getElementById('editImovelFieldsWrapper');
                    const predefinedCategories = Array.from(categorySelect.options).map(opt => opt.value);
                    if (predefinedCategories.includes(item.category) && item.category !== 'outro') { categorySelect.value = item.category; otherWrapper.classList.add('hidden'); } 
                    else { categorySelect.value = 'outro'; otherInput.value = item.category; otherWrapper.classList.remove('hidden'); }
                    
                    const isImovel = categorySelect.value === 'Imóvel';
                    imovelWrapper.classList.toggle('hidden', !isImovel);
                    if(isImovel) { 
                        document.getElementById('editItemEndereco').value = item.endereco || ''; 
                        document.getElementById('editItemCep').value = item.cep || ''; 
                        const managedBySelect = document.getElementById('editItemManagedBy');
                        const managerNameWrapper = document.getElementById('editItemManagerName').parentElement;
                        const feeWrapper = document.getElementById('editItemHasManagementFee').parentElement.parentElement;
                        const feeCheckbox = document.getElementById('editItemHasManagementFee');
                        const feePercentageWrapper = document.getElementById('editItemManagementFeePercentage').parentElement;

                        managedBySelect.value = item.managedBy || 'particular';
                        const showManagerFields = managedBySelect.value === 'imobiliaria' || managedBySelect.value === 'outros';
                        managerNameWrapper.classList.toggle('hidden', !showManagerFields);
                        feeWrapper.classList.toggle('hidden', !showManagerFields);

                        if (showManagerFields) {
                            document.getElementById('editItemManagerName').value = item.managerName || '';
                            feeCheckbox.checked = item.hasManagementFee || false;
                            feePercentageWrapper.classList.toggle('hidden', !feeCheckbox.checked);
                            if (feeCheckbox.checked) {
                                document.getElementById('editItemManagementFeePercentage').value = item.managementFeePercentage || 10;
                            }
                        }
                    }
                    showModal('editItemModal');
                }
                
                const editTransactionButton = e.target.closest('.edit-transaction-btn');
                if (editTransactionButton) {
                    const transactionId = parseInt(editTransactionButton.dataset.id);
                    const transaction = transactions.find(t => t.id === transactionId);
                    document.getElementById('editTransactionId').value = transaction.id;
                    document.getElementById('editTransactionDescription').value = transaction.description;
                    document.getElementById('editTransactionAmount').value = transaction.amount;
                    document.getElementById('editTransactionDate').value = transaction.date;
                    showModal('editTransactionModal');
                }

                const deleteTransactionButton = e.target.closest('.delete-transaction-btn');
                if (deleteTransactionButton) {
                    const transactionId = parseInt(deleteTransactionButton.dataset.id);
                    const transaction = transactions.find(t => t.id === transactionId);
                    showConfirmModal('Excluir Transação', `Você tem certeza que deseja excluir a transação "${transaction.description}"?`, () => {
                        const txToDelete = transactions.find(t => t.id === transactionId);
                        if (txToDelete && txToDelete.type === 'revenue' && txToDelete.itemId) {
                            const item = items.find(i => i.id === txToDelete.itemId);
                            if (item && item.paymentsMade) {
                                const transactionDate = new Date(txToDelete.date + 'T00:00:00');
                                const paymentPeriod = `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}`;
                                
                                const index = item.paymentsMade.indexOf(paymentPeriod);
                                if (index > -1) {
                                    item.paymentsMade.splice(index, 1);
                                }
                            }
                        }

                        transactions = transactions.filter(t => t.id !== transactionId);
                        saveData();
                        renderAll();
                    });
                }
                
                const resolvePaymentBtn = e.target.closest('.resolve-payment-btn');
                if(resolvePaymentBtn) {
                    const itemId = parseInt(resolvePaymentBtn.dataset.id);
                    const item = items.find(i => i.id === itemId);
                    document.getElementById('paymentAlertItemId').value = item.id;
                    document.getElementById('paymentAlertItemName').textContent = item.name;
                    showModal('paymentAlertModal');
                }
                
                const resolveContractEndBtn = e.target.closest('.resolve-contract-end-btn');
                if(resolveContractEndBtn) {
                    const itemId = parseInt(resolveContractEndBtn.dataset.id);
                    const item = items.find(i => i.id === itemId);
                    document.getElementById('contractEndItemId').value = item.id;
                    document.getElementById('contractEndItemName').textContent = item.name;
                    showModal('contractEndModal');
                }
            });

            rentItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const itemId = parseInt(document.getElementById('rentItemId').value);
                const item = items.find(i => i.id === itemId);

                item.rentedTo = document.getElementById('tenantName').value;
                item.tenantPhone = document.getElementById('tenantPhone').value;
                item.tenantCPF = document.getElementById('tenantCPF').value;
                item.rentStartDate = document.getElementById('rentStartDate').value;
                item.rentEndDate = document.getElementById('rentEndDate').value;
                item.rentValue = parseFloat(document.getElementById('rentValue').value);
                item.paymentDay = parseInt(document.getElementById('paymentDay').value);
                
                if (!item.paymentsMade) {
                    item.paymentsMade = [];
                }
                item.lastPaymentAlertDate = null;
                item.endOfContractNotified = false;
                item.renewalPending = false;
                
                saveData();
                renderAll();
                hideModal('rentItemModal');
                rentItemForm.reset();
            });

            addTransactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedItemId = document.getElementById('transactionItemLink').value;
                const description = document.getElementById('transactionDescription').value;
                let finalDescription = description;

                if (selectedItemId && description.startsWith('Recebimento aluguel:')) {
                    finalDescription = 'Recebimento de Aluguel';
                }

                const newTransaction = {
                    id: Date.now(),
                    type: document.getElementById('transactionType').value, 
                    description: finalDescription, 
                    amount: parseFloat(document.getElementById('transactionAmount').value),
                    date: document.getElementById('transactionDate').value, 
                    itemId: selectedItemId ? parseInt(selectedItemId) : null
                };

                if (newTransaction.type === 'revenue' && selectedItemId) {
                    const item = items.find(i => i.id === parseInt(selectedItemId));
                    if (item && item.rentedTo) { 
                        const transactionDate = new Date(newTransaction.date + 'T00:00:00');
                        const paymentPeriod = `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}`;
                        if (!item.paymentsMade) item.paymentsMade = [];
                        if (!item.paymentsMade.includes(paymentPeriod)) item.paymentsMade.push(paymentPeriod);
                    }
                }

                transactions.push(newTransaction);

                const addFee = document.getElementById('addManagementFee').checked;
                const feeAmount = parseFloat(document.getElementById('managementFeeAmount').value);
                if (addFee && !isNaN(feeAmount) && feeAmount > 0 && newTransaction.type === 'revenue') {
                     const item = items.find(i => i.id === parseInt(selectedItemId));
                     const feeDescription = `Taxa de Gerência - ${item ? item.name : description}`;
                     const feeTransaction = { id: Date.now() + 1, type: 'management_fee', description: feeDescription, amount: feeAmount, date: newTransaction.date, itemId: newTransaction.itemId };
                    transactions.push(feeTransaction);
                }
                saveData();
                renderAll();
                hideModal('addTransactionModal');
                addTransactionForm.reset();
            });
            
            // --- Handlers para Modais de Alerta ---
            document.getElementById('paymentReceivedBtn').addEventListener('click', () => {
                const itemId = parseInt(document.getElementById('paymentAlertItemId').value);
                const item = items.find(i => i.id === itemId);
                
                item.lastPaymentAlertDate = getTodayDateString();
                saveData(); 
                hideModal('paymentAlertModal');
                
                switchTab('finance');
                
                document.getElementById('transactionModalTitle').textContent = 'Adicionar Receita';
                document.getElementById('transactionType').value = 'revenue'; document.getElementById('managementFeeContainer').style.display = 'block';
                addTransactionForm.reset(); document.getElementById('transactionDate').value = getTodayDateString();
                populateTransactionItemSelect('transactionItemLink', item.id);
                document.getElementById('transactionDescription').value = `Recebimento aluguel: ${item.name}`; document.getElementById('transactionAmount').value = item.rentValue;
                showModal('addTransactionModal');

                renderAll();
            });

            document.getElementById('snoozePaymentBtn').addEventListener('click', () => {
                const itemId = parseInt(document.getElementById('paymentAlertItemId').value);
                const item = items.find(i => i.id === itemId);
                const today = new Date();
                today.setDate(today.getDate() + 7);
                item.lastPaymentAlertDate = dateToYMD(today);
                saveData();
                renderAll();
                hideModal('paymentAlertModal');
            });

            document.getElementById('forgetReminderBtn').addEventListener('click', () => {
                const itemId = parseInt(document.getElementById('paymentAlertItemId').value);
                const item = items.find(i => i.id === itemId);
                const today = new Date();
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                item.lastPaymentAlertDate = dateToYMD(endOfMonth);
                saveData();
                renderAll();
                hideModal('paymentAlertModal');
            });
            
            document.getElementById('setPaymentPendingBtn').addEventListener('click', () => hideModal('paymentAlertModal'));
            
            document.getElementById('renewContractBtn').addEventListener('click', () => {
                const itemId = parseInt(document.getElementById('contractEndItemId').value);
                const item = items.find(i => i.id === itemId);
                
                item.endOfContractNotified = true;
                saveData();
                hideModal('contractEndModal');
                
                document.getElementById('rentModalTitle').textContent = "Renovar Aluguel";
                document.getElementById('rentItemId').value = item.id; document.getElementById('rentValue').value = item.rentValue;
                const newStartDate = new Date(item.rentEndDate + 'T00:00:00'); newStartDate.setDate(newStartDate.getDate() + 1);
                document.getElementById('rentStartDate').value = dateToYMD(newStartDate); document.getElementById('rentEndDate').value = '';
                document.getElementById('tenantName').value = item.rentedTo; document.getElementById('paymentDay').value = item.paymentDay;
                showModal('rentItemModal');
                renderAll();
            });

            document.getElementById('setRenewalPendingBtn').addEventListener('click', () => {
                const itemId = parseInt(document.getElementById('contractEndItemId').value);
                const item = items.find(i => i.id === itemId);
                item.renewalPending = true;
                item.endOfContractNotified = true;
                saveData();
                renderAll();
                hideModal('contractEndModal');
            });
            
            document.getElementById('endContractBtn').addEventListener('click', () => {
                const itemId = parseInt(document.getElementById('contractEndItemId').value);
                const item = items.find(i => i.id === itemId);
                
                finalizeRental(itemId);
                saveData();
                renderAll();
                hideModal('contractEndModal');
            });
            
            document.getElementById('confirmActionConfirm').addEventListener('click', () => { if (typeof onConfirm === 'function') onConfirm(); hideModal('confirmActionModal'); onConfirm = null; });
            document.getElementById('confirmActionCancel').addEventListener('click', () => { hideModal('confirmActionModal'); onConfirm = null; });

            // --- Handlers para Configurações ---
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsTabButtons = document.querySelectorAll('.settings-tab-button');
            const settingsTabContents = document.querySelectorAll('.settings-tab-content');
            const changePasswordForm = document.getElementById('changePasswordForm');
            const passwordChangeFeedback = document.getElementById('passwordChangeFeedback');
            const managerForm = document.getElementById('managerForm');

            settingsBtn.addEventListener('click', () => {
                showModal('settingsModal');
                passwordChangeFeedback.innerHTML = '';
                changePasswordForm.reset();
            });

            document.getElementById('openAddManagerModal').addEventListener('click', () => {
                document.getElementById('managerModalTitle').textContent = 'Adicionar Novo Gestor';
                managerForm.reset();
                document.getElementById('managerId').value = '';

                const rentalsListDiv = document.getElementById('managerRentalsList');
                rentalsListDiv.innerHTML = '';
                const rentedItems = items.filter(item => item.rentedTo);

                if (rentedItems.length === 0) {
                    rentalsListDiv.innerHTML = '<p class="text-gray-400">Nenhum aluguel ativo para associar.</p>';
                } else {
                    rentedItems.forEach(item => {
                        const checkboxId = `manager-item-add-${item.id}`;
                        const label = document.createElement('label');
                        label.htmlFor = checkboxId;
                        label.className = 'flex items-center space-x-3 p-2 rounded-md hover:bg-gray-600/50 cursor-pointer';
                        label.innerHTML = `
                            <input type="checkbox" id="${checkboxId}" value="${item.id}" name="assignedItems" class="h-4 w-4 bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600">
                            <span>${item.name} <span class="text-xs text-gray-400">(${item.rentedTo})</span></span>
                        `;
                        rentalsListDiv.appendChild(label);
                    });
                }
                showModal('managerModal');
            });

            managerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const assignedItemsCheckboxes = document.querySelectorAll('#managerRentalsList input[type="checkbox"]:checked');
                const assignedItemIds = Array.from(assignedItemsCheckboxes).map(cb => parseInt(cb.value));
                const managerId = parseInt(document.getElementById('managerId').value);

                if (managerId) { // Edit
                    const manager = managers.find(m => m.id === managerId);
                    if (manager) {
                        manager.type = document.getElementById('managerType').value;
                        manager.name = document.getElementById('managerName').value;
                        manager.password = document.getElementById('managerPassword').value;
                        manager.assignedItemIds = assignedItemIds;
                    }
                } else { // Add
                    const newManager = {
                        id: Date.now(),
                        type: document.getElementById('managerType').value,
                        name: document.getElementById('managerName').value,
                        password: document.getElementById('managerPassword').value,
                        assignedItemIds: assignedItemIds
                    };
                    managers.push(newManager);
                }
                
                saveData();
                renderAll();
                hideModal('managerModal');
            });


            const switchSettingsTab = (tabId) => {
                settingsTabButtons.forEach(btn => {
                    const isCorrectTab = btn.dataset.tab === tabId;
                    btn.classList.toggle('active-settings-tab', isCorrectTab);
                    btn.classList.toggle('text-gray-100', isCorrectTab);
                    btn.classList.toggle('bg-gray-700', isCorrectTab);
                    btn.classList.toggle('text-gray-400', !isCorrectTab);
                     btn.classList.toggle('hover:bg-gray-700/50', !isCorrectTab);
                });
                settingsTabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tabId}-settings-content`).classList.remove('hidden');
            };

            settingsTabButtons.forEach(button => button.addEventListener('click', () => switchSettingsTab(button.dataset.tab)));
            
            changePasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;

                passwordChangeFeedback.innerHTML = '';
                passwordChangeFeedback.classList.remove('text-green-400', 'text-red-400');

                if (currentPassword !== settings.password) {
                    passwordChangeFeedback.textContent = 'A senha atual está incorreta.';
                    passwordChangeFeedback.classList.add('text-red-400');
                    return;
                }
                if (!newPassword || newPassword.length < 4) {
                    passwordChangeFeedback.textContent = 'A nova senha deve ter pelo menos 4 caracteres.';
                    passwordChangeFeedback.classList.add('text-red-400');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    passwordChangeFeedback.textContent = 'As novas senhas não correspondem.';
                    passwordChangeFeedback.classList.add('text-red-400');
                    return;
                }

                settings.password = newPassword;
                saveSettings();
                passwordChangeFeedback.textContent = 'Senha alterada com sucesso!';
                passwordChangeFeedback.classList.add('text-green-400');
                changePasswordForm.reset();
            });

            const customizeUIForUser = () => {
                // Determina se o utilizador atual é um gestor
                const isManager = currentUser.type === 'manager';

                // --- 1. Personalização do Cabeçalho ---
                document.getElementById('app-title').textContent = isManager ? (currentUser.name || 'Gestor') : 'Meu Gestor de Aluguéis';
                document.getElementById('settingsBtn').style.display = isManager ? 'none' : 'flex';
                document.getElementById('openAddItemModal').style.display = isManager ? 'none' : 'inline-flex';

                // --- 2. Personalização das Abas de Navegação (Superior e Inferior) ---
                const gestoresMainTab = document.getElementById('gestores-main-tab');
                const gestoresBottomTab = document.getElementById('gestores-bottom-tab');
                const adminOnlyTabs = ['notifications']; // Abas visíveis apenas para o admin

                // Lógica para a aba "Gestores"
                if (isManager) {
                    // O gestor nunca vê a aba "Gestores"
                    if (gestoresMainTab) gestoresMainTab.style.display = 'none';
                    if (gestoresBottomTab) gestoresBottomTab.style.display = 'none';
                } else {
                    // O admin só vê a aba se existirem gestores
                    const shouldShow = managers.length > 0;
                    if (gestoresMainTab) gestoresMainTab.style.display = shouldShow ? 'flex' : 'none';
                    if (gestoresBottomTab) gestoresBottomTab.style.display = shouldShow ? 'flex' : 'none';
                }

                // Itera por todos os botões de abas para ajustar visibilidade e texto
                document.querySelectorAll('#top-nav .tab-button, #bottom-nav .tab-button').forEach(tab => {
                    const tabName = tab.dataset.tab;

                    if (tabName === 'gestores') return; // Já foi tratado acima

                    // Oculta abas que são apenas para o admin
                    if (isManager && adminOnlyTabs.includes(tabName)) {
                        tab.style.display = 'none';
                        return; // Pula para a próxima iteração
                    } else {
                        tab.style.display = 'flex';
                    }

                    // Ajusta o texto das abas "Itens" e "Aluguéis"
                    const textSpan = tab.querySelector('span:not(.notification-badge)');
                    if (!textSpan) return;

                    if (tabName === 'items') {
                        if (isManager) {
                            textSpan.textContent = 'Itens';
                        } else {
                            // Para o admin, o texto muda entre desktop (top-nav) e mobile (bottom-nav)
                            textSpan.textContent = tab.closest('#top-nav') ? 'Meus Itens' : 'Itens';
                        }
                    } else if (tabName === 'rentals') {
                        if (isManager) {
                            textSpan.textContent = 'Aluguéis';
                        } else {
                            textSpan.textContent = tab.closest('#top-nav') ? 'Meus Aluguéis' : 'Aluguéis';
                        }
                    }
                });


                // --- 3. Personalização dos Títulos dentro do Conteúdo das Abas ---
                document.getElementById('total-items-title').textContent = isManager ? 'Itens Gerenciados' : 'Total de Itens';
                document.getElementById('rentals-title').textContent = isManager ? 'Aluguéis Ativos' : 'Aluguéis Ativos (por pendência)';
                document.getElementById('financial-overview-title').textContent = isManager ? 'Visão Geral (Gerência)' : 'Visão Geral Financeira';
            };


            // Carga Inicial
            loadData();
            initDashboardFilters();
            renderAll();
        }
    });
    </script>
</body>
</html>


