<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Gestor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal { display: none; }
        .modal.active { display: flex; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .bottom-nav-btn.active-tab { color: #22d3ee; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">

    <div id="app" class="max-w-7xl mx-auto p-2 sm:p-6 lg:p-8 pb-24 md:pb-8">
        
        <!-- Cabeçalho -->
        <header class="flex justify-between items-center mb-6">
            <h1 id="manager-name-header" class="text-2xl sm:text-3xl font-bold text-cyan-400">Carregando...</h1>
            <button id="logoutBtn" class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-colors" title="Sair">
                <i data-lucide="log-out" class="h-5 w-5 mr-0 sm:mr-2"></i>
                <span class="hidden sm:inline">Sair</span>
            </button>
        </header>

        <!-- Navegação (Desktop) -->
        <div class="mb-6 hidden md:block">
            <div class="border-b border-gray-700">
                <nav id="top-nav" class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button class="tab-button active-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-cyan-500 text-cyan-400" data-tab="dashboard"><span>Painel</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="items"><span>Itens</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="rentals"><span>Aluguéis</span></button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500" data-tab="transactions"><span>Transações</span></button>
                </nav>
            </div>
        </div>

        <!-- Conteúdo das Abas -->
        <main>
            <!-- Aba Painel -->
            <div id="dashboard-content" class="tab-content">
                <div class="space-y-4">
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-row items-center gap-4">
                        <i data-lucide="package" class="h-8 w-8 text-cyan-400 flex-shrink-0"></i>
                        <div class="flex-grow flex justify-between items-center">
                            <h3 class="text-md font-medium text-gray-300">Itens Gerenciados</h3>
                            <p id="total-items" class="text-2xl sm:text-3xl font-semibold">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-row items-center gap-4">
                         <i data-lucide="package-x" class="h-8 w-8 text-cyan-400 flex-shrink-0"></i>
                        <div class="flex-grow flex justify-between items-center">
                            <h3 class="text-md font-medium text-gray-300">Alugados</h3>
                            <p id="rented-items" class="text-2xl sm:text-3xl font-semibold">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-row items-center gap-4">
                        <i data-lucide="package-check" class="h-8 w-8 text-cyan-400 flex-shrink-0"></i>
                        <div class="flex-grow flex justify-between items-center">
                            <h3 class="text-md font-medium text-gray-300">Disponíveis</h3>
                            <p id="available-items" class="text-2xl sm:text-3xl font-semibold">0</p>
                        </div>
                    </div>
                     <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-row items-center gap-4">
                        <i data-lucide="arrow-down-circle" class="h-8 w-8 text-red-400 flex-shrink-0"></i>
                        <div class="flex-grow flex justify-between items-center">
                             <h3 class="text-md font-medium text-gray-300">Despesas (Mês)</h3>
                            <p id="month-expense" class="text-2xl sm:text-3xl font-semibold text-red-400">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-row items-center gap-4">
                        <i data-lucide="percent" class="h-8 w-8 text-yellow-400 flex-shrink-0"></i>
                        <div class="flex-grow flex justify-between items-center">
                            <h3 class="text-md font-medium text-gray-300">Taxas (Mês)</h3>
                            <p id="month-fee" class="text-2xl sm:text-3xl font-semibold text-yellow-400">R$ 0,00</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Itens -->
            <div id="items-content" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="package-check" class="mr-3 text-green-400"></i>Disponíveis para Alugar</h2>
                        <div id="available-list" class="space-y-4"></div>
                    </div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="package-x" class="mr-3 text-red-400"></i>Atualmente Alugados</h2>
                        <div id="rented-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Aba Aluguéis -->
            <div id="rentals-content" class="tab-content hidden">
                <h2 class="text-xl sm:text-2xl font-semibold mb-4 flex items-center"><i data-lucide="calendar-clock" class="mr-3 text-cyan-400"></i>Aluguéis Ativos</h2>
                <div id="sorted-rentals-list" class="space-y-4"></div>
            </div>
            
            <!-- Aba Transações -->
            <div id="transactions-content" class="tab-content hidden">
                 <div class="flex flex-wrap gap-4 mb-6">
                     <button id="openAddRevenueModal" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                         <i data-lucide="trending-up" class="mr-2 h-5 w-5"></i>
                         <span>Adicionar Receita</span>
                     </button>
                     <button id="openAddExpenseModal" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                         <i data-lucide="trending-down" class="mr-2 h-5 w-5"></i>
                         <span>Adicionar Despesa</span>
                     </button>
                 </div>

                <!-- Filtros de Transações -->
                 <div class="bg-gray-800 p-4 rounded-xl mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold">Filtrar Transações</h3>
                        <button id="clearFiltersBtn" title="Limpar Filtros" class="bg-gray-600 hover:bg-gray-500 text-white font-bold p-2 rounded-md text-sm">
                            <i data-lucide="rotate-ccw" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="filterType" class="block text-sm font-medium mb-1">Tipo de Transação</label>
                            <select id="filterType" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
                                <option value="all">Todos</option>
                                <option value="revenue">Receita</option>
                                <option value="expense">Despesa</option>
                                <option value="management_fee">Taxa de Gerência</option>
                            </select>
                        </div>
                         <div>
                            <label for="filterStartDate" class="block text-sm font-medium mb-1">A partir de</label>
                            <input type="date" id="filterStartDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm">
                        </div>
                    </div>
                 </div>

                 <h2 class="text-xl sm:text-2xl font-semibold mb-4">Histórico de Transações</h2>
                <div id="transactions-list" class="space-y-4 md:space-y-0"></div>
            </div>
        </main>
    </div>

    <!-- Navegação (Mobile) -->
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around p-2 z-40">
        <button class="tab-button bottom-nav-btn active-tab flex flex-col items-center text-gray-400 p-2" data-tab="dashboard">
            <i data-lucide="layout-dashboard" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Painel</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2" data-tab="items">
            <i data-lucide="archive" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Itens</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2" data-tab="rentals">
            <i data-lucide="calendar-clock" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Aluguéis</span>
        </button>
        <button class="tab-button bottom-nav-btn flex flex-col items-center text-gray-400 p-2" data-tab="transactions">
            <i data-lucide="piggy-bank" class="h-6 w-6"></i>
            <span class="text-xs mt-1">Transações</span>
        </button>
    </nav>
    
    <!-- Modals -->
    <!-- Modal Alugar/Editar Aluguel -->
    <div id="rentItemModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
         <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="rentItemForm">
                <h2 id="rentModalTitle" class="text-2xl font-bold mb-4">Registrar Aluguel</h2>
                <input type="hidden" id="rentItemId">
                <div class="space-y-4">
                    <div>
                        <label for="tenantName" class="block mb-1 font-medium">Nome do Inquilino/Cliente</label>
                        <input type="text" id="tenantName" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="rentStartDate" class="block mb-1 font-medium">Data de Início</label>
                        <input type="date" id="rentStartDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="rentEndDate" class="block mb-1 font-medium">Data de Término</label>
                        <div class="flex items-center space-x-2">
                            <input type="date" id="rentEndDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                            <button type="button" id="setOneYearBtn" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded-md text-sm whitespace-nowrap">1 Ano</button>
                        </div>
                    </div>
                     <div>
                        <label for="rentValue" class="block mb-1 font-medium">Valor Combinado (R$)</label>
                        <input type="number" step="0.01" id="rentValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="paymentDay" class="block mb-1 font-medium">Dia do Pagamento Mensal</label>
                        <input type="number" id="paymentDay" min="1" max="31" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Ex: 5" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Adicionar Transação -->
    <div id="addTransactionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
            <form id="addTransactionForm">
                <h2 id="transactionModalTitle" class="text-2xl font-bold mb-4">Adicionar Transação</h2>
                <input type="hidden" id="transactionType">
                <input type="hidden" id="isDirectIptuPayment" value="false">
                <div class="space-y-4">
                    <div>
                        <label for="transactionItemLink" class="block mb-1 font-medium">Associar a um Item</label>
                        <select id="transactionItemLink" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required></select>
                    </div>
                    <div>
                        <label for="transactionDescription" class="block mb-1 font-medium">Descrição</label>
                        <textarea id="transactionDescription" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required></textarea>
                    </div>
                    <div>
                        <label for="transactionAmount" class="block mb-1 font-medium">Valor (R$)</label>
                        <input type="number" step="0.01" id="transactionAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="transactionDate" class="block mb-1 font-medium">Data</label>
                        <input type="date" id="transactionDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Editar Transação -->
    <div id="editTransactionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <form id="editTransactionForm">
                <h2 class="text-2xl font-bold mb-4">Editar Transação</h2>
                <input type="hidden" id="editTransactionId">
                <div class="space-y-4">
                     <div>
                        <label for="editTransactionDescription" class="block mb-1 font-medium">Descrição</label>
                        <textarea id="editTransactionDescription" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required></textarea>
                    </div>
                    <div>
                        <label for="editTransactionAmount" class="block mb-1 font-medium">Valor (R$)</label>
                        <input type="number" step="0.01" id="editTransactionAmount" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="editTransactionDate" class="block mb-1 font-medium">Data</label>
                        <input type="date" id="editTransactionDate" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Registrar IPTU -->
    <div id="iptuModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <form id="iptuForm">
                <h2 id="iptuModalTitle" class="text-2xl font-bold mb-4">Registrar IPTU</h2>
                <input type="hidden" id="iptuItemId">
                <div class="space-y-4">
                    <div>
                        <label for="iptuInstallmentValue" class="block mb-1 font-medium">Valor de Cada Parcela (R$)</label>
                        <input type="number" step="0.01" id="iptuInstallmentValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="iptuInstallments" class="block mb-1 font-medium">Pagar em</label>
                        <select id="iptuInstallments" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                            <option value="1">1 parcela (à vista)</option>
                            <option value="2">2 parcelas</option>
                            <option value="3">3 parcelas</option>
                            <option value="4">4 parcelas</option>
                            <option value="5">5 parcelas</option>
                            <option value="6">6 parcelas</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gerenciar IPTU -->
    <div id="manageIptuModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <form id="manageIptuForm">
                <h2 id="manageIptuModalTitle" class="text-2xl font-bold mb-4">Gerenciar IPTU</h2>
                <input type="hidden" id="manageIptuItemId">
                <input type="hidden" id="manageIptuYear">
                <div class="space-y-4">
                    <div>
                        <label for="manageIptuInstallmentValue" class="block mb-1 font-medium">Valor de Cada Parcela (R$)</label>
                        <input type="number" step="0.01" id="manageIptuInstallmentValue" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                    </div>
                    <div>
                        <label for="manageIptuInstallments" class="block mb-1 font-medium">Pagar em</label>
                        <select id="manageIptuInstallments" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                            <option value="1">1 parcela (à vista)</option>
                            <option value="2">2 parcelas</option>
                            <option value="3">3 parcelas</option>
                            <option value="4">4 parcelas</option>
                            <option value="5">5 parcelas</option>
                            <option value="6">6 parcelas</option>
                        </select>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Parcelas Pagas: <span id="manageIptuPaidInstallments" class="font-semibold text-white">0</span></p>
                        <p id="manageIptuWarning" class="text-xs text-yellow-400 mt-1 hidden">Atenção: Alterar o número de parcelas reseta os pagamentos.</p>
                    </div>
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <button type="button" id="deleteIptuBtn" class="px-4 py-2 bg-red-700 hover:bg-red-600 rounded-md font-semibold text-sm">Apagar</button>
                    <div class="flex space-x-3">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-md font-semibold">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Confirmar Ação -->
    <div id="confirmActionModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h2 id="confirmActionTitle" class="text-xl font-bold mb-4">Confirmar Ação</h2>
            <p id="confirmActionMessage" class="mb-6 text-gray-300">Você tem certeza?</p>
            <div class="flex justify-center space-x-3">
                <button id="confirmActionCancel" class="px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                <button id="confirmActionConfirm" class="px-6 py-2 bg-red-600 hover:bg-red-500 rounded-md font-semibold">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- AUTENTICAÇÃO E CARGA DE DADOS ---
        const currentManagerJSON = localStorage.getItem('currentManager');
        if (!currentManagerJSON) {
            window.location.href = './index.html';
            return;
        }
        const currentManager = JSON.parse(currentManagerJSON);

        let allItems = [];
        let allTransactions = [];
        let managedItems = [];
        let managedTransactions = [];
        let settings = {};

        const loadData = () => {
            const storedItems = localStorage.getItem('rentalManagerItems');
            allItems = storedItems ? JSON.parse(storedItems) : [];

            const storedTransactions = localStorage.getItem('rentalManagerTransactions');
            allTransactions = storedTransactions ? JSON.parse(storedTransactions) : [];
            
            const storedSettings = localStorage.getItem('rentalManagerSettings');
            settings = storedSettings ? JSON.parse(storedSettings) : {};


            // Filtra dados específicos do gestor
            managedItems = allItems.filter(item => currentManager.assignedItemIds.includes(item.id));
            const managedItemIds = new Set(managedItems.map(item => item.id));
            managedTransactions = allTransactions.filter(tx => tx.itemId && managedItemIds.has(tx.itemId));
        };

        const saveData = () => {
            // Gestores só podem modificar transações e status de aluguel dos itens
            localStorage.setItem('rentalManagerItems', JSON.stringify(allItems));
            localStorage.setItem('rentalManagerTransactions', JSON.stringify(allTransactions));
        };

        // --- RENDERIZAÇÃO INICIAL E CONTROLES GERAIS ---
        lucide.createIcons();
        
        const modals = document.querySelectorAll('.modal');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const iptuForm = document.getElementById('iptuForm');
        const manageIptuForm = document.getElementById('manageIptuForm');
        
        document.title = `Painel: ${currentManager.name}`;
        document.getElementById('manager-name-header').textContent = currentManager.name;

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        const formatDate = (dateString) => { if(!dateString) return ''; const date = new Date(dateString); return new Date(date.getTime() + (date.getTimezoneOffset() * 60000)).toLocaleDateString('pt-BR'); };
        const dateToYMD = (date) => date.toISOString().split('T')[0];
        const getTodayDateString = () => dateToYMD(new Date());

        const showModal = (modalId) => document.getElementById(modalId).classList.add('active');
        const hideModal = (modalId) => document.getElementById(modalId).classList.remove('active');
        
        let onConfirm = null;
        const showConfirmModal = (title, message, onConfirmCallback) => {
            document.getElementById('confirmActionTitle').textContent = title;
            document.getElementById('confirmActionMessage').textContent = message;
            onConfirm = onConfirmCallback;
            showModal('confirmActionModal');
        };

        const switchTab = (tabId) => {
            tabButtons.forEach(btn => {
                const isCorrectTab = btn.dataset.tab === tabId;
                btn.classList.toggle('active-tab', isCorrectTab);
                
                if (btn.closest('#top-nav')) { // Desktop
                    btn.classList.toggle('border-cyan-500', isCorrectTab);
                    btn.classList.toggle('text-cyan-400', isCorrectTab);
                    btn.classList.toggle('border-transparent', !isCorrectTab);
                    btn.classList.toggle('text-gray-400', !isCorrectTab);
                }
            });
            tabContents.forEach(content => content.classList.add('hidden'));
            document.getElementById(`${tabId}-content`).classList.remove('hidden');
        };
        
        const renderAll = () => {
            loadData();
            renderDashboard();
            renderItems();
            renderRentals();
            applyManagerFiltersAndRender();
            lucide.createIcons();
        };

        // --- LÓGICA DE FILTRO E RENDERIZAÇÃO DAS ABAS ---

        const applyManagerFiltersAndRender = () => {
            const type = document.getElementById('filterType').value;
            const startDate = document.getElementById('filterStartDate').value;

            let filtered = managedTransactions.filter(t => {
                const tDate = new Date(t.date + 'T00:00:00');
                const start = startDate ? new Date(startDate + 'T00:00:00') : null;

                if (type !== 'all' && t.type !== type) return false;
                if (start && tDate < start) return false;
                
                return true;
            });
            renderTransactions(filtered.sort((a,b) => b.id - a.id));
        };

        const renderDashboard = () => {
            const rentedCount = managedItems.filter(item => item.rentedTo).length;
            document.getElementById('total-items').textContent = managedItems.length;
            document.getElementById('rented-items').textContent = rentedCount;
            document.getElementById('available-items').textContent = managedItems.length - rentedCount;

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const monthTransactions = managedTransactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
            });

            const totalFees = monthTransactions.filter(t => t.type === 'management_fee').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('month-fee').textContent = formatCurrency(totalFees);
            document.getElementById('month-expense').textContent = formatCurrency(totalExpenses);
        };

        const renderItems = () => {
            const availableList = document.getElementById('available-list');
            const rentedList = document.getElementById('rented-list');
            availableList.innerHTML = '';
            rentedList.innerHTML = '';

            if (managedItems.length === 0) {
                availableList.innerHTML = `<p class="text-gray-400">Nenhum item foi designado a você.</p>`;
                return;
            }
            
            const currentYear = new Date().getFullYear();

            managedItems.forEach(item => {
                const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;

                let iptuStatusHTML = '';
                if (item.category === 'Imóvel' && item.iptu && item.iptu[currentYear]) {
                    const iptuData = item.iptu[currentYear];
                    if (iptuData.paidInstallments >= iptuData.installments) {
                        iptuStatusHTML = `<p class="text-xs text-green-400 mt-1">IPTU ${currentYear}: Pago</p>`;
                    } else {
                        iptuStatusHTML = `<p class="text-xs text-blue-400 mt-1">IPTU ${currentYear}: ${iptuData.paidInstallments}/${iptuData.installments} parcelas pagas</p>`;
                    }
                }
                
                let payIptuButton = '';
                if (!item.rentedTo && item.category === 'Imóvel' && item.iptu && item.iptu[currentYear] && item.iptu[currentYear].paidInstallments < item.iptu[currentYear].installments) {
                    payIptuButton = `<button data-id="${item.id}" class="pay-iptu-expense-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md flex items-center text-xs" title="Registrar Pagamento Parcela IPTU"><i data-lucide="landmark" class="h-4 w-4 mr-1"></i>Pagar IPTU</button>`;
                }
                
                const iptuButton = item.category === 'Imóvel' ? `<button data-id="${item.id}" class="iptu-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md flex items-center text-xs" title="Gerenciar/Registrar IPTU"><i data-lucide="landmark" class="h-4 w-4 mr-1"></i>IPTU</button>` : '';

                const actionButtons = item.rentedTo
                    ? `<div class="mt-4 flex justify-end items-center flex-wrap gap-2">
                           ${iptuButton}
                           <button data-id="${item.id}" class="add-revenue-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md flex items-center text-xs" title="Adicionar Receita"><i data-lucide="dollar-sign" class="h-4 w-4 mr-1"></i>Receita</button>
                           <button data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full" title="Finalizar Aluguel"><i data-lucide="trash-2" class="h-5 w-5"></i></button>
                       </div>`
                    : `<div class="mt-4 flex justify-end items-center flex-wrap gap-2">
                           ${iptuButton}${payIptuButton}
                           <button data-id="${item.id}" class="rent-btn bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-md flex items-center text-sm"><i data-lucide="key-round" class="mr-2 h-4 w-4"></i>Alugar</button>
                       </div>`;

                const cardHTML = `
                    <div class="bg-gray-800 p-4 rounded-lg border-l-4 ${item.rentedTo ? 'border-yellow-500' : 'border-green-500'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${displayName}</h3>
                                <p class="text-sm text-gray-400">${item.category}</p>
                                ${iptuStatusHTML}
                            </div>
                            <span class="text-lg font-semibold">${formatCurrency(item.rentedTo ? item.rentValue : item.value)}</span>
                        </div>
                        ${item.description ? `<p class="text-sm text-gray-300 mt-2">${item.description}</p>` : ''}
                        ${actionButtons}
                    </div>
                `;

                if (item.rentedTo) {
                    rentedList.innerHTML += cardHTML;
                } else {
                    availableList.innerHTML += cardHTML;
                }
            });
            if(rentedList.innerHTML === '') rentedList.innerHTML = `<p class="text-gray-400">Nenhum item alugado.</p>`;
            if(availableList.innerHTML === '') availableList.innerHTML = `<p class="text-gray-400">Nenhum item disponível.</p>`;
        };

        const renderRentals = () => {
            const list = document.getElementById('sorted-rentals-list');
            list.innerHTML = '';
            const rentedItems = managedItems.filter(item => item.rentedTo);
            
            if (rentedItems.length === 0) {
                list.innerHTML = `<p class="text-gray-400">Nenhum aluguel ativo.</p>`;
                return;
            }

            rentedItems.sort((a,b) => new Date(a.rentEndDate) - new Date(b.rentEndDate));

            rentedItems.forEach(item => {
                const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
                const card = `
                    <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-cyan-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${displayName}</h3>
                                <p class="text-sm text-gray-400">Inquilino: ${item.rentedTo}</p>
                            </div>
                            <span class="text-lg font-semibold block">${formatCurrency(item.rentValue)}</span>
                        </div>
                        <div class="mt-3 text-sm space-y-1">
                            <p><strong class="text-gray-300">Dia do Pagamento:</strong> ${item.paymentDay}</p>
                            <p><strong class="text-gray-300">Término Contrato:</strong> ${formatDate(item.rentEndDate)}</p>
                        </div>
                        <div class="mt-4 flex justify-end items-center space-x-2">
                           <button data-id="${item.id}" class="add-revenue-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md flex items-center text-xs" title="Adicionar Receita"><i data-lucide="dollar-sign" class="h-4 w-4 mr-1"></i>Receita</button>
                           <button data-id="${item.id}" class="edit-rent-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Aluguel"><i data-lucide="clipboard-edit" class="h-5 w-5"></i></button>
                           <button data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full" title="Finalizar Aluguel"><i data-lucide="trash-2" class="h-5 w-5"></i></button>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
        };
        
        const renderTransactions = (transactionsToRender) => {
            const list = document.getElementById('transactions-list');
            list.innerHTML = '';

            if (!transactionsToRender || transactionsToRender.length === 0) {
                list.innerHTML = `<p class="text-gray-400">Nenhuma transação encontrada para os filtros selecionados.</p>`;
                return;
            }
            
            const mobileHTML = transactionsToRender.map(t => {
                const item = managedItems.find(i => i.id === t.itemId);
                const displayName = (item && item.category === 'Imóvel' && item.endereco) ? item.endereco : (item ? item.name : '');
                let typeClass, typeText, amountClass, amountPrefix;
                if(t.type === 'revenue') { typeClass='bg-green-900 text-green-300'; typeText='Receita'; amountClass='text-green-400'; amountPrefix='+'; }
                else if (t.type === 'expense' && t.description.startsWith('Pagamento IPTU')) { typeClass = 'bg-blue-900 text-blue-300'; typeText = 'Despesa (IPTU)'; amountClass = 'text-blue-400'; amountPrefix = '-'; }
                else if(t.type === 'expense') { typeClass='bg-red-900 text-red-300'; typeText='Despesa'; amountClass='text-red-400'; amountPrefix='-'; }
                else { typeClass='bg-yellow-900 text-yellow-300'; typeText='Taxa'; amountClass='text-yellow-400'; amountPrefix='-'; }
                
                // Botões de ação condicionais
                const actionButtons = (t.createdBy === currentManager.id)
                    ? `<div class="flex items-center justify-end space-x-2 pt-1">
                        <button data-id="${t.id}" class="edit-transaction-btn text-gray-400 hover:text-cyan-400 transition-colors p-2 rounded-full" title="Editar Transação"><i data-lucide="edit" class="h-5 w-5"></i></button>
                        <button data-id="${t.id}" class="delete-transaction-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full" title="Excluir Transação"><i data-lucide="trash-2" class="h-5 w-5"></i></button>
                    </div>`
                    : '<div class="h-10"></div>'; // Placeholder para manter altura
                
                return `<div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <p class="text-lg font-bold text-white break-words">${t.description}</p>
                    ${item ? `<p class="text-sm text-gray-400">Item: ${displayName}</p>` : ''}
                    <div class="flex items-center justify-between text-sm pt-1">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${typeClass}">${typeText}</span>
                        <span class="text-gray-400">${formatDate(t.date)}</span>
                    </div>
                    <p class="text-right text-lg font-semibold ${amountClass} mt-2">${amountPrefix} ${formatCurrency(t.amount)}</p>
                    ${actionButtons}
                </div>`;
            }).join('');
            
            list.innerHTML = `<div class="space-y-4">${mobileHTML}</div>`;
            lucide.createIcons();
        };

        // --- LÓGICA DAS AÇÕES E MODALS ---
        
        // Ações dos botões e filtros
        tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('currentManager');
            window.location.href = './index.html';
        });
        document.getElementById('filterType').addEventListener('change', applyManagerFiltersAndRender);
        document.getElementById('filterStartDate').addEventListener('input', applyManagerFiltersAndRender);
        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterStartDate').value = '';
            applyManagerFiltersAndRender();
        });


        modals.forEach(modal => modal.addEventListener('click', (e) => { 
            if (e.target.classList.contains('modal') || e.target.closest('.modal-close-btn')) hideModal(modal.id); 
        }));
        
        document.getElementById('app').addEventListener('click', (e) => {
            const rentBtn = e.target.closest('.rent-btn');
            if(rentBtn) {
                const item = managedItems.find(i => i.id === parseInt(rentBtn.dataset.id));
                const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
                document.getElementById('rentItemForm').reset();
                document.getElementById('rentModalTitle').textContent = `Alugar: ${displayName}`;
                document.getElementById('rentItemId').value = item.id;
                document.getElementById('rentValue').value = item.value;
                document.getElementById('rentStartDate').value = getTodayDateString();
                showModal('rentItemModal');
            }

            const editRentBtn = e.target.closest('.edit-rent-btn');
            if(editRentBtn) {
                const item = managedItems.find(i => i.id === parseInt(editRentBtn.dataset.id));
                 const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
                document.getElementById('rentItemForm').reset();
                document.getElementById('rentModalTitle').textContent = `Editar Aluguel: ${displayName}`;
                document.getElementById('rentItemId').value = item.id;
                document.getElementById('tenantName').value = item.rentedTo;
                document.getElementById('rentStartDate').value = item.rentStartDate;
                document.getElementById('rentEndDate').value = item.rentEndDate;
                document.getElementById('rentValue').value = item.rentValue;
                document.getElementById('paymentDay').value = item.paymentDay;
                showModal('rentItemModal');
            }

            const deleteBtn = e.target.closest('.delete-btn');
            if(deleteBtn) {
                const item = allItems.find(i => i.id === parseInt(deleteBtn.dataset.id));
                const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
                showConfirmModal('Finalizar Aluguel', `Tem certeza que deseja finalizar o aluguel do item "${displayName}"?`, () => {
                    item.rentedTo = null; item.rentStartDate = null; item.rentEndDate = null; item.rentValue = null; item.paymentDay = null; item.paymentsMade = []; item.debt = {amount: 0, cycles: 0};
                    saveData();
                    renderAll();
                });
            }

            const addRevenueBtn = e.target.closest('.add-revenue-btn');
            if(addRevenueBtn){
                const item = managedItems.find(i => i.id === parseInt(addRevenueBtn.dataset.id));
                openTransactionModal('revenue', item);
            }
            
            const iptuButton = e.target.closest('.iptu-btn');
            if (iptuButton) {
                const itemId = parseInt(iptuButton.dataset.id);
                const item = allItems.find(i => i.id === itemId);
                const currentYear = new Date().getFullYear();
                const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;

                if (item) {
                    if (item.iptu && item.iptu[currentYear]) {
                        const iptuData = item.iptu[currentYear];
                        const installmentValue = iptuData.installments > 0 ? (iptuData.totalValue / iptuData.installments) : 0;

                        document.getElementById('manageIptuModalTitle').textContent = `Gerenciar IPTU ${currentYear} - ${displayName}`;
                        document.getElementById('manageIptuItemId').value = item.id;
                        document.getElementById('manageIptuYear').value = currentYear;
                        document.getElementById('manageIptuInstallmentValue').value = installmentValue.toFixed(2);
                        document.getElementById('manageIptuInstallments').value = iptuData.installments;
                        document.getElementById('manageIptuPaidInstallments').textContent = `${iptuData.paidInstallments} de ${iptuData.installments}`;
                        document.getElementById('manageIptuWarning').classList.add('hidden');
                        showModal('manageIptuModal');
                    } else {
                        iptuForm.reset();
                        document.getElementById('iptuItemId').value = item.id;
                        document.getElementById('iptuModalTitle').textContent = `Registrar IPTU ${currentYear} para: ${displayName}`;
                        showModal('iptuModal');
                    }
                }
            }
             const payIptuExpenseButton = e.target.closest('.pay-iptu-expense-btn');
            if (payIptuExpenseButton) {
                const itemId = parseInt(payIptuExpenseButton.dataset.id);
                const item = allItems.find(i => i.id === itemId);
                const currentYear = new Date().getFullYear();

                if (item && item.iptu && item.iptu[currentYear]) {
                    const iptuData = item.iptu[currentYear];
                    if (iptuData.paidInstallments < iptuData.installments) {
                        const installmentValue = iptuData.installments > 0 ? (iptuData.totalValue / iptuData.installments) : 0;
                        openTransactionModal('expense', item, { isIptu: true, iptuData, installmentValue, currentYear });
                    } else {
                        alert("IPTU já está pago para este ano.");
                    }
                }
            }

        });
        
        document.getElementById('setOneYearBtn').addEventListener('click', () => {
            const startDateInput = document.getElementById('rentStartDate');
            if(startDateInput.value) {
                const startDate = new Date(startDateInput.value + "T00:00:00");
                startDate.setFullYear(startDate.getFullYear() + 1);
                document.getElementById('rentEndDate').value = dateToYMD(startDate);
            }
        });

        document.getElementById('openAddRevenueModal').addEventListener('click', () => openTransactionModal('revenue'));
        document.getElementById('openAddExpenseModal').addEventListener('click', () => openTransactionModal('expense'));
        
        document.getElementById('transactions-list').addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-transaction-btn');
            if(editBtn) {
                const tx = allTransactions.find(t => t.id === parseInt(editBtn.dataset.id));
                 if (tx && tx.createdBy === currentManager.id) {
                    document.getElementById('editTransactionForm').reset();
                    document.getElementById('editTransactionId').value = tx.id;
                    document.getElementById('editTransactionDescription').value = tx.description;
                    document.getElementById('editTransactionAmount').value = tx.amount;
                    document.getElementById('editTransactionDate').value = tx.date;
                    showModal('editTransactionModal');
                }
            }
            
            const deleteBtn = e.target.closest('.delete-transaction-btn');
            if(deleteBtn) {
                 const txId = parseInt(deleteBtn.dataset.id);
                 const tx = allTransactions.find(t => t.id === txId);
                 if (tx && tx.createdBy === currentManager.id) {
                     showConfirmModal('Excluir Transação', 'Tem certeza que deseja excluir esta transação?', () => {
                        if (tx.description.startsWith('Pagamento IPTU')) {
                            const item = allItems.find(i => i.id === tx.itemId);
                            const yearMatch = tx.description.match(/IPTU (\d{4})/);
                            if (item && yearMatch) {
                                const year = parseInt(yearMatch[1], 10);
                                if (item.iptu && item.iptu[year] && item.iptu[year].paidInstallments > 0) {
                                    item.iptu[year].paidInstallments -= 1;
                                }
                            }
                        }
                         allTransactions = allTransactions.filter(t => t.id !== txId);
                         saveData();
                         renderAll();
                     });
                 }
            }
        });

        const populateTransactionItemSelect = (selectedId) => {
            const select = document.getElementById('transactionItemLink');
            select.innerHTML = '';
            managedItems.forEach(item => {
                const displayName = (item.category === 'Imóvel' && item.endereco) ? item.endereco : item.name;
                select.innerHTML += `<option value="${item.id}">${displayName}</option>`;
            });
            if (selectedId) select.value = selectedId;
        };

        const openTransactionModal = (type, itemToPreselect = null, iptuDetails = null) => {
            document.getElementById('addTransactionForm').reset();
            document.getElementById('transactionType').value = type;
            document.getElementById('transactionModalTitle').textContent = type === 'revenue' ? 'Adicionar Receita' : 'Adicionar Despesa';
            populateTransactionItemSelect(itemToPreselect ? itemToPreselect.id : null);
            document.getElementById('isDirectIptuPayment').value = 'false';

            if (iptuDetails && iptuDetails.isIptu) {
                 document.getElementById('transactionModalTitle').textContent = 'Registrar Pagamento IPTU';
                 document.getElementById('transactionDescription').value = `Pagamento IPTU ${iptuDetails.currentYear} (${iptuDetails.iptuData.paidInstallments + 1}/${iptuDetails.iptuData.installments}) - ${itemToPreselect.name}`;
                 document.getElementById('transactionAmount').value = iptuDetails.installmentValue.toFixed(2);
                 document.getElementById('isDirectIptuPayment').value = 'true';
            } else if (itemToPreselect && type === 'revenue') {
                document.getElementById('transactionDescription').value = `Recebimento aluguel: ${itemToPreselect.name}`;
                document.getElementById('transactionAmount').value = itemToPreselect.rentValue;
            }

            document.getElementById('transactionDate').value = getTodayDateString();
            showModal('addTransactionModal');
        };

        // Handlers de formulários
        document.getElementById('rentItemForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const itemId = parseInt(document.getElementById('rentItemId').value);
            const item = allItems.find(i => i.id === itemId);
            if(item){
                item.rentedTo = document.getElementById('tenantName').value;
                item.rentStartDate = document.getElementById('rentStartDate').value;
                item.rentEndDate = document.getElementById('rentEndDate').value;
                item.rentValue = parseFloat(document.getElementById('rentValue').value);
                item.paymentDay = parseInt(document.getElementById('paymentDay').value);
                item.paymentsMade = [];
                item.debt = {amount: 0, cycles: 0};
                saveData();
                renderAll();
                hideModal('rentItemModal');
            }
        });
        
        document.getElementById('addTransactionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const type = document.getElementById('transactionType').value;
            const itemId = parseInt(document.getElementById('transactionItemLink').value);
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const item = allItems.find(i => i.id === itemId);

            const isDirectPayment = document.getElementById('isDirectIptuPayment').value === 'true';

            const newTransaction = {
                id: Date.now(),
                type: type,
                description: document.getElementById('transactionDescription').value,
                amount: amount,
                date: document.getElementById('transactionDate').value,
                itemId: itemId,
                createdBy: currentManager.id // Adiciona o ID do gestor
            };
            
            if (isDirectPayment) {
                 newTransaction.excludeFromDashboard = true;
                 const yearMatch = newTransaction.description.match(/IPTU (\d{4})/);
                 if (item && yearMatch) {
                     const year = parseInt(yearMatch[1], 10);
                     if (item.iptu && item.iptu[year] && item.iptu[year].paidInstallments < item.iptu[year].installments) {
                          item.iptu[year].paidInstallments += 1;
                     }
                 }
            }

            allTransactions.push(newTransaction);
            
            if (type === 'revenue' && item && item.hasManagementFee) {
                const feePercentage = item.managementFeePercentage || 10;
                const feeAmount = amount * (feePercentage / 100);
                const feeTransaction = {
                    id: Date.now() + 1,
                    type: 'management_fee',
                    description: `Taxa Gerência - ${item.name}`,
                    amount: feeAmount,
                    date: newTransaction.date,
                    itemId: itemId,
                    createdBy: currentManager.id
                };
                allTransactions.push(feeTransaction);
            }
            
            saveData();
            renderAll();
            hideModal('addTransactionModal');
        });
        
        document.getElementById('editTransactionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const txId = parseInt(document.getElementById('editTransactionId').value);
            const tx = allTransactions.find(t => t.id === txId);
            if(tx && tx.createdBy === currentManager.id){ // Dupla verificação
                tx.description = document.getElementById('editTransactionDescription').value;
                tx.amount = parseFloat(document.getElementById('editTransactionAmount').value);
                tx.date = document.getElementById('editTransactionDate').value;
                saveData();
                renderAll();
                hideModal('editTransactionModal');
            }
        });
        
        iptuForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const itemId = parseInt(document.getElementById('iptuItemId').value);
            const installmentValue = parseFloat(document.getElementById('iptuInstallmentValue').value);
            const installments = parseInt(document.getElementById('iptuInstallments').value);
            const item = allItems.find(i => i.id === itemId);
            const totalValue = installmentValue * installments;

            if (item && !isNaN(installmentValue) && installmentValue > 0 && installments > 0) {
                const currentYear = new Date().getFullYear();
                if (!item.iptu) item.iptu = {};
                item.iptu[currentYear] = {
                    totalValue: totalValue,
                    installments: installments,
                    paidInstallments: 0
                };
                saveData();
                renderAll();
                hideModal('iptuModal');
            } else {
                 alert("Por favor, insira um valor de parcela válido e selecione o número de parcelas.");
            }
        });

        manageIptuForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const itemId = parseInt(document.getElementById('manageIptuItemId').value);
            const year = parseInt(document.getElementById('manageIptuYear').value);
            const newInstallmentValue = parseFloat(document.getElementById('manageIptuInstallmentValue').value);
            const newInstallments = parseInt(document.getElementById('manageIptuInstallments').value);
            const item = allItems.find(i => i.id === itemId);
            const newTotalValue = newInstallmentValue * newInstallments;

            if (item && item.iptu && item.iptu[year] && !isNaN(newInstallmentValue) && newInstallmentValue >= 0 && newInstallments > 0) {
                const iptuData = item.iptu[year];
                iptuData.totalValue = newTotalValue;

                if (iptuData.installments !== newInstallments) {
                     iptuData.paidInstallments = 0;
                     console.warn("Número de parcelas alterado. Pagamentos foram resetados para 0.");
                }
                 iptuData.installments = newInstallments;

                saveData();
                renderAll();
                hideModal('manageIptuModal');
            } else {
                 alert("Erro ao salvar. Verifique os valores.");
            }
        });
        
        document.getElementById('deleteIptuBtn').addEventListener('click', () => {
            const itemId = parseInt(document.getElementById('manageIptuItemId').value);
            const year = parseInt(document.getElementById('manageIptuYear').value);
            const item = allItems.find(i => i.id === itemId);

            if (item && item.iptu && item.iptu[year]) {
                showConfirmModal(
                    `Apagar IPTU ${year}`,
                    `Tem certeza que deseja apagar o registro do IPTU de ${year}? Isso removerá as transações de pagamento associadas.`,
                    () => {
                        allTransactions = allTransactions.filter(t => 
                            !(t.itemId === itemId && t.type === 'expense' && t.description.includes(`Pagamento IPTU ${year}`))
                        );
                        delete item.iptu[year];
                        saveData();
                        renderAll();
                        hideModal('manageIptuModal');
                    }
                );
            }
        });


        document.getElementById('confirmActionConfirm').addEventListener('click', () => {
            if (typeof onConfirm === 'function') onConfirm();
            hideModal('confirmActionModal');
            onConfirm = null;
        });
        document.getElementById('confirmActionCancel').addEventListener('click', () => {
            hideModal('confirmActionModal');
            onConfirm = null;
        });

        // Carga inicial
        renderAll();
    });
    </script>
</body>
</html>

